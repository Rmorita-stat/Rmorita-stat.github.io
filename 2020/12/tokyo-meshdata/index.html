<!DOCTYPE html>
<html>
<head>
    <meta name="google-site-verification" content="qrt5G5NouQQVS-0Ss9qHlEuMYt3uKuifbUIOkPd4cPc" />
    <meta charset="utf-8">
    <title>
        
        SUCRE HECACHA
        
    </title>
    <meta name="viewport" id="viewport" content="width=device-width, initial-scale=1">
    <link rel='icon' type='image/x-icon' href="https://sucre-stat.com/images/favicon.png" />
    <link rel="apple-touch-icon" href="https://sucre-stat.com/images/favicon.png"><link rel="stylesheet" href="https://sucre-stat.com/scss/style.css">
    
    <link rel="stylesheet" href="https://sucre-stat.com/css/syntax.css">
    <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
    <script src="https://sucre-stat.com/js/highlight.min.js"></script>
    <link rel="stylesheet" href="https://sucre-stat.com/scss/highlight.css">
    
    <link rel="stylesheet" href="https://sucre-stat.com/scss/custom.css">
    
    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'Your Google Analytics tracking id', 'auto');
        ga('send', 'pageview');
    </script>
    
    
    <meta name="generator" content="Hugo 0.71.0" /><link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet">
</head>


<body>
<div class="header">
    <div class="site-logo__wrap">
        <div id="site-button">
            <div></div>
        </div>
        
        <div class=' site-logo '>
            <a href="https://sucre-stat.com/"><img src="https://sucre-stat.com/images/logo.png" /></a>
        </div>
    </div>
    
<div class=' site-nav u-font ' id="nav-bar">
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="https://sucre-stat.com/stat" >STAT</a>
    </div>
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="https://sucre-stat.com/r" >With R</a>
    </div>
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="https://sucre-stat.com/julia" >With Julia</a>
    </div>
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="https://sucre-stat.com/about" >ABOUT</a>
    </div>
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="https://sucre-stat.com/tags/" >TAGS</a>
    </div>
    
<div class="site-nav__wrap">
<a class="site-nav__el current-page" href="https://sucre-stat.com/search/" ><i class="fas fa-search my_small"></i>SEARCH</a>
</div>
<div class="site-nav__wrap">
<a class="site-nav__el current-page" href="https://sucre-stat.com/contact/" >CONTACT</a>
</div>

</div>
<div class="main">

<div class="main-content">
    <div class="main-content__date">
        <h4 id="date"> 2020.12.24 00:00 </h4>
    </div>
    <div class="main-content__title">
        <h1 id="title">Soft K-means法とガウス過程</h1>
    </div>
    <div class="main-content__article">
        <article id="content">
            <h1 id="はじめに">はじめに</h1>
<p>今回は分類についての記事です。
正規分布の混合モデルをによるsoft K-Means法を扱います。
タイトルにガウス過程とありますが、今回使用するデータが空間データなので、ガウス過程を用いて空間の近接性を考慮したクラスタリングにも挑戦しました、結果、うまくいかなかったのですが…</p>
<p>本記事の構成は以下の通りです。</p>
<!-- raw HTML omitted -->
<ul>
<li><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">はじめに</a></li>
<li><a href="#%E7%90%86%E8%AB%96">理論</a>
<ul>
<li><a href="#hard-k-means%E6%B3%95">Hard K-means法</a></li>
<li><a href="#soft-k-means%E6%B3%95">Soft K-means法</a></li>
</ul>
</li>
<li><a href="#%E5%AE%9F%E8%B7%B5">実践</a>
<ul>
<li><a href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%BA%96%E5%82%99">サンプルデータの準備</a></li>
<li><a href="#%E5%AE%9F%E8%A3%85">実装</a></li>
<li><a href="#%E7%B5%90%E6%9E%9C">結果</a></li>
</ul>
</li>
<li><a href="#%E3%82%AC%E3%82%A6%E3%82%B9%E9%81%8E%E7%A8%8B%E3%82%92%E3%81%82%E3%81%A6%E3%81%AF%E3%82%81%E3%81%A6%E3%81%BF%E3%82%8B">ガウス過程をあてはめてみる</a></li>
</ul>
<!-- raw HTML omitted -->
<h1 id="理論">理論</h1>
<h2 id="hard-k-means法">Hard K-means法</h2>
<p>K-means法はデータをK個のクラスに分類する手法で、典型的には幾何学的・解析的に解が求まるHard K-means法が扱われます。
標本$\boldsymbol{y}_ 1,\ldots,\boldsymbol{y}_ N$を$K$個のクラスターに分類したいとします。ここで$\boldsymbol{y}_n = (y_{1n},\ldots, y_{Dn})$、変数の数は$D$です。</p>
<p>Hard K-means法では$\boldsymbol{y}_ n $を任意のクラスター$\boldsymbol{Z} = (Z_1,\ldots,Z_N )$, $Z_n ∈ \left(1,\ldots,K\right)$に割り当て、各クラスター平均$\boldsymbol{\mu}_{1},\ldots,\boldsymbol{\mu} _K$、$\boldsymbol{\mu} _k = ( \mu_{1k}, \ldots, \mu_{Dk})$を計算し、各標本との距離の合計$\sum_{n=1}^{N}\sum_{d=1}^{D}\left(y_{dn} - \mu_{dZ_{[n]}}\right)^2$が最小になるような割り当て方法を模索します。結果は一意に定まります。</p>
<h2 id="soft-k-means法">Soft K-means法</h2>
<p>一方、Soft K-means法は$\boldsymbol{y}_n$が各クラスターに含まれる確率が結果として得られます。またユークリッド距離と多変量正規分布の関係から、モデルは多変量正規分布で表現されます。</p>
<p>各標本の割り当て先$Z_n$が以下のカテゴリカル分布に従うとします。</p>
<div style="overflow-x:auto;">
  
$$
Z_n \sim \mathrm{Categorical}\left(\boldsymbol{\theta}\right) \tag{1}
$$
$$
\boldsymbol{\theta} = \left(\theta_1, \ldots, \theta_K\right), ~~ \sum_{k=1}^{K}\theta_k = 1 \tag{2}
$$

</div>
<p>$\boldsymbol{\theta}$は各クラスターに含まれる標本の全体に占める割合とみなせます。</p>
<p>次に、1標本$\boldsymbol{y}_n$は、$Z_n$に割り当てられる場合、次の多変量正規分布に従うものとします。</p>
<div style="overflow-x:auto;">
  
$$
\boldsymbol{y}_n \sim \mathrm{MultiNormal}\left(\boldsymbol{\mu}_{Z_n}, \Sigma\right) \tag{3}
$$

</div>
<p>ここで各変数は互いに独立に生成されるものとすると、</p>
<p>$$
\Sigma = \mathrm{diag[\sigma_1, \ldots, \sigma_D]} \tag{4}
$$</p>
<p>となり、このとき$y_{1n},\ldots,y_{Dn}$がそれぞれ独立に平均$\mu_{Z_n}$、標準偏差$\sigma_d$の正規分布に従うことになります。</p>
<p>$\boldsymbol{y}_n$がクラスター$k$に分類されるとき$(Z_n = k)$の対数尤度は、</p>
<div style="overflow-x:auto;">
  
$$
p_{(Z_n = k)} = \theta_k\mathrm{MultiNormal}(\boldsymbol{y}_n | \boldsymbol{\mu}_{k}, \Sigma) \propto \theta_k \cfrac{1}{\sqrt{\det{\Sigma}}}\exp\left(-\cfrac{1}{2}(\boldsymbol{y}_n - \boldsymbol{\mu}_k)^T\Sigma^{-1}(\boldsymbol{y}_n - \boldsymbol{\mu}_k)\right) = \theta_k\cfrac{1}{\prod_{d=1}^{D}\sigma_d}\exp\left(\sum_{d=1}^{D}\cfrac{1}{2\sigma_d^2}(y_{dn} - \mu_{dk})^2\right) \tag{5}
$$

</div>
<p>となります。</p>
<p>$(5)$式にはクラスター平均と標本のユークリッド距離が含まれています。結局Soft K-means法も標本とクラスター中心の距離で結果が決まってくるのですね…$\sigma_d$もおそらく変数間の重みづけ程度の役割なんでしょう。</p>
<p>理論は簡潔にこのくらいで…</p>
<h1 id="実践">実践</h1>
<h2 id="サンプルデータの準備">サンプルデータの準備</h2>
<p>今日は<a href="https://www.meti.go.jp/statistics/tyo/syougyo/mesh/download.html#500m">経済産業省</a>から平成26年商業統計500mメッシュデータをダウンロードして利用します。データを集計し、事業所数あたり小売業の総売上と従業員あたり小売業の総売上についての東京都内20km四方1km単位メッシュデータを作成します。中で適宜てきとうに欠損値の置き換えや外れ値の置き換えをしています。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="c1"># 読み込みと集計 -----------------------------------------------------------------</span>

<span class="nf">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span>
<span class="n">d</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="s">&#34;data(big)/H26_03_500m都道府県.csv&#34;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">F</span><span class="p">)</span>
<span class="c1"># 東京都内の20km×20kmをfilter</span>
<span class="n">d</span> <span class="o">%&gt;%</span> <span class="nf">as.data.frame</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">mutate</span><span class="p">(</span><span class="n">mesh2</span> <span class="o">=</span> <span class="nf">paste</span><span class="p">(</span><span class="o">!!!</span><span class="n">rlang</span><span class="o">::</span><span class="nf">syms</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;V5&#34;</span><span class="p">,</span> <span class="s">&#34;V6&#34;</span><span class="p">)),</span> <span class="n">sep</span><span class="o">=</span><span class="s">&#34;&#34;</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="c1"># 2次メッシュコードを作成</span>
  <span class="nf">filter</span><span class="p">(</span><span class="n">mesh2</span> <span class="o">==</span> <span class="m">533955</span> <span class="o">|</span> <span class="n">mesh2</span> <span class="o">==</span> <span class="m">533956</span> <span class="o">|</span> <span class="n">mesh2</span> <span class="o">==</span> <span class="m">533945</span> <span class="o">|</span> <span class="n">mesh2</span> <span class="o">==</span> <span class="m">533946</span> <span class="p">)</span> <span class="o">%&gt;%</span> <span class="c1"># 2次メッシュコードでフィルター</span>
  <span class="nf">select</span><span class="p">(</span><span class="n">mesh2</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">V7</span><span class="p">,</span> <span class="n">Office</span> <span class="o">=</span> <span class="n">V22</span><span class="p">,</span> <span class="n">Employees</span> <span class="o">=</span> <span class="n">V23</span><span class="p">,</span> <span class="n">Sales</span> <span class="o">=</span> <span class="n">V24</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="c1"># 必要な列のみ抽出</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">rowID</span> <span class="o">=</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="nf">case_when</span><span class="p">(</span><span class="nf">str_sub</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">-2</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">~</span> <span class="s">&#34;0&#34;</span><span class="p">,</span><span class="kc">TRUE</span> <span class="o">~</span> <span class="nf">str_sub</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="m">-2</span><span class="p">))))</span> <span class="o">%&gt;%</span> <span class="c1"># 2次メッシュ内でのの行番号を作成</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">colID</span> <span class="o">=</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="nf">str_sub</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="m">-1</span><span class="p">)))</span> <span class="o">%&gt;%</span>  <span class="c1"># 2次メッシュ内での列番号を作成</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">rowID</span> <span class="o">=</span> <span class="nf">if_else</span><span class="p">(</span><span class="n">mesh2</span> <span class="o">==</span> <span class="m">533955</span> <span class="o">|</span> <span class="n">mesh2</span> <span class="o">==</span> <span class="m">533956</span><span class="p">,</span> <span class="n">rowID</span> <span class="o">+</span> <span class="m">10</span><span class="p">,</span> <span class="n">rowID</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="c1"># 全体における行番号を作成</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">colID</span> <span class="o">=</span> <span class="nf">if_else</span><span class="p">(</span><span class="n">mesh2</span> <span class="o">==</span><span class="m">533956</span> <span class="o">|</span> <span class="n">mesh2</span> <span class="o">==</span> <span class="m">533946</span><span class="p">,</span> <span class="n">colID</span> <span class="o">+</span> <span class="m">10</span><span class="p">,</span> <span class="n">colID</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="c1"># 全体における列番号を作成</span>
  <span class="nf">na_if</span><span class="p">(</span><span class="s">&#34;X&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">mutate_if</span><span class="p">(</span><span class="n">is.character</span><span class="p">,</span> <span class="n">as.numeric</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="c1"># 欠損値XをNAに置き換える+全部double型に変換</span>
  <span class="nf">group_by</span><span class="p">(</span><span class="n">mesh2</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">mutate_at</span><span class="p">(</span><span class="nf">vars</span><span class="p">(</span><span class="n">Office</span><span class="p">,</span> <span class="n">Employees</span><span class="p">,</span> <span class="n">Sales</span><span class="p">),</span> <span class="nf">list</span><span class="p">(</span> <span class="o">~</span><span class="nf">replace_na</span><span class="p">(</span><span class="nf">.,mean</span><span class="p">(</span><span class="n">.,na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">))))</span> <span class="o">%&gt;%</span> <span class="c1"># 3次メッシュでグループ化・NAをグループごとの平均値で置換</span>
  <span class="nf">ungroup</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">select</span><span class="p">(</span><span class="n">rowID</span><span class="p">,</span> <span class="n">colID</span><span class="p">,</span> <span class="n">Sales</span><span class="p">,</span> <span class="n">Employees</span><span class="p">,</span> <span class="n">Office</span> <span class="p">)</span> <span class="o">%&gt;%</span> <span class="c1"># 必要な列だけ取り出す</span>
  <span class="nf">group_by</span><span class="p">(</span><span class="n">rowID</span><span class="p">,</span> <span class="n">colID</span><span class="p">,)</span> <span class="o">%&gt;%</span> <span class="nf">summarise_all</span><span class="p">(</span><span class="nf">funs</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">.)</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="c1"># 3次メッシュで和をとる</span>
  <span class="nf">ungroup</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">mutate</span><span class="p">(</span><span class="n">SE</span> <span class="o">=</span> <span class="n">Sales</span> <span class="o">/</span> <span class="n">Employees</span><span class="p">,</span> <span class="n">SO</span> <span class="o">=</span> <span class="n">Sales</span> <span class="o">/</span> <span class="n">Office</span><span class="p">)</span> <span class="o">%&gt;%</span>  <span class="c1"># Sales/EmployeesとSales/Officeを計算</span>
  <span class="nf">mutate_at</span><span class="p">(</span><span class="nf">vars</span><span class="p">(</span><span class="n">SE</span><span class="p">,</span> <span class="n">SO</span><span class="p">),</span> <span class="o">~</span><span class="nf">replace_na</span><span class="p">(</span><span class="nf">.,mean</span><span class="p">(</span><span class="n">.,na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)))</span> <span class="o">%&gt;%</span> <span class="nf">arrange</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="n">SE</span><span class="p">))</span>  <span class="o">-&gt;</span> <span class="n">d</span>

<span class="n">d[1</span><span class="p">,</span><span class="m">6</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="n">d[2</span><span class="p">,</span><span class="m">6</span><span class="n">]</span> <span class="c1"># 外れ値を置き換え ridyverseでのうまいやり方がわからぬ</span>

<span class="n">d</span> <span class="o">%&gt;%</span> <span class="nf">arrange</span><span class="p">(</span><span class="nf">desc</span><span class="p">(</span><span class="n">SO</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">d</span>

<span class="n">d[1</span><span class="o">:</span><span class="m">3</span><span class="p">,</span><span class="m">7</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="n">d[4</span><span class="p">,</span><span class="m">7</span><span class="n">]</span> <span class="c1"># さらに外れ値を置き換え</span>

<span class="n">d</span> <span class="o">%&gt;%</span> <span class="nf">select</span><span class="p">(</span><span class="n">rowID</span><span class="p">,</span> <span class="n">colID</span><span class="p">,</span> <span class="n">SE</span><span class="p">,</span> <span class="n">SO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">d</span>

<span class="c1"># 描画 ----------------------------------------------------------------------</span>

<span class="n">p</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">colID</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">rowID</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">SO</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">SO</span><span class="p">))</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="o">=</span><span class="m">9</span><span class="p">)</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s">&#34;none&#34;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">panel.background</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">())</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">legend.title</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">())</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">())</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">geom_tile</span><span class="p">()</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">scale_fill_gradient2</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="s">&#34;white&#34;</span><span class="p">,</span><span class="n">mid</span><span class="o">=</span><span class="s">&#34;#A6CEE3&#34;</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="s">&#34;#1F78B4&#34;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">labs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#34;Sales/Office&#34;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">scale_x_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">19</span><span class="p">))</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">scale_y_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">19</span><span class="p">))</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">xlab</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">ylab</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">geom_text</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="nf">round</span><span class="p">(</span><span class="n">SO</span><span class="p">,</span><span class="m">2</span><span class="p">)),</span> <span class="n">col</span><span class="o">=</span><span class="s">&#34;grey8&#34;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">2.3</span><span class="p">)</span>

<span class="n">p2</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">colID</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">rowID</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">SE</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">SE</span><span class="p">))</span>
<span class="n">p2</span> <span class="o">&lt;-</span> <span class="n">p2</span> <span class="o">+</span> <span class="nf">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="o">=</span><span class="m">9</span><span class="p">)</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s">&#34;none&#34;</span><span class="p">)</span>
<span class="n">p2</span> <span class="o">&lt;-</span> <span class="n">p2</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">panel.background</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">())</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">legend.title</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">())</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">())</span>
<span class="n">p2</span> <span class="o">&lt;-</span> <span class="n">p2</span> <span class="o">+</span> <span class="nf">geom_tile</span><span class="p">()</span>
<span class="n">p2</span> <span class="o">&lt;-</span> <span class="n">p2</span> <span class="o">+</span> <span class="nf">scale_fill_gradient2</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="s">&#34;white&#34;</span><span class="p">,</span><span class="n">mid</span><span class="o">=</span><span class="s">&#34;#A6CEE3&#34;</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="s">&#34;#1F78B4&#34;</span><span class="p">)</span>
<span class="n">p2</span> <span class="o">&lt;-</span> <span class="n">p2</span> <span class="o">+</span> <span class="nf">labs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#34;Sales/Office&#34;</span><span class="p">)</span>
<span class="n">p2</span> <span class="o">&lt;-</span> <span class="n">p2</span> <span class="o">+</span> <span class="nf">scale_x_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">19</span><span class="p">))</span>
<span class="n">p2</span> <span class="o">&lt;-</span> <span class="n">p2</span> <span class="o">+</span> <span class="nf">scale_y_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">19</span><span class="p">))</span>
<span class="n">p2</span> <span class="o">&lt;-</span> <span class="n">p2</span> <span class="o">+</span> <span class="nf">xlab</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">ylab</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
<span class="n">p2</span> <span class="o">&lt;-</span> <span class="n">p2</span> <span class="o">+</span> <span class="nf">geom_text</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="nf">round</span><span class="p">(</span><span class="n">SE</span><span class="p">,</span><span class="m">2</span><span class="p">)),</span> <span class="n">col</span><span class="o">=</span><span class="s">&#34;grey8&#34;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="m">2.3</span><span class="p">)</span>

<span class="nf">library</span><span class="p">(</span><span class="n">gridExtra</span><span class="p">)</span>

<span class="n">p_extra</span> <span class="o">&lt;-</span> <span class="n">gridExtra</span><span class="o">::</span><span class="nf">grid.arrange</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
</code></pre></div><figure>
    <img src="https://sucre-stat.com/r/tokyo-meshdata/distribution.png" width="600"/> 
</figure>

<p>このデータに対してソフトクラスタリングを実行し、事業所ごと・従業員毎の生産性が高い（High Efficiency）地域と低い（Low Efficiency）にメッシュを二分することを目的にします。</p>
<h2 id="実装">実装</h2>
<p>実装は基本的に理論編での数式に倣いますが、標準偏差$\sigma_1,\ldots,\sigma_D$はすべて1とします（個人的に$\sigma_k$を軽視しているのと、$\sigma_k$をパラメータにすると収束しなかったため）。</p>
<p>Stanコードは以下です。</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="c1">//model.stan
</span><span class="c1"></span><span class="n">data</span><span class="p">{</span>
  <span class="kt">int</span> <span class="n">D</span><span class="p">;</span> <span class="c1">//入力数
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">N</span><span class="p">;</span> <span class="c1">//サンプル数
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">K</span><span class="p">;</span> <span class="c1">//クラス数
</span><span class="c1"></span>  <span class="n">vector</span><span class="p">[</span><span class="n">D</span><span class="p">]</span> <span class="n">Z</span><span class="p">[</span><span class="n">N</span><span class="p">];</span> <span class="c1">//外で標準化済み
</span><span class="c1"></span><span class="p">}</span>

<span class="n">parameters</span><span class="p">{</span>
  <span class="n">simplex</span><span class="p">[</span><span class="n">K</span><span class="p">]</span> <span class="n">theta</span><span class="p">;</span> <span class="c1">//各クラスターへ割り振られる確率
</span><span class="c1"></span>  <span class="n">ordered</span><span class="p">[</span><span class="n">K</span><span class="p">]</span> <span class="n">Z_mu</span><span class="p">[</span><span class="n">D</span><span class="p">];</span> <span class="c1">//クラスター平均
</span><span class="c1"></span><span class="p">}</span>

<span class="n">transformed</span> <span class="n">parameters</span><span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">upper</span><span class="o">=</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">[</span><span class="n">K</span><span class="p">]</span> <span class="n">soft_z</span><span class="p">[</span><span class="n">N</span><span class="p">];</span> <span class="c1">//クラスター毎の対数尤度
</span><span class="c1"></span>  <span class="n">matrix</span><span class="p">[</span><span class="n">K</span><span class="p">,</span><span class="n">N</span><span class="p">]</span> <span class="n">dotself</span> <span class="o">=</span> <span class="n">rep_matrix</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">N</span><span class="p">);</span>

  <span class="k">for</span><span class="p">(</span><span class="n">k</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">K</span><span class="p">){</span>
    <span class="k">for</span><span class="p">(</span><span class="n">n</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">N</span><span class="p">){</span>
      <span class="k">for</span><span class="p">(</span><span class="n">d</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">D</span><span class="p">){</span>
        <span class="n">dotself</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">Z_mu</span><span class="p">[</span><span class="n">d</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">Z</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="n">d</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">//クラスター毎の対数尤度の計算
</span><span class="c1"></span>  <span class="k">for</span><span class="p">(</span><span class="n">n</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">N</span><span class="p">){</span>
    <span class="k">for</span><span class="p">(</span><span class="n">k</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">K</span><span class="p">){</span>
      <span class="n">soft_z</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dotself</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">model</span><span class="p">{</span>
  <span class="c1">//likelihood
</span><span class="c1"></span>  <span class="k">for</span><span class="p">(</span><span class="n">n</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">N</span><span class="p">){</span>
    <span class="n">target</span> <span class="o">+=</span> <span class="n">log_sum_exp</span><span class="p">(</span><span class="n">soft_z</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">generated</span> <span class="n">quantities</span><span class="p">{</span>
  <span class="n">vector</span><span class="p">[</span><span class="n">K</span><span class="p">]</span> <span class="n">p</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>

  <span class="k">for</span><span class="p">(</span><span class="n">n</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">N</span><span class="p">){</span>
    <span class="n">p</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">soft_z</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div><p>一つ目のポイントは<code>ordered Z_mu[D]</code>でしょうか。ラベルスイッチングと呼ばれる、クラスターを識別できない問題を解消しています。これがないと全く収束しません。</p>
<p>二つ目のポイントは<code>vector&lt;upper=0&gt;[K] soft_z[N]</code>と<code>target += log_sum_exp(soft_z[n])</code>ですね。$N$個の$K$ベクトル<code>soft_z</code>の要素には$(5)$式の対数尤度が格納されています。それを関数<code>log_sum_exp()</code>を使って混合モデルとして認識させ<code>target</code>に足していきます。詳しくは<a href="https://www.kyoritsu-pub.co.jp/bookdetail/9784320112421">アヒル本</a>203ページを参照のこと。</p>
<p>三つ目のポイントは<code>p[n] = softmax(soft_z[n])</code>です。ソフトマックス関数について思い出して下さい。</p>
<div style="overflow-x:auto;">
  
$$
\mathrm{softmax}(\boldsymbol{x}_ n) = \left(\cfrac{\exp(x_{1n})}{\sum_{k=1}^K \exp(x_{kn})}\cdots\cfrac{\exp(x_{Kn})}{\sum_{k=1}^K \exp(x_{kn})} \right) \tag{6}
$$

</div>
<p>対数尤度が格納された<code>soft_z</code>を$\exp()$で再び尤度に戻しています。尤度比がそのまま各クラスターに分類される確率と解釈できる訳です。</p>
<h2 id="結果">結果</h2>
<p>以下でMCMCを走らせ、$\hat{R}$で収束を確認します。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">library</span><span class="p">(</span><span class="n">rstan</span><span class="p">)</span>

<span class="n">D</span> <span class="o">&lt;-</span> <span class="m">2</span>
<span class="n">N</span> <span class="o">&lt;-</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="n">loc</span> <span class="o">&lt;-</span> <span class="n">d[</span><span class="p">,</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">)</span><span class="n">]</span>
<span class="n">Z</span> <span class="o">&lt;-</span> <span class="nf">scale</span><span class="p">(</span><span class="n">d[</span><span class="p">,</span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">4</span><span class="p">)</span><span class="n">]</span><span class="p">)</span>
<span class="n">K</span> <span class="o">&lt;-</span> <span class="m">2</span>
<span class="nf">rstan_options</span><span class="p">(</span><span class="n">auto_write</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<span class="nf">options</span><span class="p">(</span><span class="n">mc.cores</span> <span class="o">=</span> <span class="n">parallel</span><span class="o">::</span><span class="nf">detectCores</span><span class="p">())</span>
<span class="n">data</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span><span class="n">D</span><span class="o">=</span><span class="n">D</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">Z</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>
<span class="n">stanmodel</span> <span class="o">&lt;-</span> <span class="nf">stan_model</span><span class="p">(</span><span class="s">&#34;model.stan&#34;</span><span class="p">)</span>
<span class="n">fit</span> <span class="o">&lt;-</span> <span class="nf">sampling</span><span class="p">(</span><span class="n">stanmodel</span><span class="p">,</span> <span class="n">pars</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;Z_mu&#34;</span><span class="p">,</span><span class="s">&#34;theta&#34;</span><span class="p">,</span><span class="s">&#34;p&#34;</span><span class="p">),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">iter</span><span class="o">=</span><span class="m">1300</span><span class="p">,</span> <span class="n">warmup</span><span class="o">=</span><span class="m">300</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="m">123</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="m">4</span><span class="p">)</span>
<span class="n">fit</span>

<span class="c1">## Inference for Stan model: model.</span>
<span class="c1">## 4 chains, each with iter=1300; warmup=300; thin=1;</span>
<span class="c1">## post-warmup draws per chain=1000, total post-warmup draws=4000.</span>
<span class="c1">##</span>
<span class="c1">##              mean se_mean   sd    2.5%     25%     50%     75%   97.5% n_eff Rhat</span>
<span class="c1">## Z_mu[1,1]   -0.18    0.00 0.05   -0.28   -0.22   -0.18   -0.15   -0.08  4664    1</span>
<span class="c1">## Z_mu[1,2]    2.98    0.00 0.27    2.47    2.79    2.98    3.16    3.54  3989    1</span>
<span class="c1">## Z_mu[2,1]   -0.19    0.00 0.06   -0.30   -0.23   -0.19   -0.15   -0.09  4715    1</span>
<span class="c1">## Z_mu[2,2]    3.19    0.00 0.27    2.68    3.01    3.18    3.36    3.73  4215    1</span>
<span class="c1">## theta[1]     0.94    0.00 0.01    0.91    0.93    0.94    0.95    0.97  3832    1</span>
<span class="c1">## theta[2]     0.06    0.00 0.01    0.03    0.05    0.06    0.07    0.09  3832    1</span>
<span class="c1">## p[1,1]       0.00    0.00 0.00    0.00    0.00    0.00    0.00    0.00  3445    1</span>
<span class="c1">## p[1,2]       1.00    0.00 0.00    1.00    1.00    1.00    1.00    1.00  3445    1</span>
<span class="c1">## p[2,2]       1.00    0.00 0.00    1.00    1.00    1.00    1.00    1.00  3633    1</span>
<span class="c1">## p[2,1]       0.00    0.00 0.00    0.00    0.00    0.00    0.00    0.00  3633    1</span>
～以下省略～
</code></pre></div><p>結果はざっとこんな感じです。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="c1"># 分類結果を描画するRスクリプト ---------------------------------------------------------</span>

<span class="n">fit</span> <span class="o">%&gt;%</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">extract</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">as.data.frame</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">select</span><span class="p">(</span><span class="nf">starts_with</span><span class="p">(</span><span class="s">&#34;p&#34;</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="nf">select</span><span class="p">(</span><span class="nf">ends_with</span><span class="p">(</span><span class="s">&#34;2&#34;</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="c1"># 2で終わるpがhighである確率に対応。MCMCサンプルから抽出</span>
  <span class="nf">pivot_longer</span><span class="p">(</span><span class="nf">everything</span><span class="p">(),</span> <span class="n">names_to</span> <span class="o">=</span> <span class="s">&#34;key&#34;</span><span class="p">,</span> <span class="n">values_to</span> <span class="o">=</span> <span class="s">&#34;val&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="c1"># 縦持ち型に変換</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="nf">str_sub</span><span class="p">(</span><span class="nf">str_sub</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="m">3</span><span class="p">),</span><span class="n">end</span><span class="o">=</span><span class="m">-3</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="kc">NULL</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="c1"># keyから位置のID(loc)を抽出</span>
  <span class="nf">group_by</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">summarise</span><span class="p">(</span><span class="n">median</span><span class="o">=</span><span class="nf">median</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">lower</span><span class="o">=</span><span class="nf">quantile</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="m">0.25</span><span class="p">),</span> <span class="n">upper</span><span class="o">=</span><span class="nf">quantile</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="m">0.75</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">Class</span> <span class="o">=</span> <span class="nf">as.factor</span><span class="p">(</span><span class="nf">round</span><span class="p">(</span><span class="n">median</span><span class="p">)))</span> <span class="o">%&gt;%</span> <span class="nf">merge</span><span class="p">(</span><span class="nf">cbind</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="nf">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="nf">nrow</span><span class="p">(</span><span class="n">d</span><span class="p">)),</span><span class="n">d</span><span class="p">),</span> <span class="n">by</span><span class="o">=</span><span class="s">&#34;loc&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="n">loc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">res_data</span>

<span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
<span class="n">color1</span> <span class="o">&lt;-</span> <span class="nf">colorRampPalette</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;#A6CEE3&#34;</span><span class="p">,</span><span class="s">&#34;#1F78B4&#34;</span><span class="p">))</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">()</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="o">=</span><span class="m">11</span><span class="p">)</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">panel.background</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">())</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">legend.title</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">())</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">())</span><span class="o">+</span>
  <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s">&#34;bottom&#34;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">scale_y_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">19</span><span class="p">))</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">geom_tile</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">res_data</span><span class="p">),</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">colID</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">rowID</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">Class</span><span class="p">))</span><span class="o">+</span>
  <span class="nf">scale_fill_hue</span><span class="p">(</span><span class="n">palette</span><span class="o">=</span><span class="n">color1</span><span class="p">,</span> <span class="n">breaks</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;0&#34;</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">),</span><span class="n">labels</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;Low Efficiency&#34;</span><span class="p">,</span> <span class="s">&#34;High Efficiency&#34;</span><span class="p">))</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">geom_text</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">res_data</span><span class="p">),</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">colID</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">rowID</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nf">sprintf</span><span class="p">(</span><span class="s">&#34;%0.2f&#34;</span><span class="p">,</span> <span class="n">median</span><span class="p">)),</span> <span class="n">colour</span> <span class="o">=</span> <span class="s">&#34;grey8&#34;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">xlab</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">ylab</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">scale_x_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">19</span><span class="p">))</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="n">p</span> <span class="o">+</span> <span class="nf">labs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#34;Estimated Status&#34;</span><span class="p">)</span>
</code></pre></div><figure>
    <img src="https://sucre-stat.com/r/tokyo-meshdata/Result-model.png" width="600"/> 
</figure>

<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="c1"># パラメータや生成量の事後分布を描画 -------------------------------------------------------</span>

<span class="nf">library</span><span class="p">(</span><span class="n">bayesplot</span><span class="p">)</span>
<span class="n">plot_title</span> <span class="o">&lt;-</span> <span class="nf">ggtitle</span><span class="p">(</span><span class="s">&#34;Posterior distributions&#34;</span><span class="p">,</span>
                      <span class="s">&#34;with medians and 80% intervals&#34;</span><span class="p">)</span>
<span class="n">posterior</span> <span class="o">&lt;-</span> <span class="nf">as.matrix</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span><span class="nf">[which</span><span class="p">(</span><span class="nf">colnames</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span><span class="o">==</span><span class="s">&#34;Z_mu[1,1]&#34;</span><span class="p">)</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="s">&#34;SO_Class1_normalize&#34;</span> <span class="c1"># Sales/Office</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span><span class="nf">[which</span><span class="p">(</span><span class="nf">colnames</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span><span class="o">==</span><span class="s">&#34;Z_mu[1,2]&#34;</span><span class="p">)</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="s">&#34;SO_Class2_normalize&#34;</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span><span class="nf">[which</span><span class="p">(</span><span class="nf">colnames</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span><span class="o">==</span><span class="s">&#34;Z_mu[2,1]&#34;</span><span class="p">)</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="s">&#34;SE_Class1_normalize&#34;</span> <span class="c1"># Sales/Employees</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span><span class="nf">[which</span><span class="p">(</span><span class="nf">colnames</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span><span class="o">==</span><span class="s">&#34;Z_mu[2,2]&#34;</span><span class="p">)</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="s">&#34;SE_Class2_normalize&#34;</span>

<span class="c1"># 標準化したSales/OfficeとSales/Employeesをもとに戻す</span>
<span class="n">posterior</span> <span class="o">%&gt;%</span> <span class="nf">as.data.frame</span><span class="p">()</span> <span class="o">%&gt;%</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">SO_Class1</span> <span class="o">=</span> <span class="n">SO_Class1_normalize</span> <span class="o">*</span> <span class="nf">attr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="s">&#39;scaled:scale&#39;</span><span class="p">)</span><span class="n">[1]</span> <span class="o">+</span> <span class="nf">attr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="s">&#39;scaled:center&#39;</span><span class="p">)</span><span class="n">[1]</span><span class="p">,</span>
         <span class="n">SO_Class2</span> <span class="o">=</span> <span class="n">SO_Class2_normalize</span> <span class="o">*</span> <span class="nf">attr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="s">&#39;scaled:center&#39;</span><span class="p">)</span><span class="n">[1]</span> <span class="o">+</span> <span class="nf">attr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="s">&#39;scaled:center&#39;</span><span class="p">)</span><span class="n">[1]</span><span class="p">,</span>
         <span class="n">SE_Class1</span> <span class="o">=</span> <span class="n">SE_Class1_normalize</span> <span class="o">*</span> <span class="nf">attr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="s">&#39;scaled:center&#39;</span><span class="p">)</span><span class="n">[2]</span> <span class="o">+</span> <span class="nf">attr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="s">&#39;scaled:center&#39;</span><span class="p">)</span><span class="n">[2]</span><span class="p">,</span>
         <span class="n">SE_Class2</span> <span class="o">=</span> <span class="n">SE_Class2_normalize</span> <span class="o">*</span> <span class="nf">attr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="s">&#39;scaled:center&#39;</span><span class="p">)</span><span class="n">[2]</span> <span class="o">+</span> <span class="nf">attr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="s">&#39;scaled:center&#39;</span><span class="p">)</span><span class="n">[2]</span><span class="p">,</span>
         <span class="n">SO_Class1_normalize</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span>
         <span class="n">SO_Class2_normalize</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span>
         <span class="n">SE_Class1_normalize</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span>
         <span class="n">SE_Class2_normalize</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span>
         <span class="n">sigma</span><span class="o">=</span><span class="kc">NULL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">posterior</span>

<span class="n">plot1</span> <span class="o">&lt;-</span> <span class="nf">mcmc_areas</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span>
          <span class="n">regex_pars</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;sigma&#34;</span><span class="p">,</span> <span class="s">&#34;theta&#34;</span><span class="p">),</span>
           <span class="n">prob</span> <span class="o">=</span> <span class="m">0.8</span><span class="p">)</span> <span class="o">+</span> <span class="n">plot_title</span>
<span class="n">plot2</span> <span class="o">&lt;-</span> <span class="nf">mcmc_areas</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span>
           <span class="n">pars</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;SO_Class1&#34;</span><span class="p">,</span><span class="s">&#34;SO_Class2&#34;</span><span class="p">),</span> <span class="n">prob</span><span class="o">=</span><span class="m">0.8</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">ggtitle</span><span class="p">(</span><span class="s">&#34;Posterior distributions(Sales/Office)&#34;</span><span class="p">,</span>
                      <span class="s">&#34;with medians and 80% intervals&#34;</span><span class="p">)</span>
<span class="n">plot3</span> <span class="o">&lt;-</span> <span class="nf">mcmc_areas</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span>
                    <span class="n">pars</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;SE_Class1&#34;</span><span class="p">,</span><span class="s">&#34;SE_Class2&#34;</span><span class="p">),</span> <span class="n">prob</span><span class="o">=</span><span class="m">0.8</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">ggtitle</span><span class="p">(</span><span class="s">&#34;Posterior distributions(Sales/Employees)&#34;</span><span class="p">,</span>
          <span class="s">&#34;with medians and 80% intervals&#34;</span><span class="p">)</span>

<span class="n">p_extra</span> <span class="o">&lt;-</span> <span class="n">gridExtra</span><span class="o">::</span><span class="nf">grid.arrange</span><span class="p">(</span><span class="n">plot1</span><span class="p">,</span><span class="n">plot2</span><span class="p">,</span><span class="n">plot3</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
</code></pre></div><figure>
    <img src="https://sucre-stat.com/r/tokyo-meshdata/mcmcareas-model.png" width="600"/> 
</figure>

<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="c1"># 推定した混合正規分布の確率密度を描画 ------------------------------------------------------</span>

<span class="n">posterior</span> <span class="o">&lt;-</span> <span class="nf">as.data.frame</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span><span class="nf">[which</span><span class="p">(</span><span class="nf">colnames</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span><span class="o">==</span><span class="s">&#34;Z_mu[1,1]&#34;</span><span class="p">)</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="s">&#34;SO_Class1_normalize&#34;</span> <span class="c1"># Sales/Office</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span><span class="nf">[which</span><span class="p">(</span><span class="nf">colnames</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span><span class="o">==</span><span class="s">&#34;Z_mu[1,2]&#34;</span><span class="p">)</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="s">&#34;SO_Class2_normalize&#34;</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span><span class="nf">[which</span><span class="p">(</span><span class="nf">colnames</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span><span class="o">==</span><span class="s">&#34;Z_mu[2,1]&#34;</span><span class="p">)</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="s">&#34;SE_Class1_normalize&#34;</span> <span class="c1"># Sales/Employees</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span><span class="nf">[which</span><span class="p">(</span><span class="nf">colnames</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span><span class="o">==</span><span class="s">&#34;Z_mu[2,2]&#34;</span><span class="p">)</span><span class="n">]</span> <span class="o">&lt;-</span> <span class="s">&#34;SE_Class2_normalize&#34;</span>

<span class="n">posterior</span> <span class="o">%&gt;%</span> <span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="nf">starts_with</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;p&#34;</span><span class="p">,</span><span class="s">&#34;lp__&#34;</span><span class="p">)))</span> <span class="o">%&gt;%</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">SO_Class1</span> <span class="o">=</span> <span class="n">SO_Class1_normalize</span> <span class="o">*</span> <span class="nf">attr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="s">&#39;scaled:scale&#39;</span><span class="p">)</span><span class="n">[1]</span> <span class="o">+</span> <span class="nf">attr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="s">&#39;scaled:center&#39;</span><span class="p">)</span><span class="n">[1]</span><span class="p">,</span>
         <span class="n">SO_Class2</span> <span class="o">=</span> <span class="n">SO_Class2_normalize</span> <span class="o">*</span> <span class="nf">attr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="s">&#39;scaled:center&#39;</span><span class="p">)</span><span class="n">[1]</span> <span class="o">+</span> <span class="nf">attr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="s">&#39;scaled:center&#39;</span><span class="p">)</span><span class="n">[1]</span><span class="p">,</span>
         <span class="n">SE_Class1</span> <span class="o">=</span> <span class="n">SE_Class1_normalize</span> <span class="o">*</span> <span class="nf">attr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="s">&#39;scaled:center&#39;</span><span class="p">)</span><span class="n">[2]</span> <span class="o">+</span> <span class="nf">attr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="s">&#39;scaled:center&#39;</span><span class="p">)</span><span class="n">[2]</span><span class="p">,</span>
         <span class="n">SE_Class2</span> <span class="o">=</span> <span class="n">SE_Class2_normalize</span> <span class="o">*</span> <span class="nf">attr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="s">&#39;scaled:center&#39;</span><span class="p">)</span><span class="n">[2]</span> <span class="o">+</span> <span class="nf">attr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="s">&#39;scaled:center&#39;</span><span class="p">)</span><span class="n">[2]</span><span class="p">,</span>
         <span class="n">sigma_SO</span> <span class="o">=</span> <span class="m">1</span> <span class="o">*</span> <span class="nf">attr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="s">&#39;scaled:scale&#39;</span><span class="p">)</span><span class="n">[1]</span><span class="p">,</span>
         <span class="n">sigma_SE</span> <span class="o">=</span> <span class="m">1</span> <span class="o">*</span> <span class="nf">attr</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="s">&#39;scaled:scale&#39;</span><span class="p">)</span><span class="n">[2]</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">select</span><span class="p">(</span><span class="n">SO_Class1</span><span class="p">,</span> <span class="n">SO_Class2</span><span class="p">,</span> <span class="n">SE_Class1</span><span class="p">,</span> <span class="n">SE_Class2</span><span class="p">,</span> <span class="n">sigma_SO</span><span class="p">,</span> <span class="n">sigma_SE</span><span class="p">,</span> <span class="nf">starts_with</span><span class="p">(</span><span class="s">&#34;theta&#34;</span><span class="p">)</span> <span class="p">)</span><span class="o">-&gt;</span> <span class="n">res_data</span>


<span class="c1"># 混合正規分布の確率密度関数を作成。中央値を用いる</span>

<span class="n">bw1</span> <span class="o">&lt;-</span> <span class="nf">diff</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="n">d[</span><span class="p">,</span><span class="m">3</span><span class="n">]</span><span class="p">))</span><span class="o">/</span><span class="m">30</span>
<span class="n">bw2</span> <span class="o">&lt;-</span> <span class="nf">diff</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="n">d[</span><span class="p">,</span><span class="m">4</span><span class="n">]</span><span class="p">))</span><span class="o">/</span><span class="m">30</span>

<span class="n">dmixnorm1</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="n">bw1</span> <span class="o">*</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">*</span><span class="nf">median</span><span class="p">(</span><span class="n">res_data</span><span class="o">$</span><span class="s">&#39;theta[1]&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="nf">dnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mean</span><span class="o">=</span><span class="nf">median</span><span class="p">(</span><span class="n">res_data</span><span class="o">$</span><span class="n">SO_Class1</span><span class="p">),</span> <span class="n">sd</span><span class="o">=</span><span class="nf">median</span><span class="p">(</span><span class="n">res_data</span><span class="o">$</span><span class="n">sigma_SO</span><span class="p">))</span> <span class="o">+</span>
  <span class="n">bw1</span> <span class="o">*</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="nf">median</span><span class="p">(</span><span class="n">res_data</span><span class="o">$</span><span class="s">&#39;theta[2]&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="nf">dnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mean</span><span class="o">=</span><span class="nf">median</span><span class="p">(</span><span class="n">res_data</span><span class="o">$</span><span class="n">SO_Class2</span><span class="p">),</span> <span class="n">sd</span><span class="o">=</span><span class="nf">median</span><span class="p">(</span><span class="n">res_data</span><span class="o">$</span><span class="n">sigma_SO</span><span class="p">))</span>
<span class="n">dmixnorm2</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">bw2</span> <span class="o">*</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="nf">median</span><span class="p">(</span><span class="n">res_data</span><span class="o">$</span><span class="s">&#39;theta[1]&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="nf">dnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mean</span><span class="o">=</span><span class="nf">median</span><span class="p">(</span><span class="n">res_data</span><span class="o">$</span><span class="n">SE_Class1</span><span class="p">),</span> <span class="n">sd</span><span class="o">=</span><span class="nf">median</span><span class="p">(</span><span class="n">res_data</span><span class="o">$</span><span class="n">sigma_SE</span><span class="p">))</span> <span class="o">+</span>
  <span class="n">bw2</span> <span class="o">*</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="nf">median</span><span class="p">(</span><span class="n">res_data</span><span class="o">$</span><span class="s">&#39;theta[2]&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="nf">dnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mean</span><span class="o">=</span><span class="nf">median</span><span class="p">(</span><span class="n">res_data</span><span class="o">$</span><span class="n">SE_Class2</span><span class="p">),</span> <span class="n">sd</span><span class="o">=</span><span class="nf">median</span><span class="p">(</span><span class="n">res_data</span><span class="o">$</span><span class="n">sigma_SE</span><span class="p">))</span>

<span class="n">dmixnorm1_samples</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>  <span class="n">bw1</span> <span class="o">*</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">*</span><span class="n">res_data</span><span class="o">$</span><span class="s">&#39;theta[1]&#39;</span><span class="n">[sample]</span> <span class="o">*</span> <span class="nf">dnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mean</span><span class="o">=</span><span class="n">res_data</span><span class="o">$</span><span class="n">SO_Class1[sample]</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">res_data</span><span class="o">$</span><span class="n">sigma_SO[sample]</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">bw1</span> <span class="o">*</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="n">res_data</span><span class="o">$</span><span class="s">&#39;theta[2]&#39;</span><span class="n">[sample]</span> <span class="o">*</span> <span class="nf">dnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mean</span><span class="o">=</span><span class="n">res_data</span><span class="o">$</span><span class="n">SO_Class2[sample]</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">res_data</span><span class="o">$</span><span class="n">sigma_SO[sample]</span><span class="p">)</span>
<span class="n">dmixnorm2_samples</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span> <span class="n">bw2</span> <span class="o">*</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="n">res_data</span><span class="o">$</span><span class="s">&#39;theta[1]&#39;</span><span class="n">[sample]</span> <span class="o">*</span> <span class="nf">dnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mean</span><span class="o">=</span><span class="n">res_data</span><span class="o">$</span><span class="n">SE_Class1[sample]</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">res_data</span><span class="o">$</span><span class="n">sigma_SE[sample]</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">bw2</span> <span class="o">*</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="n">res_data</span><span class="o">$</span><span class="s">&#39;theta[2]&#39;</span><span class="n">[sample]</span> <span class="o">*</span> <span class="nf">dnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mean</span><span class="o">=</span><span class="n">res_data</span><span class="o">$</span><span class="n">SE_Class2[sample]</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">res_data</span><span class="o">$</span><span class="n">sigma_SE[sample]</span><span class="p">)</span>

<span class="c1"># 雲を纏わせる</span>

<span class="n">samples</span> <span class="o">&lt;-</span> <span class="nf">sample</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">4000</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="m">80</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>

<span class="n">q1</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">d[</span><span class="p">,</span><span class="m">3</span><span class="n">]</span><span class="p">,</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">SE</span><span class="p">))</span>
<span class="n">q1</span> <span class="o">&lt;-</span> <span class="n">q1</span> <span class="o">+</span> <span class="nf">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="o">=</span><span class="m">11</span><span class="p">)</span>
<span class="n">q1</span> <span class="o">&lt;-</span> <span class="n">q1</span> <span class="o">+</span> <span class="nf">geom_histogram</span><span class="p">(</span><span class="n">binwidth</span> <span class="o">=</span> <span class="n">bw1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s">&#34;#A6CEE3&#34;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#34;grey20&#34;</span><span class="p">)</span>
<span class="nf">for</span><span class="p">(</span><span class="n">n</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">samples</span><span class="p">)){</span>
  <span class="n">q1</span> <span class="o">&lt;-</span> <span class="n">q1</span> <span class="o">+</span> <span class="nf">stat_function</span><span class="p">(</span><span class="n">fun</span><span class="o">=</span><span class="n">dmixnorm1_samples</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">sample</span><span class="o">=</span><span class="n">samples[n]</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#34;#D53E4F&#34;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="m">0.2</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="nf">max</span><span class="p">(</span><span class="n">d[</span><span class="p">,</span><span class="m">3</span><span class="n">]</span><span class="p">)))</span>
<span class="p">}</span>
<span class="n">q1</span> <span class="o">&lt;-</span> <span class="n">q1</span> <span class="o">+</span> <span class="nf">stat_function</span><span class="p">(</span><span class="n">fun</span><span class="o">=</span><span class="n">dmixnorm1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#34;#9E0142&#34;</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="nf">max</span><span class="p">(</span><span class="n">d[</span><span class="p">,</span><span class="m">3</span><span class="n">]</span><span class="p">)))</span>
<span class="n">q1</span> <span class="o">&lt;-</span> <span class="n">q1</span> <span class="o">+</span> <span class="nf">xlab</span><span class="p">(</span><span class="s">&#34;Sales/Employees&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">ylab</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
<span class="n">q1</span> <span class="o">&lt;-</span> <span class="n">q1</span> <span class="o">+</span> <span class="nf">coord_cartesian</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">150</span><span class="p">))</span>

<span class="n">q2</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">d[</span><span class="p">,</span><span class="m">4</span><span class="n">]</span><span class="p">),</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">SO</span><span class="p">))</span>
<span class="n">q2</span> <span class="o">&lt;-</span> <span class="n">q2</span> <span class="o">+</span> <span class="nf">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="o">=</span><span class="m">11</span><span class="p">)</span>
<span class="n">q2</span> <span class="o">&lt;-</span> <span class="n">q2</span> <span class="o">+</span> <span class="nf">geom_histogram</span><span class="p">(</span><span class="n">binwidth</span> <span class="o">=</span> <span class="n">bw2</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s">&#34;#A6CEE3&#34;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#34;grey20&#34;</span><span class="p">)</span> <span class="o">+</span><span class="nf">labs</span><span class="p">(</span><span class="s">&#34;aa&#34;</span><span class="p">)</span>
<span class="nf">for</span><span class="p">(</span><span class="n">n</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">samples</span><span class="p">)){</span>
  <span class="n">q2</span> <span class="o">&lt;-</span> <span class="n">q2</span> <span class="o">+</span> <span class="nf">stat_function</span><span class="p">(</span><span class="n">fun</span><span class="o">=</span><span class="n">dmixnorm2_samples</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">sample</span><span class="o">=</span><span class="n">samples[n]</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#34;#D53E4F&#34;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="m">0.2</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">,</span> <span class="n">xlim</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="nf">max</span><span class="p">(</span><span class="n">d[</span><span class="p">,</span><span class="m">4</span><span class="n">]</span><span class="p">)))</span>
<span class="p">}</span>
<span class="n">q2</span> <span class="o">&lt;-</span> <span class="n">q2</span> <span class="o">+</span> <span class="nf">stat_function</span><span class="p">(</span><span class="n">fun</span><span class="o">=</span><span class="n">dmixnorm2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#34;#9E0142&#34;</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">xlim</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="nf">max</span><span class="p">(</span><span class="n">d[</span><span class="p">,</span><span class="m">4</span><span class="n">]</span><span class="p">)))</span>
<span class="n">q2</span> <span class="o">&lt;-</span> <span class="n">q2</span> <span class="o">+</span> <span class="nf">xlab</span><span class="p">(</span><span class="s">&#34;Sales/Office&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">ylab</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
<span class="n">q2</span> <span class="o">&lt;-</span> <span class="n">q2</span> <span class="o">+</span> <span class="nf">coord_cartesian</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">150</span><span class="p">))</span>

<span class="n">q</span> <span class="o">&lt;-</span> <span class="n">gridExtra</span><span class="o">::</span><span class="nf">grid.arrange</span><span class="p">(</span><span class="n">q2</span><span class="p">,</span><span class="n">q1</span><span class="p">,</span><span class="n">ncol</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span>
</code></pre></div><figure>
    <img src="https://sucre-stat.com/r/tokyo-meshdata/mixnormdensity-model.png" width="600"/> 
</figure>

<p>無難な結果が得られているのではないかなあ、という感じです。はじめのタイル図がクラスタリングの推定結果ですが、タイルごとに「High Efficiency」である確率の事後分布の中央値を示しています。このように各クラスターへ分類される確率で結果が得られるのがSoft K-means法の特徴です。</p>
<h1 id="ガウス過程をあてはめてみる">ガウス過程をあてはめてみる</h1>
<p>問題はここからです。ただクラスタリングを試すだけなら空間データを扱う必要はありません。なぜ今回空間データを扱ったかというと、普遍的なモデルにガウス過程を組み込む練習がしたかったからです。</p>
<p>ガウス過程は「<strong>近い距離関係にある変数同士ほど近い値をとる</strong>」というような性質を変数間に与えることが可能です。今回は文字通り地理的に近い距離関係にある地域ほど小売業の「Efficiency」は近い値をとるだろう、という関係をガウス過程を使って上記モデルに組み込んでみたいと思います<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>。</p>
<p>追加する計算は以下のとおりです。</p>
<div style="overflow-x:auto;">
  
$$
\mathrm{logit}(\boldsymbol{p}_{(Z_n = k)}) \sim \mathrm{MultiNormal}(\boldsymbol{0}_n, K) \tag{7}
$$

$$
\boldsymbol{p}_{(Z_n = k)} = (p_{Z_1=k},\ldots,p_{Z_n=k})^T, ~~~ \boldsymbol{0}_n = (0,\ldots,0)^T∈\mathbb{R}^n \tag{8}
$$

$$
k_{nn'} = \phi_{\boldsymbol{loc}_n}^T\phi_{\boldsymbol{loc}_{n'}} \tag{9}
$$

</div>
<p>$\mathrm{logit}(\boldsymbol{p}_ {(Z_ n = k)})$の各要素の平均値を0としているので、各クラスが「High Efficiency」である確率は情報に乏しい付近では0.5に収束するようなガウス過程です。
ここで$k_{nn&rsquo;}$はグラム行列$K$の$(n,n&rsquo;)$成分です。$\boldsymbol{loc}_n$には$n$番目の変数の座標$(x,y)$が格納されています。$\phi$はカーネル関数です。今回はガウスカーネルを使ってみます。</p>
<p>上記モデルの実装は以下です。<a href="https://sucre-stat.com/2020/07/multinom-gp/">以前の記事</a>でガウス過程のいパーパラメータ推定は懲りたので、今回はこちらからハイパーパラメータを指定していきます。</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="c1">//model2.stan
</span><span class="c1"></span><span class="n">data</span><span class="p">{</span>
  <span class="kt">int</span> <span class="n">D</span><span class="p">;</span> <span class="c1">//入力数
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">N</span><span class="p">;</span> <span class="c1">//サンプル数
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">K</span><span class="p">;</span> <span class="c1">//クラス数
</span><span class="c1"></span>  <span class="n">vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">loc</span><span class="p">[</span><span class="n">N</span><span class="p">];</span> <span class="c1">//入力位置
</span><span class="c1"></span>  <span class="n">vector</span><span class="p">[</span><span class="n">D</span><span class="p">]</span> <span class="n">Z</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
  <span class="n">real</span> <span class="n">alpha</span><span class="p">;</span>
  <span class="n">real</span> <span class="n">rho</span><span class="p">;</span>
  <span class="n">real</span> <span class="n">delta_sq</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">transformed</span> <span class="n">data</span><span class="p">{</span>
  <span class="n">vector</span><span class="p">[</span><span class="n">N</span><span class="p">]</span> <span class="n">Mu</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">N</span><span class="p">)</span> <span class="n">Mu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">parameters</span><span class="p">{</span>
  <span class="n">simplex</span><span class="p">[</span><span class="n">K</span><span class="p">]</span> <span class="n">theta</span><span class="p">;</span> <span class="c1">//各クラスターへ割り振られる確率
</span><span class="c1"></span>  <span class="n">ordered</span><span class="p">[</span><span class="n">K</span><span class="p">]</span> <span class="n">Z_mu</span><span class="p">[</span><span class="n">D</span><span class="p">];</span> <span class="c1">//クラスター平均
</span><span class="c1"></span><span class="p">}</span>

<span class="n">transformed</span> <span class="n">parameters</span><span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">upper</span><span class="o">=</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">[</span><span class="n">K</span><span class="p">]</span> <span class="n">soft_z</span><span class="p">[</span><span class="n">N</span><span class="p">];</span> <span class="c1">//クラスター毎の対数尤度
</span><span class="c1"></span>  <span class="n">vector</span><span class="p">[</span><span class="n">K</span><span class="p">]</span> <span class="n">p</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
  <span class="n">matrix</span><span class="p">[</span><span class="n">N</span><span class="p">,</span><span class="n">K</span><span class="p">]</span> <span class="n">p_logit</span><span class="p">;</span> <span class="c1">//matrix型なら列・行どちらの取り出しでもベクトル型になる
</span><span class="c1"></span>  <span class="n">matrix</span><span class="p">[</span><span class="n">K</span><span class="p">,</span><span class="n">N</span><span class="p">]</span> <span class="n">dotself</span> <span class="o">=</span> <span class="n">rep_matrix</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">N</span><span class="p">);</span>
  <span class="n">matrix</span><span class="p">[</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">]</span> <span class="n">cov</span><span class="p">;</span>

  <span class="k">for</span><span class="p">(</span><span class="n">k</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">K</span><span class="p">){</span>
    <span class="k">for</span><span class="p">(</span><span class="n">n</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">N</span><span class="p">){</span>
      <span class="k">for</span><span class="p">(</span><span class="n">d</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">D</span><span class="p">){</span>
        <span class="n">dotself</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">Z_mu</span><span class="p">[</span><span class="n">d</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">Z</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="n">d</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">//クラスター毎の対数尤度の計算
</span><span class="c1"></span>  <span class="k">for</span><span class="p">(</span><span class="n">n</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">N</span><span class="p">){</span>
    <span class="k">for</span><span class="p">(</span><span class="n">k</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">K</span><span class="p">){</span>
      <span class="n">soft_z</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dotself</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">for</span><span class="p">(</span><span class="n">n</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">N</span><span class="p">){</span>
    <span class="n">p</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">soft_z</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
    <span class="n">p_logit</span><span class="p">[</span><span class="n">n</span><span class="p">,]</span> <span class="o">=</span> <span class="n">logit</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">n</span><span class="p">])</span><span class="err">&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// カーネル行列の作成
</span><span class="c1"></span>  <span class="n">cov</span> <span class="o">=</span> <span class="n">cov_exp_quad</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">rho</span><span class="p">);</span>
  <span class="k">for</span><span class="p">(</span><span class="n">n</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">N</span><span class="p">){</span>
    <span class="n">cov</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta_sq</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="n">model</span><span class="p">{</span>
  <span class="c1">//likelihood
</span><span class="c1"></span>  <span class="k">for</span><span class="p">(</span><span class="n">n</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">N</span><span class="p">){</span>
    <span class="n">target</span> <span class="o">+=</span> <span class="n">log_sum_exp</span><span class="p">(</span><span class="n">soft_z</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="c1">//GP
</span><span class="c1"></span>  <span class="k">for</span><span class="p">(</span><span class="n">k</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="p">(</span><span class="n">K</span><span class="o">-</span><span class="mi">1</span><span class="p">)){</span>
    <span class="n">p_logit</span><span class="p">[,</span><span class="n">k</span><span class="p">]</span> <span class="o">~</span> <span class="n">multi_normal</span><span class="p">(</span><span class="n">Mu</span><span class="p">,</span> <span class="n">cov</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div><p>以下で上記モデルを走らせ、結果を確認します。ハイパーパラメータは$\alpha=30$、$\rho=1.15$で。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">data</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span><span class="n">D</span><span class="o">=</span><span class="n">D</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">Z</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="m">30</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="m">1.15</span><span class="p">,</span> <span class="n">delta_sq</span><span class="o">=</span><span class="m">0.01</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>

<span class="n">stanmodel2</span> <span class="o">&lt;-</span> <span class="nf">stan_model</span><span class="p">(</span><span class="s">&#34;model2.stan&#34;</span><span class="p">)</span>

<span class="n">fit2</span> <span class="o">&lt;-</span><span class="nf">sampling</span><span class="p">(</span><span class="n">stanmodel2</span><span class="p">,</span> <span class="n">pars</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;Z_mu&#34;</span><span class="p">,</span><span class="s">&#34;theta&#34;</span><span class="p">,</span><span class="s">&#34;p&#34;</span><span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">iter</span><span class="o">=</span><span class="m">1300</span><span class="p">,</span> <span class="n">warmup</span><span class="o">=</span><span class="m">300</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="m">123</span><span class="p">)</span>
<span class="n">fit2</span>

<span class="c1">## Inference for Stan model: model2.</span>
<span class="c1">## 4 chains, each with iter=1300; warmup=300; thin=1;</span>
<span class="c1">## post-warmup draws per chain=1000, total post-warmup draws=4000.</span>
<span class="c1">##</span>
<span class="c1">##               mean se_mean   sd     2.5%      25%      50%      75%    97.5% n_eff Rhat</span>
<span class="c1">## Z_mu[1,1]    -0.11    0.00 0.06    -0.24    -0.15    -0.11    -0.07     0.01  1781 1.00</span>
<span class="c1">## Z_mu[1,2]     0.48    0.01 0.17     0.10     0.38     0.49     0.60     0.80   978 1.00</span>
<span class="c1">## Z_mu[2,2]     0.46    0.01 0.17     0.09     0.36     0.47     0.58     0.77   783 1.00</span>
<span class="c1">## Z_mu[2,1]    -0.11    0.00 0.06    -0.23    -0.15    -0.11    -0.07     0.01  2398 1.00</span>
<span class="c1">## theta[1]      0.80    0.00 0.09     0.55     0.77     0.82     0.85     0.90   553 1.01</span>
<span class="c1">## theta[2]      0.20    0.00 0.09     0.10     0.15     0.18     0.23     0.45   553 1.01</span>
<span class="c1">## p[1,1]        0.03    0.00 0.06     0.00     0.01     0.01     0.03     0.18   593 1.00</span>
<span class="c1">## p[1,2]        0.97    0.00 0.06     0.82     0.97     0.99     0.99     1.00   593 1.00</span>
<span class="c1">## p[2,1]        0.04    0.00 0.06     0.00     0.01     0.02     0.04     0.20   599 1.00</span>
<span class="c1">## p[2,2]        0.96    0.00 0.06     0.80     0.96     0.98     0.99     1.00   599 1.00</span>

</code></pre></div><figure>
    <img src="https://sucre-stat.com/r/tokyo-meshdata/result-model2.png" width="600"/> 
</figure>

<figure>
    <img src="https://sucre-stat.com/r/tokyo-meshdata/mcmcareas-model2.png" width="600"/> 
</figure>

<figure>
    <img src="https://sucre-stat.com/r/tokyo-meshdata/mixnormdensity-model2.png" width="600"/> 
</figure>

<p>ん、確かに確率が空間的に滑らかにつながったように見えなくもないが、依然として隣り合ったセル間の差が大きいところもあるな…
$\rho$を微妙に大きく1.2にして、いびつさをもう少し和らげたガウス過程にしてみよう。</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="n">data</span> <span class="o">&lt;-</span> <span class="n">list</span><span class="p">(</span><span class="n">D</span><span class="o">=</span><span class="n">D</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">Z</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">delta_sq</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>
<span class="n">fit2</span> <span class="o">&lt;-</span><span class="n">sampling</span><span class="p">(</span><span class="n">stanmodel2</span><span class="p">,</span> <span class="n">pars</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s">&#34;Z_mu&#34;</span><span class="p">,</span><span class="s">&#34;theta&#34;</span><span class="p">,</span><span class="s">&#34;p&#34;</span><span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">iter</span><span class="o">=</span><span class="mi">1300</span><span class="p">,</span> <span class="n">warmup</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
<span class="p">(</span><span class="err">以降、省略</span><span class="p">)</span>
</code></pre></div><figure>
    <img src="https://sucre-stat.com/r/tokyo-meshdata/Result-model2-2.png" width="600"/> 
</figure>

<figure>
    <img src="https://sucre-stat.com/r/tokyo-meshdata/mcmcareas-model2-2.png" width="600"/> 
</figure>

<p>ハイパーパラメータの値を少しだけ変えただけなのに、今度は手のひらを返したかのように優柔不断な分類結果が得られてしまった。どのセルも確率がほぼ0.5ではないか。</p>
<p>もっと、クラスター平均がある程度離れたまま、空間的に滑らかで急な変化の少ない確率群が得られるかと予想していたのだが…</p>
<p>はじめは実装に問題があるのかと思ったのですが、組み立てたモデルの動作を想像すると原因がすぐにわかりました。</p>
<p>$\rho$をある程度大きくしてなだらかな曲線を描くガウス過程にすると、まず「High Efficiency」だろうと言えるセルのとなりの「Low Efficiecy」っぽいセルまでもが、「High Efficiency」であるという確率が高くなってしまい、その結果二つのクラスターの平均値が近づいて行ってしまうようです。</p>
<p>組み立てたモデルがうまくいかないとき、つい実装が悪いのではと疑ってしまいますが、そもそも組み立てたモデルが自分の意図したとおりに動くものなのか、ということを再確認することも大切なんだなと思いました。</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>本当は空間的自己相関を確認してからこういうモデルを検討すべきなのでしょうが、空間的自己相関の知識がまだ中途半端なのでここでは割愛します <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

        </article>
    </div>
    <div class="main-content__tags u-font">
        
        
        <span><a href="https://sucre-stat.com/tags/%E3%82%AC%E3%82%A6%E3%82%B9%E9%81%8E%E7%A8%8B">ガウス過程</a></span>
        
        <span><a href="https://sucre-stat.com/tags/rstan">rstan</a></span>
        
        <span><a href="https://sucre-stat.com/tags/%E5%88%86%E9%A1%9E">分類</a></span>
        
        
    </div>



<div class="contact_form">
    <p>コメントを書く</p>
<form id="my-form" action="https://sucre-stat.com/" name="sampleCommentForm" method="post" netlify-honeypot="bot-field" netlify>
    <label>お名前：<input type="text" name="name" /></label>
    <label>Email(任意)： <input type="email" name="email" /></label>
    <label>コメント： <textarea name="content"></textarea></label>
  <p style="display:none;">
    <label>Bot Field(ここに値が入るとスパム判定する): <input name="bot-field"/></label>
  </p>
  <div>
    <button type="submit" value="Send">送信</button>
    <p><br>※ コメントは承認されると表示されます<br></p>
    <input type="hidden" name="path" value="/2020/12/tokyo-meshdata/index.html" />
    <p>承認されたコメント一覧</p>
    <ul class="comment" id="approvalCommentsList"></ul>

  </div>
</form>
</div>


<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script language="javascript" type="text/javascript">

const url = '/comment/_data/sampleApprovedComments_submissions.json'
$.getJSON(url, (json) => {
  for (let i = 0; i < json.length; i++) {
    if (json[i].data.path !== '\/2020\/12\/tokyo-meshdata\/index.html') {
      continue
    }
    $('#approvalCommentsList').append(`<li>お名前　： ${json[i].data.name}<br>コメント： ${json[i].data.content}</li>`)
  }
})

// 送信前に一言感謝
$("#my-form").submit(function(e) {
  alert("Thank you!");
});
</script>

<div class="main-profile">
    <div class="main-profile__avatar">
        
            <img src="https://sucre-stat.com/images/avatar.JPG">
        
    </div>
    <div class="main-profile__body">
        <div class="main-profile__author">
            
            <span> R.morita </span>
            
        </div>
        <div class="main-profile__description">
            
            <p> 得意なのは統一された洋服とダンスのステップです </p>
            
        </div>
    </div>
</div>
<div class="main-line"></div>
<div class="main-pn">
    
    <a class="previous" href="https://sucre-stat.com/2020/12/corresp-and-bayes/">
        <div class="pn-dec"></div>
        <div class="pn-els">
            <div class="pn-el__1"> 2020.12.11 00:00 </div>
            <div class="pn-el__2"> Stanで対応分析の付置にベイズ信頼区間をもたせる </div>
        </div>
    </a>
    
    
    <a class="next" href="https://sucre-stat.com/2021/01/begin-julia/">
        <div class="pn-dec"></div>
        <div class="pn-els">
            <div class="pn-el__1"> 2021.01.05 00:00 </div>
            <div class="pn-el__2"> Julia始めました </div>
        </div>
    </a>
    
</div>

<footer>
  <script type="text/javascript">
 MathJax = {
   tex: {
     inlineMath: [['$','$'], ['\\(','\\)']],
     processEscapes: true,
     tags: "ams",
     autoload: {
       color: [],
       colorV2: ['color']
     },
     packages: {'[+]': ['noerrors']}
   },
   chtml: {
     matchFontHeight: true,
     displayAlign: "left",
     displayIndent: "2em"
   },
   options: {
     skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
     renderActions: {
        
       find_script_mathtex: [10, function (doc) {
         for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
           const display = !!node.type.match(/; *mode=display/);
           const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
           const text = document.createTextNode('');
           node.parentNode.replaceChild(text, node);
           math.start = {node: text, delim: '', n: 0};
           math.end = {node: text, delim: '', n: 0};
           doc.math.push(math);
         }
       }, '']
     }
   },
   loader: {
     load: ['[tex]/noerrors']
   }
 };
</script>
<script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script"></script>
</footer>

</div>
<div class="footer">
    <div class="copyright-wrap">
        <p class="copyright u-font">
            
            &#169;
            2021
            
            <a href="https://github.com/Rmorita-stat/doc" target="_blank">R.morita&#46;</a>
            Theme <a href="https://github.com/iCyris/hugo-theme-yuki" target="_blank">yuki</a>&#46;
            Powered by Hugo&#46;
            
            
        </p>
    </div>
</div>
</body>
<script src="https://sucre-stat.com/js/page.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

