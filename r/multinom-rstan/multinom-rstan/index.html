<!DOCTYPE html>
<html>
<head>
    <meta name="google-site-verification" content="qrt5G5NouQQVS-0Ss9qHlEuMYt3uKuifbUIOkPd4cPc" />
    <meta charset="utf-8">
    <title>
        
        SUCRE HECACHA
        
    </title>
    <meta name="viewport" id="viewport" content="width=device-width, initial-scale=1">
    <link rel='icon' type='image/x-icon' href="https://rmorita-stat.github.io/images/logo2.png" />
    <link rel="apple-touch-icon" href="https://rmorita-stat.github.io/images/logo2.png"><link rel="stylesheet" href="https://rmorita-stat.github.io/scss/style.css">
    
    <link rel="stylesheet" href="https://rmorita-stat.github.io/css/syntax.css">
    <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
    <script src="https://rmorita-stat.github.io/js/highlight.min.js"></script>
    <link rel="stylesheet" href="https://rmorita-stat.github.io/scss/highlight.css">
    
    <link rel="stylesheet" href="https://rmorita-stat.github.io/scss/custom.css">
    
    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'Your Google Analytics tracking id', 'auto');
        ga('send', 'pageview');
    </script>
    
    
    <meta name="generator" content="Hugo 0.71.0" /></head>


<body>
<div class="header">
    <div class="site-logo__wrap">
        <div id="site-button">
            <div></div>
        </div>
        
        <div class=' site-logo '>
            <a href="https://rmorita-stat.github.io/"><img src="https://rmorita-stat.github.io/images/logo.png" /></a>
        </div>
    </div>
    
<div class=' site-nav u-font ' id="nav-bar">
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="/" >HOME</a>
    </div>
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="/stat" >STAT</a>
    </div>
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="/r" >With R</a>
    </div>
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="/julia" >With Julia</a>
    </div>
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="/about" >ABOUT</a>
    </div>
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="/tags/" >TAGS</a>
    </div>
    
</div>

</div>
<div class="main">

<div class="main-content">
    <div class="main-content__date">
        <h4 id="date"> 2020.05.31 00:00 </h4>
    </div>
    <div class="main-content__title">
        <h1 id="title">rstanã‚’ä½¿ã£ãŸå¤šé …ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°</h1>
    </div>
    <div class="main-content__article">
        <article id="content">
            <h1 id="ã¯ã˜ã‚ã«">ã¯ã˜ã‚ã«</h1>
<p><strong>å›å¸°</strong>ã«é–¢ã™ã‚‹è¨˜äº‹ã§ã™ã€‚æœ¬è¨˜äº‹ã§ã¯<a href="https://rmorita-stat.github.io/2020/05/multinom/">ä»¥å‰ã®è¨˜äº‹</a>ã§æ‰±ã£ãŸå¤šé …ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ã‚’<strong>rstan</strong>ã§å®Ÿè¡Œã—ã¾ã™ã€‚</p>
<p>æœ¬è¨˜äº‹ã®æ§‹æˆã¯ä»¥ä¸‹ã®é€šã‚Šã¨ã—ã¾ã™ã€‚</p>
<!-- raw HTML omitted -->
<ul>
<li><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">ã¯ã˜ã‚ã«</a></li>
<li><a href="#%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E7%A2%BA%E8%AA%8D">ãƒ¢ãƒ‡ãƒ«ã®ç¢ºèª</a></li>
<li><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%85%A5%E6%89%8B%E3%83%BB%E6%95%B4%E5%BD%A2">ãƒ‡ãƒ¼ã‚¿ã®å…¥æ‰‹ãƒ»æ•´å½¢</a></li>
<li><a href="#stan%E3%81%AB%E3%82%88%E3%82%8B%E5%A4%9A%E9%A0%85%E3%83%AD%E3%82%B8%E3%82%B9%E3%83%86%E3%82%A3%E3%83%83%E3%82%AF%E5%9B%9E%E5%B8%B0%E3%81%AE%E5%AE%9F%E8%A3%85">Stanã«ã‚ˆã‚‹å¤šé …ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ã®å®Ÿè£…</a></li>
<li><a href="#%E7%B5%90%E6%9E%9C%E3%81%AE%E7%A2%BA%E8%AA%8D">çµæœã®ç¢ºèª</a>
<ul>
<li><a href="#mcmc%E3%81%AE%E5%8F%8E%E6%9D%9F%E3%81%AE%E7%A2%BA%E8%AA%8D">MCMCã®åæŸã®ç¢ºèª</a></li>
<li><a href="#%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E4%BF%82%E6%95%B0%E3%81%AB%E7%9D%80%E7%9B%AE">ãƒ¢ãƒ‡ãƒ«ã®ä¿‚æ•°ã«ç€ç›®</a></li>
<li><a href="#%E3%82%AA%E3%83%83%E3%82%BA%E6%AF%94%E3%81%AE%E5%A4%89%E9%87%8F%E3%81%AB%E7%9D%80%E7%9B%AE">ã‚ªãƒƒã‚ºæ¯”ã®å¤‰é‡ã«ç€ç›®</a></li>
</ul>
</li>
<li><a href="#%E7%B5%90%E6%9E%9C%E3%81%AE%E6%8F%8F%E7%94%BB">çµæœã®æç”»</a></li>
<li><a href="#%E3%81%BE%E3%81%A8%E3%82%81">ã¾ã¨ã‚</a></li>
</ul>
<!-- raw HTML omitted -->
<h1 id="ãƒ¢ãƒ‡ãƒ«ã®ç¢ºèª">ãƒ¢ãƒ‡ãƒ«ã®ç¢ºèª</h1>
<p>ä»¥å‰ã®è¨˜äº‹ã§ã‚‚ç´¹ä»‹ã—ãŸå¤šé …ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ãƒ¢ãƒ‡ãƒ«ã®ä¸€èˆ¬å¼ã‚’å†æ²ã—ã¾ã™ã€‚
<!-- raw HTML omitted --><br>
å¾“å±å¤‰æ•°$Y$ã€èª¬æ˜å¤‰æ•°$X$ã«ã¤ã„ã¦ã€$Y = (y_1,\ldots,y_n,\ldots, y_N)^T$ã€$X = (x_1,\ldots, x_n,\ldots, x_N)^T$ã¨ã—ã€ã•ã‚‰ã«
$x_n = (x_{1n},\ldots,x_{dn},\ldots, x_{Dn})$ã¨ã—ãŸã¨ãã€å¤šé …ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ã®ãƒ¢ãƒ‡ãƒ«å¼ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚$N$ã¯ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºã€$D$ã¯èª¬æ˜å¤‰æ•°ã®æ¬¡å…ƒã§ã™ã€‚</p>
<p>$$
\mu_n = \overrightarrow{a} + \overrightarrow{b_1}x_{n1} + \cdots + \overrightarrow{b_d}x_{nd} + \cdots + \overrightarrow{b_D}x_{nD}
$$
$$
\theta_n = \rm{softmax}(\mu_n)
$$
$$
y_n \sim \rm{Categorical}(\theta_n)
$$
$$
(n=1,\ldots,N)
$$</p>
<p>ã“ã“ã§
$$
\mu=(\mu_1,\ldots,\mu_n,\ldots,\mu_N)
$$
$$
\theta=(\theta_1,\ldots,\theta_n,\ldots,\theta_N)
$$</p>
<p>$\mu_n, \theta_n,\overrightarrow{a},\overrightarrow{b_1},\ldots,\overrightarrow{b_D}$ã¯é•·ã•$K$ã®ãƒ™ã‚¯ãƒˆãƒ«ã§ã™ã€‚</p>
<h1 id="ãƒ‡ãƒ¼ã‚¿ã®å…¥æ‰‹æ•´å½¢">ãƒ‡ãƒ¼ã‚¿ã®å…¥æ‰‹ãƒ»æ•´å½¢</h1>
<p><a href="https://rmorita-stat.github.io/2020/05/multinom/">ä»¥å‰ã®è¨˜äº‹</a>ã§ã‚‚æ‰±ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’ç”¨ã„ã¾ã™ã€‚ä»Šå›ã‚‚prog(200äººã®ç”Ÿå¾’ãŒgeneralã€vocationã€academicã®3ã¤ã®æˆæ¥­ã‹ã‚‰é¸ã‚“ã æˆæ¥­)ã‚’å¾“å±å¤‰æ•°ã¨ã—ã€ses(å®¶åº­ã®çµŒæ¸ˆçŠ¶æ³)ã€write(æ›¸ãåŠ›)ã‚’å¾“å±å¤‰æ•°ã¨ã—ã¾ã™ã€‚</p>
<p>ä»¥ä¸‹ã®é€šã‚ŠStanã«æŒ‡å®šã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã«æ•´å½¢ã—ã¦ã„ãã¾ã™ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">library</span><span class="p">(</span><span class="n">makedummies</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">foreign</span><span class="p">)</span>

<span class="n">ml</span> <span class="o">&lt;-</span> <span class="nf">read.dta</span><span class="p">(</span><span class="s">&#34;https://stats.idre.ucla.edu/stat/data/hsbdemo.dta&#34;</span><span class="p">)</span>

<span class="c1">## progã®3å¼•æ•°ã‚’æ•°å­—ã«ç½®ãæ›ãˆã‚‹ãŸã‚ã®è¡¨ã‚’ä½œæˆ</span>
<span class="n">progid</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">)</span>
<span class="nf">names</span><span class="p">(</span><span class="n">progid</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;academic&#34;</span><span class="p">,</span><span class="s">&#34;general&#34;</span><span class="p">,</span><span class="s">&#34;vocation&#34;</span><span class="p">)</span>

<span class="c1">## makedummies()ã¯sesã«å¯¾ã—ã¦ãƒ€ãƒŸãƒ¼å¤‰æ•°ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨</span>
<span class="c1">## interceptã¯åˆ‡ç‰‡é …</span>
<span class="n">d</span> <span class="o">&lt;-</span> <span class="n">ml</span> <span class="o">%&gt;%</span> <span class="nf">cbind</span><span class="p">(</span><span class="n">makedummies</span><span class="o">::</span><span class="nf">makedummies</span><span class="p">(</span><span class="n">ml</span><span class="p">,</span><span class="n">basal_level</span> <span class="o">=</span> <span class="bp">F</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s">&#34;ses&#34;</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">progid</span> <span class="o">=</span> <span class="n">progid</span><span class="nf">[paste</span><span class="p">(</span><span class="n">prog</span><span class="p">)</span><span class="n">]</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">select</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">ses_middle</span><span class="p">,</span> <span class="n">ses_high</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">progid</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="nf">cbind</span><span class="p">(</span><span class="n">intercept</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="nf">nrow</span><span class="p">(</span><span class="n">ml</span><span class="p">)))</span>

<span class="nf">head</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="m">10</span><span class="p">)</span>

<span class="c1">##    ses_middle ses_high write progid intercept</span>
<span class="c1">## 1           0        0    35      3         1</span>
<span class="c1">## 2           1        0    33      2         1</span>
<span class="c1">## 3           0        1    39      3         1</span>
<span class="c1">## 4           0        0    37      3         1</span>
<span class="c1">## 5           1        0    31      3         1</span>
<span class="c1">## 6           0        1    36      2         1</span>
<span class="c1">## 7           1        0    36      3         1</span>
<span class="c1">## 8           1        0    31      3         1</span>
<span class="c1">## 9           1        0    41      3         1</span>
<span class="c1">## 10          1        0    37      3         1</span>

</code></pre></div><p>ã“ã“ã§ã€æœ¬ãƒ‡ãƒ¼ã‚¿ç”¨ã«è¨­å®šã—ãŸãƒ¢ãƒ‡ãƒ«å¼ã«ãŠã‘ã‚‹ä¿‚æ•°ã®å‘¼ç§°ã‚’ä»¥ä¸‹ã®é€šã‚Šå®šç¾©ã—ã¦ãŠãã¾ã™ã€‚</p>
<p>$$\cfrac{P(prog=general)}{P(prog=academic)} = \exp(b_{11} + b_{21}(ses=middle) + b_{31}(ses=high) + b_{41}write)$$</p>
<p>$$\cfrac{P(prog=vocation)}{P(prog=academic)} = \exp(b_{12} + b_{22}(ses=middle) + b_{32}(ses=high) + b_{42}write)$$</p>
<h1 id="stanã«ã‚ˆã‚‹å¤šé …ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ã®å®Ÿè£…">Stanã«ã‚ˆã‚‹å¤šé …ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ã®å®Ÿè£…</h1>
<p>å¤šé …ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ã‚’å®Ÿè¡Œã™ã‚‹Stanã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="c1">//(model1.stan)
</span><span class="c1">//dataãƒ–ãƒ­ãƒƒã‚¯ï¼šãƒ‡ãƒ¼ã‚¿ã‚’æŒ‡å®š
</span><span class="c1"></span><span class="n">data</span><span class="p">{</span>
  <span class="kt">int</span><span class="o">&lt;</span><span class="n">lower</span><span class="o">=</span><span class="mi">2</span><span class="o">&gt;</span> <span class="n">K</span><span class="p">;</span> <span class="c1">//ã‚«ãƒ†ã‚´ãƒªæ•°
</span><span class="c1"></span>  <span class="kt">int</span><span class="o">&lt;</span><span class="n">lower</span><span class="o">=</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">N</span><span class="p">;</span> <span class="c1">//ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º
</span><span class="c1"></span>  <span class="kt">int</span><span class="o">&lt;</span><span class="n">lower</span><span class="o">=</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">D</span><span class="p">;</span> <span class="c1">//ãƒ‡ãƒ¼ã‚¿é …ç›®æ•°+åˆ‡ç‰‡é …ã®æ•°ï¼ˆï¼‘ï¼‰
</span><span class="c1"></span>  <span class="kt">int</span><span class="o">&lt;</span><span class="n">lower</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">K</span><span class="o">&gt;</span> <span class="n">y</span><span class="p">[</span><span class="n">N</span><span class="p">];</span> <span class="c1">//prog
</span><span class="c1"></span>  <span class="n">matrix</span><span class="p">[</span><span class="n">N</span><span class="p">,</span><span class="n">D</span><span class="p">]</span> <span class="n">x</span><span class="p">;</span> <span class="c1">//èª¬æ˜å¤‰æ•°ã¨åˆ‡ç‰‡é …
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">N_new</span><span class="p">;</span> <span class="c1">//äºˆæ¸¬ç‚¹ã®æ•°
</span><span class="c1"></span>  <span class="n">matrix</span><span class="p">[</span><span class="n">N_new</span><span class="p">,</span><span class="n">D</span><span class="p">]</span> <span class="n">x_new</span><span class="p">;</span> <span class="c1">//äºˆæ¸¬ç‚¹ç¾¤
</span><span class="c1"></span><span class="p">}</span>

<span class="c1">//transformed dataãƒ–ãƒ­ãƒƒã‚¯ï¼šæ–°ã—ããƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ ã“ã“ã§ã¯muã®åŒºåˆ¥åŒ–ã®ç‚ºã®0ãƒ™ã‚¯ãƒˆãƒ«ã‚’ç”Ÿæˆ
</span><span class="c1"></span><span class="n">transformed</span> <span class="n">data</span><span class="p">{</span>
  <span class="n">vector</span><span class="p">[</span><span class="n">D</span><span class="p">]</span> <span class="n">Zeros</span><span class="p">;</span>
  <span class="n">Zeros</span> <span class="o">=</span> <span class="n">rep_vector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">D</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//parameterãƒ–ãƒ­ãƒƒã‚¯ï¼šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å®šç¾©
</span><span class="c1"></span><span class="n">parameters</span><span class="p">{</span>
  <span class="n">matrix</span><span class="p">[</span><span class="n">D</span><span class="p">,</span> <span class="n">K</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//transformed parameterãƒ–ãƒ­ãƒƒã‚¯ï¼šparameterãƒ–ãƒ­ãƒƒã‚¯ã§æŒ‡å®šã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰å½¢ ã“ã“ã§ã¯0ãƒ™ã‚¯ãƒˆãƒ«ã¨çµåˆ
</span><span class="c1"></span><span class="n">transformed</span> <span class="n">parameters</span><span class="p">{</span>
  <span class="n">matrix</span><span class="p">[</span><span class="n">D</span><span class="p">,</span><span class="n">K</span><span class="p">]</span> <span class="n">beta</span><span class="p">;</span>
  <span class="n">beta</span> <span class="o">=</span> <span class="n">append_col</span><span class="p">(</span><span class="n">Zeros</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//modelãƒ–ãƒ­ãƒƒã‚¯ï¼šãƒ¢ãƒ‡ãƒ«ã‚’å®šç¾©
</span><span class="c1"></span><span class="n">model</span><span class="p">{</span>
  <span class="n">matrix</span><span class="p">[</span><span class="n">N</span><span class="p">,</span><span class="n">K</span><span class="p">]</span> <span class="n">mu</span><span class="p">;</span>
  <span class="n">mu</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">beta</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="n">n</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">N</span><span class="p">){</span>
    <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">~</span> <span class="n">categorical_logit</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//generated quantitiesãƒ–ãƒ­ãƒƒã‚¯ï¼šç”Ÿæˆé‡ã‚’å®šç¾© ã“ã“ã§ã¯ç¢ºç‡ã«é–¢ã™ã‚‹äºˆæ¸¬å€¤mu_newã¨ã‚ªãƒƒã‚ºæ¯”ã®å¤‰é‡exp(b)ã‚’ç”Ÿæˆ
</span><span class="c1"></span><span class="n">generated</span> <span class="n">quantities</span><span class="p">{</span>
  <span class="n">matrix</span><span class="p">[</span><span class="n">D</span><span class="p">,</span> <span class="n">K</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="n">ratio</span><span class="p">;</span><span class="c1">//ã‚ªãƒƒã‚ºæ¯”ã®å¤‰é‡
</span><span class="c1"></span>  <span class="n">vector</span><span class="p">[</span><span class="n">K</span><span class="p">]</span> <span class="n">pred</span><span class="p">[</span><span class="n">N_new</span><span class="p">];</span><span class="c1">//äºˆæ¸¬ç‚¹ã«ãŠã„ã¦å„programãŒé¸ã°ã‚Œã‚‹ç¢ºç‡
</span><span class="c1"></span>  <span class="n">matrix</span><span class="p">[</span><span class="n">N_new</span><span class="p">,</span> <span class="n">K</span><span class="p">]</span> <span class="n">mu_new</span><span class="p">;</span>
  <span class="n">mu_new</span> <span class="o">=</span> <span class="n">x_new</span> <span class="o">*</span> <span class="n">beta</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="n">n</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">N_new</span><span class="p">){</span>
    <span class="n">pred</span><span class="p">[</span><span class="n">n</span><span class="p">,]</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">mu_new</span><span class="p">[</span><span class="n">n</span><span class="p">,]);</span>
  <span class="p">}</span>
  <span class="n">ratio</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>parameterãƒ–ãƒ­ãƒƒã‚¯ã§æŒ‡å®šã—ãŸä¿‚æ•°$b$ã®è¡Œç•ªå·ãƒ»åˆ—ç•ªå·ã®çµ„ã¿åˆã‚ã›ãŒã€å…ˆã»ã©å®šç¾©ã—ãŸãƒ¢ãƒ‡ãƒ«å¼ã«ãŠã‘ã‚‹ä¿‚æ•°ã®ä¿®é£¾ç•ªå·ã«ä¸€è‡´ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€$b[1,2]$ã¯ãƒ¢ãƒ‡ãƒ«å¼ã«ãŠã‘ã‚‹$b_{12}$ã«å¯¾å¿œã—ã¾ã™ã€‚</p>
<p><code>Categorical_logit()</code>ã¯Stanã«å®Ÿè£…ã•ã‚ŒãŸä¾¿åˆ©ãªé–¢æ•°ã§ã€Stanå†…éƒ¨ã§softmaxã‚’å®Ÿè¡Œã—ã¦ãã‚Œã¾ã™ã€‚
ã¤ã¾ã‚Šã€<code>y[n] ~ categorical_logit(mu[n]')</code>ã¨<code>y[n] ~ Categorical(softmax(mu[n]'))</code>ã¯ã¨ã‚‚ã«ä»¥ä¸‹ã«ç¤ºã™å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ãã‚Œã¾ã™ã€‚</p>
<p>$$y[n] \sim \rm{Categorical}(\rm{softmax}(mu[n]))$$</p>
<p>(æ³¨ï¼šä¸Šã«ç¤ºã—ãŸå®Ÿè£…ã§ã¯ã‚³ãƒ¼ãƒ‰è¡¨ç¾ã®éƒ½åˆä¸Š<code>categorical_logit()</code>ã¨<code>softmax()</code>ã®å¼•æ•°ã‚’ãã‚Œãã‚Œ<code>mu[n]</code>ã€<code>mu_new[n,]</code>ã¨ã—ã¦ã„ã¾ã™ãŒã€<code>softmax()</code>ã¯åˆ—ãƒ™ã‚¯ãƒˆãƒ«ã«ã—ã‹å¯¾å¿œã—ã¦ã„ãªã„ã®ã§ã€å®Ÿè£…ã§ã¯å¿…ãšãƒ™ã‚¯ãƒˆãƒ«ã‚„è¡Œåˆ—ã‚’è»¢ç½®ã•ã›ã‚‹å‘½ä»¤ã§ã‚ã‚‹<code>'</code>ã‚’å¼•æ•°ã®å¾Œã‚ã«ã¤ã‘ã¦ãã ã•ã„ï¼)</p>
<p>ã“ã®éƒ¨åˆ†ã«ã¤ã„ã¦ã‚‚ã†å°‘ã—è£œè¶³ã™ã‚‹ã¨ã€
$$
P(y[n] = 1) = \rm{softmax}(mu[n,])[1]
$$
$$
P(y[n] = 2) = \rm{softmax}(mu[n,2])[2]
$$
$$
P(y[n] = 3) = \rm{softmax}(mu[n,3])[3]
$$
ã¨ã„ã†é–¢ä¿‚ã«ãªã£ã¦ã„ã¾ã™ã€‚
ã“ã“ã§ã¯$beta[,1] = 0$ã¨ã™ã‚‹ã“ã¨ã§$mu[,1] = 0$ã¨ã—ã€
ã¾ãŸãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢ã«ãŠã„ã¦$academic \rightarrow 1,~~~general \rightarrow 2,~~~vocation \rightarrow 3$ã¨ã—ã¦ã„ã‚‹ã®ã§ã€ä»¥ä¸‹ã®é€šã‚Š$P(y[n] = 1(academic))$ã«ã¤ã„ã¦å›ºå®šãƒ»åŸºæº–åŒ–ã—ã¦ã„ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚</p>
<p>$$
P(y[n] = 1(academic)) = \cfrac{1}{\sum_{k=1}^K \exp(mu[n,k])}
$$</p>
<p>ã¾ãŸã€ä¸Šè¨˜ã®å®Ÿè£…ã§ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®bã«äº‹å‰åˆ†å¸ƒã‚’æŒ‡å®šã—ã¦ã„ã¾ã›ã‚“ãŒã€Stanã§ã¯äº‹å‰åˆ†å¸ƒã‚’æŒ‡å®šã—ãªã„å ´åˆã€ååˆ†ã«å¹…ã®åºƒã„ä¸€æ§˜åˆ†å¸ƒãŒè‡ªå‹•ã§è¨­å®šã•ã‚Œã¾ã™ã€‚
<!-- raw HTML omitted -->ãã®ãŸã‚ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«é–¢ã™ã‚‹äº‹å‰ã®è¨­å®šè¦ä»¶ãŒç„¡ã„å ´åˆã¯ã€äº‹å‰åˆ†å¸ƒã«ä½•ã‚‚æŒ‡å®šã—ãªãã¦ã‚‚ç„¡æƒ…å ±äº‹å‰åˆ†å¸ƒãŒè¨­å®šã•ã‚Œã‚‹ãŸã‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚</p>
<p>model1ã«åŸºã¥ã„ã¦ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚’å‘½ä»¤ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="c1">#(run_model1)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">rstan</span><span class="p">)</span>
<span class="n">x</span> <span class="o">&lt;-</span> <span class="n">d[</span><span class="p">,</span><span class="nf">c</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">)</span><span class="n">]</span>
<span class="n">y</span> <span class="o">&lt;-</span> <span class="n">d[</span><span class="p">,</span><span class="s">&#34;progid&#34;</span><span class="n">]</span>
<span class="n">K</span> <span class="o">&lt;-</span> <span class="m">3</span>
<span class="n">N</span> <span class="o">&lt;-</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">D</span> <span class="o">&lt;-</span> <span class="nf">ncol</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x_new</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">123</span><span class="p">),</span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">41</span><span class="p">),</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">41</span><span class="p">),</span><span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">41</span><span class="p">)),</span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">82</span><span class="p">),</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">41</span><span class="p">)),</span> <span class="n">write</span> <span class="o">=</span> <span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">30</span><span class="o">:</span><span class="m">70</span><span class="p">),</span><span class="m">3</span><span class="p">))</span>
<span class="n">N_new</span> <span class="o">&lt;-</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">x_new</span><span class="p">)</span>

<span class="n">fit0</span> <span class="o">&lt;-</span> <span class="nf">stan</span><span class="p">(</span><span class="n">file</span> <span class="o">=</span> <span class="s">&#34;model1.stan&#34;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="n">K</span><span class="o">=</span><span class="n">K</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">D</span><span class="o">=</span><span class="n">D</span><span class="p">,</span><span class="n">x_new</span><span class="o">=</span><span class="n">x_new</span><span class="p">,</span><span class="n">N_new</span><span class="o">=</span><span class="n">N_new</span><span class="p">),</span> <span class="n">seed</span><span class="o">=</span><span class="m">123</span><span class="p">,</span> <span class="n">war</span><span class="o">=</span><span class="m">500</span><span class="p">,</span> <span class="n">iter</span><span class="o">=</span><span class="m">1500</span><span class="p">,</span> <span class="n">chains</span> <span class="o">=</span> <span class="m">4</span><span class="p">)</span>
</code></pre></div><p><code>rstan::stan()</code>ã®å¼•æ•°ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãŠãã¾ã™ã€‚</p>
<ul>
<li>fileï¼šstanãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š</li>
<li>dataï¼šå¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¹ãƒˆå‹ã§æŒ‡å®š</li>
<li>warï¼š warm upæœŸé–“ã‚’æŒ‡å®š</li>
<li>iterï¼šwaru upæœŸé–“ã‚’å«ã‚“ã chainã®é•·ã•(iteration)ã‚’æŒ‡å®š</li>
<li>chainï¼šchainæ•°ã‚’æŒ‡å®š</li>
<li>seedï¼šä¹±æ•°ã®ç¨®é¡ã‚’æŒ‡å®š</li>
</ul>
<p>$x_{new}$ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®MCMCã‚µãƒ³ãƒ—ãƒ«ã«ã‚‚ã¨ã¥ã„ã¦
$$
P(y[n_{new}]=1),~P(y[n_{new}]=2),~P(y[n_{new}]=3),~~~~n_{new}=1,\ldots,N_{new}
$$
ã®äºˆæ¸¬å€¤ã‚’ç®—å‡ºã™ã‚‹éš›ã«ã€èª¬æ˜å¤‰æ•°$x$ãŒã¨ã‚‹çµ„ã¿åˆã‚ã›ã‚’æŒ‡å®šã—ãŸã‚‚ã®ã§ã™ã€‚
<!-- raw HTML omitted -->
äºˆæ¸¬å€¤ã¯ã€MCMCã§ã¯ç”Ÿæˆé‡ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã¨ã—ã¦æ‰±ã†ãŸã‚ã€generated quantitiesãƒ–ãƒ­ãƒƒã‚¯ã§æŒ‡å®šã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚</p>
<h1 id="çµæœã®ç¢ºèª">çµæœã®ç¢ºèª</h1>
<h2 id="mcmcã®åæŸã®ç¢ºèª">MCMCã®åæŸã®ç¢ºèª</h2>
<p>MCMCã®å®Ÿè¡Œå¾Œã€ã¾ãšã¯ã¡ã‚ƒã‚“ã¨åæŸã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä»¥ä¸‹ã§ã¯ãƒ¢ãƒ‡ãƒ«ã®ä¿‚æ•°ã«ã¤ã„ã¦tracsplotã‚’æç”»ã—ã€åæŸã®ç¢ºèªã‚’è¡Œã„ã¾ã™ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">library</span><span class="p">(</span><span class="n">ggmcmc</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">bayesplot</span><span class="p">)</span>
<span class="n">posterior_fit0_1</span> <span class="o">&lt;-</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">extract</span><span class="p">(</span><span class="n">fit0</span><span class="p">,</span> <span class="n">inc_warmup</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">permuted</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="nf">color_scheme_set</span><span class="p">(</span><span class="s">&#34;mix-blue-pink&#34;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="nf">mcmc_trace</span><span class="p">(</span><span class="n">posterior_fit0_1</span><span class="p">,</span> <span class="n">regex_pars</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;b&#34;</span><span class="p">),</span> <span class="n">n_warmup</span> <span class="o">=</span> <span class="m">500</span><span class="p">,</span>
                <span class="n">facet_args</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">ncol</span> <span class="o">=</span> <span class="m">2</span><span class="p">))</span><span class="o">+</span> <span class="nf">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="o">=</span><span class="m">12</span><span class="p">)</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s">&#34;bottom&#34;</span><span class="p">)</span>
<span class="n">p</span>
</code></pre></div><p><img src="/r/multinom-rstan/fit0_mcmc_trace.png" alt=""></p>
<p>ã©ã®ä¿‚æ•°ã‚‚æ—©ã„æ®µéšã§ä¸€ã¤ã®å€¤ã«åæŸã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚ã“ã“ã§ã¯warm upã‚’500ã«è¨­å®šã—ã¦ã„ã¾ã™ãŒã€ååˆ†ã™ãã‚‹warm up ã§ã‚ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚</p>
<p>MCMCã®åæŸã‚’ç¢ºèªã™ã‚‹æ–¹æ³•ã¯tracsplotã‚’ç”¨ã„ãŸè¦–è¦šçš„ãªåˆ¤æ–­ã ã‘ã§ãªãã€æ•°å€¤åŸºæº–ã‚‚ç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">options</span><span class="p">(</span><span class="n">max.print</span> <span class="o">=</span> <span class="m">80</span><span class="p">)</span>
<span class="n">fit0</span>

<span class="c1">## Inference for Stan model: model1.</span>
<span class="c1">## 4 chains, each with iter=1500; warmup=500; thin=1;</span>
<span class="c1">## post-warmup draws per chain=1000, total post-warmup draws=4000.</span>
<span class="c1">##</span>
<span class="c1">##                  mean se_mean     sd    2.5%     25%     50%     75%   97.5%</span>
<span class="c1">## b[1,1]           2.89    0.03   1.16    0.62    2.11    2.90    3.66    5.12</span>
<span class="c1">## b[1,2]           5.36    0.03   1.13    3.17    4.61    5.32    6.14    7.57</span>
<span class="c1">## b[2,1]          -0.54    0.01   0.45   -1.41   -0.83   -0.53   -0.24    0.33</span>
<span class="c1">## b[2,2]           0.32    0.01   0.48   -0.64    0.00    0.31    0.64    1.28</span>
<span class="c1">## b[3,1]          -1.19    0.01   0.52   -2.27   -1.53   -1.19   -0.84   -0.19</span>
<span class="c1">## b[3,2]          -1.01    0.01   0.59   -2.21   -1.40   -1.00   -0.61    0.12</span>
<span class="c1">## b[4,1]          -0.06    0.00   0.02   -0.10   -0.07   -0.06   -0.04   -0.02</span>
<span class="c1">## b[4,2]          -0.12    0.00   0.02   -0.16   -0.13   -0.12   -0.10   -0.08</span>
<span class="c1">##               n_eff Rhat</span>
<span class="c1">## b[1,1]         2022    1</span>
<span class="c1">## b[1,2]         1934    1</span>
<span class="c1">## b[2,1]         2701    1</span>
<span class="c1">## b[2,2]         2579    1</span>
<span class="c1">## b[3,1]         2835    1</span>
<span class="c1">## b[3,2]         2514    1</span>
<span class="c1">## b[4,1]         2122    1</span>
<span class="c1">## b[4,2]         1978    1</span>
<span class="c1">##  [ reached getOption(&#34;max.print&#34;) -- 759 è¡Œã‚’ç„¡è¦–ã—ã¾ã—ãŸ ]</span>
<span class="c1">##</span>
<span class="c1">## Samples were drawn using NUTS(diag_e) at Sun May 31 00:51:09 2020.</span>
<span class="c1">## For each parameter, n_eff is a crude measure of effective sample size,</span>
<span class="c1">## and Rhat is the potential scale reduction factor on split chains (at</span>
<span class="c1">## convergence, Rhat=1).</span>
</code></pre></div><p>R consoleä¸Šã§fit0ã®ä¸­èº«ã‚’ç¢ºèªã™ã‚‹ã¨ã€å„MCMCã‚µãƒ³ãƒ—ãƒ«ã®è¦ç´„çµ±è¨ˆé‡ã®ä»–ã«n-effã€RhatãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚</p>
<p><strong>n-eff</strong>
<!-- raw HTML omitted --> <br>
StanãŒè‡ªå·±ç›¸é–¢ç­‰ã‹ã‚‰åˆ¤æ–­ã—ãŸå®Ÿè¡Œã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºã§ã™ã€‚ã‚ã‚‹æ›¸ç±ã«ã¯åˆ†å¸ƒã®æ¨å®šãƒ»çµ±è¨ˆé‡ã®ç®—å‡ºã®ãŸã‚ã«100ç¨‹åº¦ä»¥ä¸Šã‚ã‚‹ã“ã¨ãŒæœ›ã¾ã—ã„ã¨ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚
<!-- raw HTML omitted -->  <br>
æ¨™æœ¬è‡ªå·±ç›¸é–¢ãŒãƒ©ã‚°ã‚’å¤§ããã—ã¦ã‚‚ãªã‹ãªã‹æ¸›è¡°ã—ãªã„å ´åˆã€MCMCã‚µãƒ³ãƒ—ãƒ«ã¯éå»ã®å€¤ã«é•·ãä¾å­˜ã—ã¦ãŠã‚Šã€ä¸å¤‰åˆ†å¸ƒã§ã‚ã‚‹äº‹å¾Œåˆ†å¸ƒã«é–¢ã™ã‚‹æ¨è«–ã«ã¯åŠ¹ç‡ãŒæ‚ªã„ã€ã¨ã„ã†ã“ã¨ã®ã‚ˆã†ã§ã™ã€‚Stané–‹ç™ºè€…ã¯<a href="https://mc-stan.org/docs/2_21/reference-manual/effective-sample-size-section.html">ã“ã¡ã‚‰ã®ãƒšãƒ¼ã‚¸</a>ã§n-effã®å®šç¾©ã‚’ã—ã¦ã„ã¾ã™ã€‚ç§ã‚‚ã¾ã ã¡ã‚ƒã‚“ã¨èª­ã‚“ã§ã„ãªã„ã®ã§ã„ã¤ã‹èª­ã¿ãŸã„ã§ã™ã€‚</p>
<p><strong>Rhat($\hat{R}$)</strong>
<!-- raw HTML omitted --> <br>
ã“ã¡ã‚‰ã¯MCMCãŒåæŸã—ãŸã‹ã‚’è¡¨ã™ä¸€ã¤ã®æŒ‡æ¨™ã§ã™ã€‚
<!-- raw HTML omitted -->  <br>
Rhatã«ã¤ã„ã¦ã¯å°‘ã—è©³ã—ãç´¹ä»‹ã—ã¦ãŠãã¾ã™ã€‚
<!-- raw HTML omitted --><br>
ã„ã¾chainæ•°ã‚’$M$ã€iterationã‚’$n$ã¨ã—ã€chainæ¯ã«$n$å€‹ã®æ¨™æœ¬$\theta^{(i,t)}$ã‚’ç™ºç”Ÿã•ã›ãŸã¨ã—ã¾ã™$(i=1,2,\ldots,M,~~t=1,2,\ldots,n)$ã€‚
<!-- raw HTML omitted --> <br>
ã“ã®ã¨ãã€$g(\theta^{(i,t)})$ã®åˆ†æ•£$\sigma_g^2$ã¯ã€</p>
<p>$$
\tilde{\sigma}^2_{BW} = \cfrac{(n-1)\tilde{\sigma}^2_w + \tilde{\sigma}^2_B}{n}
$$
$$
\tilde{\sigma}^2_{W} = \cfrac{1}{M} \sum_{i=1}^M s^2_{g_i}, ~~~~
s^2_{g_i} = \cfrac{\sum_{t=1}^n ((g(\theta^{(i,t)}))-\bar{g}_i)^2}{n-1}
$$
$$
\tilde{\sigma}^2_B = n\cfrac{\sum_{i=1}^M (\bar{g}_i-\check{g})}{M-1},~~~~
\bar{g}_i = \cfrac{1}{n}\sum_{t=1}^n g(\theta^{(i,t)}),~~~~
\check{g} = \cfrac{1}{M} \sum^M_{i=1} \bar{g}_i
$$</p>
<p>ã®$\tilde{\sigma}^2_{BW},~ \tilde{\sigma}^2_{W}, ~ \tilde{\sigma}^2_B$ã®ã„ãšã‚Œã§ã‚‚æ¨å®šã§ãã¾ã™ã€‚</p>
<p>MCMCæ¨™æœ¬ã®è‡ªå·±ç›¸é–¢ãŒé«˜ãã€ä¸å¤‰åˆ†å¸ƒã§ã‚ã‚‹äº‹å¾Œåˆ†å¸ƒã¸ã®åæŸãŒé…ã„å ´åˆã€$s^2_{g_i}$(=1chainå†…ã®ä¸ååˆ†æ•£)ã¯çœŸã®åˆ†æ•£$\sigma^2_g$ã‚ˆã‚Šã‚‚å°ã•ããªã‚Šã€ã—ãŸãŒã£ã¦$\tilde{\sigma}^2_{W}$($s^2_{g_i}$ã®å¹³å‡)ã‚‚å°ã•ããªã‚Šã¾ã™ã€‚
<!-- raw HTML omitted -->  <br>
ä¸€æ–¹ã€å„é€£é–ã®å‹•ããŒç·©æ…¢ã§äº‹å¾Œåˆ†å¸ƒã®ä¸€éƒ¨ã§ã—ã‹ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ãªã„ã¨ãã¯ã€$\tilde{\sigma}^2_B/n$(=å„chainã®æ¨™æœ¬å¹³å‡ã®ä¸ååˆ†æ•£)ãŒå¤§ãããªã‚Šã€ã—ãŸãŒã£ã¦$\tilde{\sigma}^2_B$ã‚‚å¤§ãããªã‚Šã¾ã™ã€‚</p>
<p>ãã“ã§ã€ä¸‹è¨˜å¼ã§$\hat{R}$ã‚’å®šç¾©ã™ã‚‹ã¨ã€$\hat{R}$ãŒ1ã«è¿‘ã„ã‹ã©ã†ã‹ã§MCMCã®åæŸã‚’åˆ¤æ–­ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚Galman(1996)ã¯$\hat{R}$ãŒ1.1~1.2ä»¥ä¸‹ã«ãªã‚Œã°åæŸã—ãŸã¨å®Ÿç”¨ä¸Šè€ƒãˆã¦ã‚ˆã„ã¨ã—ã¦ã„ã‚‹ãã†ã§ã™ã€‚</p>
<p>$$
\hat{R} = \cfrac{\tilde{\sigma}^2_{BW}}{\tilde{\sigma}^2_{W}}
$$</p>
<p>ä»Šå›ã¯å…¨ä¿‚æ•°ã§RhatãŒ1ã§ã™ã®ã§ã€MCMCã¯åæŸã—ãŸã¨åˆ¤æ–­ã—ã¾ã™ã€‚</p>
<h2 id="ãƒ¢ãƒ‡ãƒ«ã®ä¿‚æ•°ã«ç€ç›®">ãƒ¢ãƒ‡ãƒ«ã®ä¿‚æ•°ã«ç€ç›®</h2>
<p>R consoleä¸Šã§fit0ã®ä¸­èº«ã‚’ç¢ºèªã—ãŸã¨ãã€ä¿‚æ•°ã®è¦ç´„çµ±è¨ˆé‡ãŒä»¥ä¸‹ã®ã‚ˆã†ã«ç®—å‡ºã•ã‚Œã¦ã„ã¾ã—ãŸã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">options</span><span class="p">(</span><span class="n">max.print</span> <span class="o">=</span> <span class="m">80</span><span class="p">)</span>
<span class="n">fit0</span>

<span class="c1">## ï½çœç•¥ï½</span>
<span class="c1">##</span>
<span class="c1">##                  mean se_mean     sd    2.5%     25%     50%     75%   97.5%</span>
<span class="c1">## b[1,1]           2.89    0.03   1.16    0.62    2.11    2.90    3.66    5.12</span>
<span class="c1">## b[1,2]           5.36    0.03   1.13    3.17    4.61    5.32    6.14    7.57</span>
<span class="c1">## b[2,1]          -0.54    0.01   0.45   -1.41   -0.83   -0.53   -0.24    0.33</span>
<span class="c1">## b[2,2]           0.32    0.01   0.48   -0.64    0.00    0.31    0.64    1.28</span>
<span class="c1">## b[3,1]          -1.19    0.01   0.52   -2.27   -1.53   -1.19   -0.84   -0.19</span>
<span class="c1">## b[3,2]          -1.01    0.01   0.59   -2.21   -1.40   -1.00   -0.61    0.12</span>
<span class="c1">## b[4,1]          -0.06    0.00   0.02   -0.10   -0.07   -0.06   -0.04   -0.02</span>
<span class="c1">## b[4,2]          -0.12    0.00   0.02   -0.16   -0.13   -0.12   -0.10   -0.08</span>
</code></pre></div><p>äº‹å¾Œåˆ†å¸ƒã®ä»£è¡¨å€¤ã¨ã—ä¸Šã®ä¸­å¤®å€¤(50%åˆ—ã®å€¤)ã‚‚ç”¨ã„ã‚‰ã‚Œã¾ã™ãŒã€ã“ã“ã§ã¯æœ€å°¤æ³•ã«ã‚ˆã‚‹çµæœã¨ã®æ•´åˆæ€§ã‚’ç¢ºèªã™ã‚‹ãŸã‚MAPæ¨å®šå€¤ã‚‚ç®—å‡ºã—ã¦ã¿ã¾ã™ã€‚
äº‹å¾Œåˆ†å¸ƒã®MAPæ¨å®šå€¤ãŒæœ€å°¤æ¨å®šã«ã‚ˆã‚‹çµæœã¨ç†è«–çš„ã«ä¸€è‡´ã™ã‚‹ã“ã¨ã«ã¤ã„ã¦ã¯<a href="https://rmorita-stat.github.io/2020/05/bayesintroduction/">ä»¥å‰ã®è¨˜äº‹</a>ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">b_MAP</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">posterior_fit0_2</span><span class="o">$</span><span class="n">b</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span>
<span class="n">mode_x</span> <span class="o">&lt;-</span> <span class="nf">density</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">$</span><span class="n">x</span><span class="nf">[which.max</span><span class="p">(</span><span class="nf">density</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">$</span><span class="n">y</span><span class="p">)</span><span class="n">]</span>
<span class="p">})</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">b_MAP</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;general&#34;</span><span class="p">,</span><span class="s">&#34;vocation&#34;</span><span class="p">)</span>
<span class="nf">t</span><span class="p">(</span><span class="n">b_MAP</span><span class="p">)</span>

<span class="c1">##           Intercept  sesmiddle   seshigh       write</span>
<span class="c1">##  general   2.898204 -0.5127911 -1.224067 -0.05841702</span>
<span class="c1">##  vocation  5.059521  0.2740113 -1.028054 -0.11497210</span>
</code></pre></div><p>ä¸€æ–¹ã€ä»¥å‰ã®è¨˜äº‹ã§multinom()ã‚’ç”¨ã„ã¦åŒã˜åˆ†æã‚’è¡Œã£ãŸçµæœãŒä»¥ä¸‹ã§ã™ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="c1">## Call:</span>
<span class="c1">## multinom(formula = prog2 ~ ses + write, data = ml)</span>
<span class="c1">##</span>
<span class="c1">## Coefficients:</span>
<span class="c1">##          (Intercept)  sesmiddle    seshigh      write</span>
<span class="c1">## general     2.852198 -0.5332810 -1.1628226 -0.0579287</span>
<span class="c1">## vocation    5.218260  0.2913859 -0.9826649 -0.1136037</span>
<span class="c1">##</span>
<span class="c1">## Std. Errors:</span>
<span class="c1">##          (Intercept) sesmiddle   seshigh      write</span>
<span class="c1">## general     1.166441 0.4437323 0.5142196 0.02141097</span>
<span class="c1">## vocation    1.163552 0.4763739 0.5955665 0.02221996</span>
<span class="c1">##</span>
<span class="c1">## Residual Deviance: 359.9635</span>
<span class="c1">## AIC: 375.9635</span>

<span class="c1">## ä¸¡å´Zæ¤œå®šã®å®Ÿè¡Œ</span>
<span class="n">z</span> <span class="o">&lt;-</span> <span class="nf">summary</span><span class="p">(</span><span class="n">test</span><span class="p">)</span><span class="o">$</span><span class="n">coefficients</span><span class="o">/</span><span class="nf">summary</span><span class="p">(</span><span class="n">test</span><span class="p">)</span><span class="o">$</span><span class="n">standard.errors</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="m">1</span> <span class="o">-</span> <span class="nf">pnorm</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">z</span><span class="p">),</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>
<span class="n">p</span>

<span class="c1">##           (Intercept) sesmiddle    seshigh        write</span>
<span class="c1">## general  7.238305e-03 0.1147190 0.01186928 3.409451e-03</span>
<span class="c1">## vocation 3.649650e-06 0.2703765 0.04947488 1.588023e-07</span>
</code></pre></div><p>äº‹å¾Œåˆ†å¸ƒã®MAPæ¨å®šå€¤ã¨multinom()ã«ã‚ˆã‚‹çµæœã®coefficients:ã‚’æ¯”è¼ƒã—ã¦ã¿ã‚‹ã¨ã€ãŠãŠã‚ˆãä¸€è‡´ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚å¤šå°‘ã®ãšã‚Œã¯ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­èª¤å·®ãªã©ã®å½±éŸ¿ã®ç¯„å›²å†…ã¨è€ƒãˆã¾ã™ã€‚
ã“ã®ã“ã¨ã‹ã‚‰ã€æœ€å°¤æ¨å®šã«åŸºã¥ãæ–¹æ³•ã¨ãƒ™ã‚¤ã‚ºçµ±è¨ˆã‹ã‚‰ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®æ•´åˆæ€§ãŒç¢ºèªã§ãã¾ã—ãŸã€‚</p>
<p>multinom()ã®éš›ã«ã¯æœ‰æ„å·®æ¤œå®šã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã—ãŸã®ã§ã€ä»Šå›ã‚‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒ0ã‚ˆã‚Šå¤§ãã„(å°ã•ã„)ç¢ºç‡(<strong>Bayesian p-value</strong>)ã‚’ç®—å‡ºã—ã¦ãŠãã¾ã™ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">posterior_fit0_2</span> <span class="o">&lt;-</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">extract</span><span class="p">(</span><span class="n">fit0</span><span class="p">)</span>

<span class="n">p_coef</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">posterior_fit0_2</span><span class="o">$</span><span class="n">b</span><span class="p">,</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span>
  <span class="nf">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">)</span><span class="o">/</span><span class="nf">length</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="p">})</span>
<span class="nf">rownames</span><span class="p">(</span><span class="n">p_coef</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;Intercept&#34;</span><span class="p">,</span><span class="s">&#34;sesmiddle&#34;</span><span class="p">,</span><span class="s">&#34;seshigh&#34;</span><span class="p">,</span><span class="s">&#34;write&#34;</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">p_coef</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;general&#34;</span><span class="p">,</span><span class="s">&#34;vocation&#34;</span><span class="p">)</span>
<span class="nf">t</span><span class="p">(</span><span class="n">p_coef</span><span class="p">)</span>

<span class="c1">##            </span>
<span class="c1">##           Intercept sesmiddle seshigh  write</span>
<span class="c1">##  general    0.99325   0.11125   0.009 0.0015</span>
<span class="c1">##  vocation   1.00000   0.74550   0.041 0.0000</span>
</code></pre></div><p>ä»¥ä¸Šã®çµæœã®è§£é‡ˆã¯multinom()ã®æ™‚ã‚ˆã‚Šç›´æ„Ÿçš„ã§ã€ä¾‹ãˆã°$b_{14}$ã«ç€ç›®ã™ã‚‹ã¨ã€</p>
<ul>
<li>$b_{14}$ã¯95%ã®ç¢ºç‡ã§-0.10ã‹ã‚‰-0.02ã®å€¤ã‚’ã¨ã‚‹ã€‚ã¾ãŸä¸­å¤®å€¤ã¯-0.06ã§ã‚ã‚‹ã€‚</li>
<li>$b_{14}$ãŒ0ã‚ˆã‚Šã‚‚å¤§ãã„ç¢ºç‡ã¯0.15%ã§ã‚ã‚‹</li>
</ul>
<p>ã¨ã„ã†ã‚ˆã†ã«è§£é‡ˆã§ãã¾ã™ã€‚</p>
<p>ã“ã‚Œã‚’çŸ¥ã£ãŸã‹ã‚ãã¡ã®æ„Ÿæƒ³ãŒä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚</p>
<p><strong>multinom()ã®æ™‚ã¨æ¯”ã¹ã¦ãšã£ã¨åˆ†ã‹ã‚Šã‚„ã™ããªã„ã§ã™ã‹ï¼Ÿï¼Ÿï¼ğŸ¢</strong></p>
<p>å…¨çµæœã‚’æ•°å¼ã§è¡¨ç¾ã—ã¦ãŠãã¾ã™(Bayesian p-valueã«åŸºã¥ã„ã¦$^{***}$ï¼š0.1%æœ‰æ„ã€$^{**}$ï¼š1%æœ‰æ„ã€$^{*}$ï¼š5%æœ‰æ„)ã€‚</p>
<p>$$
\cfrac{P(prog=general)}{P(prog=academic)} = \rm{exp}(2.90^{***}-0.53(ses=middle) -1.19^{**}(ses=high) - 0.06^{**}write)
$$</p>
<p>$$
\cfrac{P(prog=vocation)}{P(prog=academic)} = \rm{exp}(5.32^{***}-0.31(ses=middle); -1.00^{*}(ses=high) - 0.12^{***}write)
$$</p>
<h2 id="ã‚ªãƒƒã‚ºæ¯”ã®å¤‰é‡ã«ç€ç›®">ã‚ªãƒƒã‚ºæ¯”ã®å¤‰é‡ã«ç€ç›®</h2>
<p>ã‚ªãƒƒã‚ºæ¯”ã®å¤‰é‡(èª¬æ˜å¤‰æ•°ãŒå¤‰åŒ–ã™ã‚‹ã¨ã€ã‚ªãƒƒã‚ºæ¯”ã¯ä½•å€ã«ãªã‚‹ã‹)ã«ã¤ã„ã¦ã‚‚ç¢ºèªã—ã¦ãŠãã¾ã™ã€‚ã“ã¡ã‚‰ã¯äº‹å¾Œåˆ†å¸ƒã®è¦ç´„çµ±è¨ˆé‡ã§ã¯ãªãã€äº‹å¾Œåˆ†å¸ƒè‡ªä½“ã‚’è¦–è¦šçš„ã«è¦‹ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚ã¾ãŸé€šå¸¸åˆ‡ç‰‡é …ã¯è§£é‡ˆã«ç”¨ã„ãªã„ãŸã‚ã€å›³ã®æç”»ã§ã¯å‰²æ„›ã—ã¾ã™ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">plot_title</span> <span class="o">&lt;-</span> <span class="nf">ggtitle</span><span class="p">(</span><span class="s">&#34;Posterior distribution&#34;</span><span class="p">,</span> <span class="s">&#34;with medians and 95% intervals&#34;</span><span class="p">)</span>

<span class="nf">mcmc_areas</span><span class="p">(</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">fit0</span><span class="p">),</span>
           <span class="n">pars</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;ratio[2,1]&#34;</span><span class="p">,</span><span class="s">&#34;ratio[3,1]&#34;</span><span class="p">,</span><span class="s">&#34;ratio[4,1]&#34;</span><span class="p">,</span><span class="s">&#34;ratio[2,2]&#34;</span><span class="p">,</span><span class="s">&#34;ratio[3,2]&#34;</span><span class="p">,</span><span class="s">&#34;ratio[4,2]&#34;</span><span class="p">),</span><span class="n">prob</span><span class="o">=</span><span class="m">0.95</span><span class="p">,</span> <span class="n">area_method</span> <span class="o">=</span> <span class="s">&#34;equal height&#34;</span><span class="p">)</span> <span class="o">+</span>
           <span class="n">plot_title</span><span class="o">+</span> <span class="nf">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="o">=</span><span class="m">12</span><span class="p">)</span>
</code></pre></div><p><img src="/r/multinom-rstan/fit0_mcmc_density.png" alt=""></p>
<p>ä¸Šå›³ã®äº‹å¾Œåˆ†å¸ƒã«è¡¨ç¾ã•ã‚ŒãŸä¸­å¤®å€¤ã€95%ä¿¡é ¼åŒºé–“ã‚’ä¸‹ã§ç®—å‡ºã—ã¦ãŠãã¾ã™ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">ratio_median</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">posterior_fit0_2</span><span class="o">$</span><span class="n">ratio</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="n">median</span><span class="p">)</span>
<span class="n">ratio_quant</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">posterior_fit0_2</span><span class="o">$</span><span class="n">ratio</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="n">quantile</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.025</span><span class="p">,</span> <span class="m">0.975</span><span class="p">))</span>
<span class="n">ratio_general</span> <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="n">ratio_median[</span><span class="p">,</span><span class="m">1</span><span class="n">]</span><span class="p">,</span> <span class="n">ratio_quant[</span><span class="p">,,</span><span class="m">1</span><span class="n">]</span><span class="p">)</span>
<span class="n">ratio_vocation</span> <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="n">ratio_median[</span><span class="p">,</span><span class="m">2</span><span class="n">]</span><span class="p">,</span><span class="n">ratio_quant[</span><span class="p">,,</span><span class="m">2</span><span class="n">]</span><span class="p">)</span>
<span class="nf">rownames</span><span class="p">(</span><span class="n">ratio_general</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">rownames</span><span class="p">(</span><span class="n">ratio_vocation</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;median&#34;</span><span class="p">,</span><span class="s">&#34;2.5%&#34;</span><span class="p">,</span><span class="s">&#34;97.5%&#34;</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">ratio_general</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">colnames</span><span class="p">(</span><span class="n">ratio_vocation</span><span class="p">)</span> <span class="o">&lt;-</span>  <span class="nf">c</span><span class="p">(</span><span class="s">&#34;Intercept&#34;</span><span class="p">,</span><span class="s">&#34;sesmiddle&#34;</span><span class="p">,</span><span class="s">&#34;seshigh&#34;</span><span class="p">,</span><span class="s">&#34;write&#34;</span><span class="p">)</span>
<span class="n">ratio_odds</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span><span class="n">general</span> <span class="o">=</span> <span class="n">ratio_general</span><span class="p">,</span> <span class="n">vocation</span><span class="o">=</span><span class="n">ratio_vocation</span><span class="p">)</span>

<span class="nf">show</span><span class="p">(</span><span class="n">ratio_odds</span><span class="p">)</span>

<span class="c1">## $general</span>
<span class="c1">##        Intercept sesmiddle   seshigh     write</span>
<span class="c1">## median  18.08714 0.5897972 0.3041684 0.9428201</span>
<span class="c1">## 2.5%     1.85266 0.2434086 0.1037669 0.9051025</span>
<span class="c1">## 97.5%  166.69899 1.3964119 0.8242418 0.9836004</span>
<span class="c1">##</span>
<span class="c1">## $vocation</span>
<span class="c1">##         Intercept sesmiddle   seshigh     write</span>
<span class="c1">## median  204.48713  1.369324 0.3678701 0.8901682</span>
<span class="c1">## 2.5%     23.69682  0.527517 0.1092642 0.8515944</span>
<span class="c1">## 97.5%  1940.58136  3.594567 1.1219872 0.9260589</span>
</code></pre></div><p>ä¸Šå›³ã§ä¸€ç•ªç›®ç«‹ã¤$ratio[2,2]$ã«ç€ç›®ã™ã‚‹ã¨ã€ã“ã‚Œã¯$\exp(b_{22})$ã§ã™ã®ã§ã€
$$
\cfrac{\cfrac{P(prog=vocation(ses=middle))}{P(prog=academic(ses=middle))}}{\cfrac{P(prog=vocation(ses=low))}{P(prog=academic(ses=low))}}
$$
ã®äº‹å¾Œåˆ†å¸ƒã‚’è¡¨ç¾ã—ã¦ã„ã¾ã™ã€‚
äº‹å¾Œåˆ†å¸ƒã¯95%ãƒ™ã‚¤ã‚ºä¿¡é ¼åŒºé–“å†…ã«1ã‚’å«ã‚“ã§ã„ã¾ã™ã—ã€æ¯”è¼ƒçš„å¹…ãŒåºƒã„åˆ†å¸ƒã§ã™ã®ã§ã€ç¢ºä¿¡ã‚’ã‚‚ã£ã¦ã“ã†ã ã¨ã„ãˆã‚‹çµæœãŒå¾—ã‚‰ã‚Œã¦ã„ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚</p>
<p>ä¸€æ–¹ã§ã€$ratio[3,1]=\exp(b_{21})$ã¯å¹…ãŒæ¯”è¼ƒçš„ç‹­ãã€95%ãƒ™ã‚¤ã‚ºä¿¡é ¼åŒºé–“å†…ã«1ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã“ã®ã“ã¨ã‹ã‚‰ã€
$$
\cfrac{\cfrac{P(prog=general(ses=high))}{P(prog=academic(ses=high))}}{\cfrac{P(prog=general(ses=low))}{P(prog=academic(ses=low))}}
$$
ã¯ã‚ˆã‚Šç¢ºä¿¡ã‚’ã‚‚ã£ã¦1ä»¥ä¸‹ã®ä»£è¡¨å€¤(MAPæ¨å®šå€¤ã‚„ä¸­å¤®å€¤)ä»˜è¿‘ã‚’ã¨ã‚‹ã€ã¨ã„ã†ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
<p>ã“ã®ã‚ˆã†ã«ã€ãƒ™ã‚¤ã‚ºçµ±è¨ˆã§ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚„æ±‚ã‚ãŸã„å€¤ã®ã¨ã‚Šã†ã‚‹åˆ†å¸ƒã‚’æ¨å®šã™ã‚‹ã“ã¨ãŒã§ãã€å¤§å¤‰ä¾¿åˆ©ã§ã™ã€‚</p>
<h1 id="çµæœã®æç”»">çµæœã®æç”»</h1>
<p>æœ€å¾Œã«çµæœ(ç¢ºç‡ã«é–¢ã™ã‚‹äºˆæ¸¬å€¤ã®åˆ†å¸ƒ)ã®æç”»ã‚’è¡Œã„ã¾ã™ã€‚ä»¥ä¸‹ã§ã¯å„programãŒé¸ã°ã‚Œã‚‹ç¢ºç‡ã‚’ã€äº‹å¾Œåˆ†å¸ƒã®ä¸­å¤®å€¤ã‚’äºˆæ¸¬å€¤ã¨ã—ã¦ã€50%ãƒ™ã‚¤ã‚ºä¿¡é ¼åŒºé–“ã¨ã¨ã‚‚ã«ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">RColorBrewer</span><span class="p">)</span>

<span class="n">p25</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">posterior_fit0_2</span><span class="o">$</span><span class="n">pred</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="n">quantile</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.25</span><span class="p">))</span>
<span class="n">p50</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">posterior_fit0_2</span><span class="o">$</span><span class="n">pred</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="n">median</span><span class="p">)</span>
<span class="n">p75</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">posterior_fit0_2</span><span class="o">$</span><span class="n">pred</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="n">quantile</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.75</span><span class="p">))</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">p25</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;academic&#34;</span><span class="p">,</span><span class="s">&#34;general&#34;</span><span class="p">,</span><span class="s">&#34;vocation&#34;</span><span class="p">),</span><span class="s">&#34;_p25&#34;</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">p50</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;academic&#34;</span><span class="p">,</span><span class="s">&#34;general&#34;</span><span class="p">,</span><span class="s">&#34;vocation&#34;</span><span class="p">),</span><span class="s">&#34;_p50&#34;</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">p75</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;academic&#34;</span><span class="p">,</span><span class="s">&#34;general&#34;</span><span class="p">,</span><span class="s">&#34;vocation&#34;</span><span class="p">),</span><span class="s">&#34;_p75&#34;</span><span class="p">)</span>
<span class="n">data1</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">ses</span> <span class="o">=</span> <span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;low&#34;</span><span class="p">,</span><span class="s">&#34;middle&#34;</span><span class="p">,</span><span class="s">&#34;high&#34;</span><span class="p">),</span><span class="n">each</span> <span class="o">=</span> <span class="m">41</span><span class="p">),</span> <span class="n">write</span> <span class="o">=</span> <span class="n">x_new[</span><span class="p">,</span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">)</span><span class="n">]</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">p50[</span><span class="p">,</span><span class="s">&#34;academic_p50&#34;</span><span class="n">]</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">p75[</span><span class="p">,</span><span class="s">&#34;academic_p75&#34;</span><span class="n">]</span><span class="p">,</span>
                    <span class="n">ymin</span><span class="o">=</span><span class="n">p25[</span><span class="p">,</span><span class="s">&#34;academic_p25&#34;</span><span class="n">]</span><span class="p">,</span> <span class="n">facet</span><span class="o">=</span><span class="s">&#34;academic&#34;</span><span class="p">)</span>
<span class="n">data2</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">ses</span> <span class="o">=</span> <span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;low&#34;</span><span class="p">,</span><span class="s">&#34;middle&#34;</span><span class="p">,</span><span class="s">&#34;high&#34;</span><span class="p">),</span><span class="n">each</span> <span class="o">=</span> <span class="m">41</span><span class="p">),</span> <span class="n">write</span> <span class="o">=</span> <span class="n">x_new[</span><span class="p">,</span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">)</span><span class="n">]</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">p50[</span><span class="p">,</span><span class="s">&#34;general_p50&#34;</span><span class="n">]</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">p75[</span><span class="p">,</span><span class="s">&#34;general_p75&#34;</span><span class="n">]</span><span class="p">,</span>
                    <span class="n">ymin</span><span class="o">=</span><span class="n">p25[</span><span class="p">,</span><span class="s">&#34;general_p25&#34;</span><span class="n">]</span><span class="p">,</span> <span class="n">facet</span><span class="o">=</span><span class="s">&#34;general&#34;</span><span class="p">)</span>
<span class="n">data3</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">ses</span> <span class="o">=</span> <span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;low&#34;</span><span class="p">,</span><span class="s">&#34;middle&#34;</span><span class="p">,</span><span class="s">&#34;high&#34;</span><span class="p">),</span><span class="n">each</span> <span class="o">=</span> <span class="m">41</span><span class="p">),</span> <span class="n">write</span> <span class="o">=</span> <span class="n">x_new[</span><span class="p">,</span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">)</span><span class="n">]</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">p50[</span><span class="p">,</span><span class="s">&#34;vocation_p50&#34;</span><span class="n">]</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">p75[</span><span class="p">,</span><span class="s">&#34;vocation_p75&#34;</span><span class="n">]</span><span class="p">,</span>
                    <span class="n">ymin</span><span class="o">=</span><span class="n">p25[</span><span class="p">,</span><span class="s">&#34;vocation_p25&#34;</span><span class="n">]</span><span class="p">,</span> <span class="n">facet</span><span class="o">=</span><span class="s">&#34;vocation&#34;</span><span class="p">)</span>


<span class="n">cols</span> <span class="o">=</span> <span class="n">RColorBrewer</span><span class="o">::</span><span class="nf">brewer.pal</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="s">&#34;Dark2&#34;</span><span class="p">)</span>

<span class="n">data_point</span> <span class="o">&lt;-</span> <span class="n">ml</span> <span class="o">%&gt;%</span> <span class="nf">cbind</span><span class="p">(</span><span class="n">makedummies</span><span class="o">::</span><span class="nf">makedummies</span><span class="p">(</span><span class="n">ml</span><span class="p">,</span><span class="n">basal_level</span> <span class="o">=</span> <span class="bp">T</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s">&#34;prog&#34;</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="nf">select</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">prog</span><span class="p">,</span> <span class="n">prog_academic</span><span class="p">,</span> <span class="n">prog_general</span><span class="p">,</span> <span class="n">prog_vocation</span><span class="p">))</span>

<span class="n">p0</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">()</span> <span class="o">+</span> <span class="nf">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="o">=</span><span class="m">11</span><span class="p">)</span> <span class="o">+</span> <span class="nf">mapply</span><span class="p">(</span>
  <span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">){</span>
    <span class="nf">geom_ribbon</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">write</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="n">ymin</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">ses</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span>
  <span class="p">},</span><span class="nf">list</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span><span class="n">data2</span><span class="p">,</span><span class="n">data3</span><span class="p">)</span>
<span class="p">)</span> <span class="o">+</span><span class="nf">mapply</span><span class="p">(</span>
  <span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">){</span>
    <span class="nf">geom_line</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">write</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="n">ses</span><span class="p">))</span>
  <span class="p">},</span><span class="nf">list</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span><span class="n">data2</span><span class="p">,</span><span class="n">data3</span><span class="p">)</span>
<span class="p">)</span> <span class="o">+</span> <span class="nf">mapply</span><span class="p">(</span>
  <span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">n</span><span class="p">){</span>
  <span class="nf">geom_jitter</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">write</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">data[</span><span class="p">,</span><span class="n">n]</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="n">ses</span><span class="p">),</span><span class="n">height</span><span class="o">=</span><span class="m">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="m">0.8</span><span class="p">)</span>
<span class="p">},</span><span class="nf">list</span><span class="p">(</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">data_point</span><span class="p">,</span> <span class="n">facet</span><span class="o">=</span><span class="s">&#34;academic&#34;</span><span class="p">),</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">data_point</span><span class="p">,</span> <span class="n">facet</span><span class="o">=</span><span class="s">&#34;general&#34;</span><span class="p">),</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">data_point</span><span class="p">,</span> <span class="n">facet</span><span class="o">=</span><span class="s">&#34;vocation&#34;</span><span class="p">)),</span>
  <span class="nf">list</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="m">5</span><span class="p">,</span><span class="m">6</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">facet_grid</span><span class="p">(</span><span class="n">facet</span><span class="o">~</span><span class="n">.)</span> <span class="o">+</span> <span class="nf">scale_colour_manual</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span> <span class="o">+</span> <span class="nf">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s">&#34;bottom&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">ylab</span><span class="p">(</span><span class="s">&#34;Probability&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">labs</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s">&#34;With Rstan&#34;</span><span class="p">)</span>

<span class="n">p0</span>
</code></pre></div><p><img src="/r/multinom-rstan/fit0_mcmc_res.png" alt=""></p>
<p>multinom()ã«ã‚ˆã‚‹åˆ†æã®éš›ã«æç”»ã—ãŸå›³ã‚’ä¸‹ã«è¼‰ã›ã¾ã™ãŒã€ã“ã®2ã¤ã®çµæœã¯ã»ã¼ä¸€è‡´ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚</p>
<p><img src="/r/multinom-rstan/multinom.png" alt=""></p>
<h1 id="ã¾ã¨ã‚">ã¾ã¨ã‚</h1>
<p>æœ¬è¨˜äº‹ã§ã¯å¤šé …ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ã‚’Rstanã‚’ç”¨ã„ã¦å®Ÿè¡Œã—ã€æœ€å°¤æ³•(multinom())ã«ã‚ˆã‚‹çµæœã¨ã®æ¯”è¼ƒã‚’è¡Œã„ã€ãƒã‚¤ãƒãƒ³ãƒ»ãƒ”ã‚¢ã‚½ãƒ³å‹çµ±è¨ˆã¨ãƒ™ã‚¤ã‚ºçµ±è¨ˆã®é•ã„ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚</p>
<p>ä¸¡è€…ãŒã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯å®Ÿè³ªçš„ã«ã¯å¤‰ã‚ã‚Šã‚ã‚Šã¾ã›ã‚“ãŒã€è§£é‡ˆã®é•ã„ãªã©ã«ã¤ã„ã¦ã¯å®Ÿæ„Ÿã§ããŸã‹ã¨æ€ã„ã¾ã™ã€‚</p>
<p>ä»Šå¾Œã€ä»Šå›ã®å®Ÿè£…ã«ã•ã‚‰ã«æ”¹è‰¯ã‚’åŠ ãˆã€äºˆæ¸¬ç”¨ã®ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚</p>

        </article>
    </div>
    <div class="main-content__tags u-font">
        
        
        <span><a href="https://rmorita-stat.github.io/tags/%E5%9B%9E%E5%B8%B0">å›å¸°</a></span>
        
        <span><a href="https://rmorita-stat.github.io/tags/rstan">rstan</a></span>
        
        
    </div>
</div>
<div class="disqus-comments">
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-rmorita-stat-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
<div class="main-profile">
    <div class="main-profile__avatar">
        
    </div>
    <div class="main-profile__body">
        <div class="main-profile__author">
            
            <span> R.morita </span>
            
        </div>
        <div class="main-profile__description">
            
            <p> å¾—æ„ãªã®ã¯çµ±ä¸€ã•ã‚ŒãŸæ´‹æœã¨ãƒ€ãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã™ </p>
            
        </div>
    </div>
</div>
<div class="main-line"></div>
<div class="main-pn">
    
    <a class="previous" href="https://rmorita-stat.github.io/r/multinom/multinom/">
        <div class="pn-dec"></div>
        <div class="pn-els">
            <div class="pn-el__1"> 2020.05.27 21:13 </div>
            <div class="pn-el__2"> multinom()ã‚’ä½¿ã£ãŸå¤šé …ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸° </div>
        </div>
    </a>
    
    
    <a class="next" href="https://rmorita-stat.github.io/r/gaussianprocess/gaussianprocess/">
        <div class="pn-dec"></div>
        <div class="pn-els">
            <div class="pn-el__1"> 2020.06.14 00:00 </div>
            <div class="pn-el__2"> ã‚¬ã‚¦ã‚¹éç¨‹å…¥é–€ </div>
        </div>
    </a>
    
</div>

<footer>
  <script type="text/javascript">
 MathJax = {
   tex: {
     inlineMath: [['$','$'], ['\\(','\\)']],
     processEscapes: true,
     tags: "ams",
     autoload: {
       color: [],
       colorV2: ['color']
     },
     packages: {'[+]': ['noerrors']}
   },
   chtml: {
     matchFontHeight: true,
     displayAlign: "left",
     displayIndent: "2em"
   },
   options: {
     skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
     renderActions: {
        
       find_script_mathtex: [10, function (doc) {
         for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
           const display = !!node.type.match(/; *mode=display/);
           const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
           const text = document.createTextNode('');
           node.parentNode.replaceChild(text, node);
           math.start = {node: text, delim: '', n: 0};
           math.end = {node: text, delim: '', n: 0};
           doc.math.push(math);
         }
       }, '']
     }
   },
   loader: {
     load: ['[tex]/noerrors']
   }
 };
</script>
<script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script"></script>
</footer>

</div>
<div class="footer">
    <div class="copyright-wrap">
        <p class="copyright u-font">
            
            &#169;
            2021
            
            <a href="https://github.com/Rmorita-stat/doc" target="_blank">R.morita&#46;</a>
            Theme <a href="https://github.com/iCyris/hugo-theme-yuki" target="_blank">yuki</a>&#46;
            Powered by Hugo&#46;
            
            
        </p>
    </div>
</div>
</body>
<script src="https://rmorita-stat.github.io/js/page.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

