<!DOCTYPE html>
<html>
<head>
    <meta name="google-site-verification" content="qrt5G5NouQQVS-0Ss9qHlEuMYt3uKuifbUIOkPd4cPc" />
    <meta charset="utf-8">
    <title>
        
        SUCRE HECACHA
        
    </title>
    <meta name="viewport" id="viewport" content="width=device-width, initial-scale=1">
    <link rel='icon' type='image/x-icon' href="https://rmorita-stat.github.io/images/logo2.png" />
    <link rel="apple-touch-icon" href="https://rmorita-stat.github.io/images/logo2.png"><link rel="stylesheet" href="https://rmorita-stat.github.io/scss/style.css">
    
    <link rel="stylesheet" href="https://rmorita-stat.github.io/css/syntax.css">
    <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
    <script src="https://rmorita-stat.github.io/js/highlight.min.js"></script>
    <link rel="stylesheet" href="https://rmorita-stat.github.io/scss/highlight.css">
    
    <link rel="stylesheet" href="https://rmorita-stat.github.io/scss/custom.css">
    
    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'Your Google Analytics tracking id', 'auto');
        ga('send', 'pageview');
    </script>
    
    
    <meta name="generator" content="Hugo 0.71.0" /></head>


<body>
<div class="header">
    <div class="site-logo__wrap">
        <div id="site-button">
            <div></div>
        </div>
        
        <div class=' site-logo '>
            <a href="https://rmorita-stat.github.io/"><img src="https://rmorita-stat.github.io/images/logo.png" /></a>
        </div>
    </div>
    
<div class=' site-nav u-font ' id="nav-bar">
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="/" >HOME</a>
    </div>
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="/stat" >STAT</a>
    </div>
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="/r" >With R</a>
    </div>
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="/julia" >With Julia</a>
    </div>
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="/about" >ABOUT</a>
    </div>
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="/tags/" >TAGS</a>
    </div>
    
</div>

</div>
<div class="main">

<div class="main-content">
    <div class="main-content__date">
        <h4 id="date"> 2020.05.31 00:00 </h4>
    </div>
    <div class="main-content__title">
        <h1 id="title">rstanを使った多項ロジスティック回帰</h1>
    </div>
    <div class="main-content__article">
        <article id="content">
            <h1 id="はじめに">はじめに</h1>
<p><strong>回帰</strong>に関する記事です。本記事では<a href="https://rmorita-stat.github.io/2020/05/multinom/">以前の記事</a>で扱った多項ロジスティック回帰を<strong>rstan</strong>で実行します。</p>
<p>本記事の構成は以下の通りとします。</p>
<!-- raw HTML omitted -->
<ul>
<li><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">はじめに</a></li>
<li><a href="#%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E7%A2%BA%E8%AA%8D">モデルの確認</a></li>
<li><a href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%85%A5%E6%89%8B%E3%83%BB%E6%95%B4%E5%BD%A2">データの入手・整形</a></li>
<li><a href="#stan%E3%81%AB%E3%82%88%E3%82%8B%E5%A4%9A%E9%A0%85%E3%83%AD%E3%82%B8%E3%82%B9%E3%83%86%E3%82%A3%E3%83%83%E3%82%AF%E5%9B%9E%E5%B8%B0%E3%81%AE%E5%AE%9F%E8%A3%85">Stanによる多項ロジスティック回帰の実装</a></li>
<li><a href="#%E7%B5%90%E6%9E%9C%E3%81%AE%E7%A2%BA%E8%AA%8D">結果の確認</a>
<ul>
<li><a href="#mcmc%E3%81%AE%E5%8F%8E%E6%9D%9F%E3%81%AE%E7%A2%BA%E8%AA%8D">MCMCの収束の確認</a></li>
<li><a href="#%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E4%BF%82%E6%95%B0%E3%81%AB%E7%9D%80%E7%9B%AE">モデルの係数に着目</a></li>
<li><a href="#%E3%82%AA%E3%83%83%E3%82%BA%E6%AF%94%E3%81%AE%E5%A4%89%E9%87%8F%E3%81%AB%E7%9D%80%E7%9B%AE">オッズ比の変量に着目</a></li>
</ul>
</li>
<li><a href="#%E7%B5%90%E6%9E%9C%E3%81%AE%E6%8F%8F%E7%94%BB">結果の描画</a></li>
<li><a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a></li>
</ul>
<!-- raw HTML omitted -->
<h1 id="モデルの確認">モデルの確認</h1>
<p>以前の記事でも紹介した多項ロジスティック回帰モデルの一般式を再掲します。
<!-- raw HTML omitted --><br>
従属変数$Y$、説明変数$X$について、$Y = (y_1,\ldots,y_n,\ldots, y_N)^T$、$X = (x_1,\ldots, x_n,\ldots, x_N)^T$とし、さらに
$x_n = (x_{1n},\ldots,x_{dn},\ldots, x_{Dn})$としたとき、多項ロジスティック回帰のモデル式は以下になります。$N$はサンプルサイズ、$D$は説明変数の次元です。</p>
<p>$$
\mu_n = \overrightarrow{a} + \overrightarrow{b_1}x_{n1} + \cdots + \overrightarrow{b_d}x_{nd} + \cdots + \overrightarrow{b_D}x_{nD}
$$
$$
\theta_n = \rm{softmax}(\mu_n)
$$
$$
y_n \sim \rm{Categorical}(\theta_n)
$$
$$
(n=1,\ldots,N)
$$</p>
<p>ここで
$$
\mu=(\mu_1,\ldots,\mu_n,\ldots,\mu_N)
$$
$$
\theta=(\theta_1,\ldots,\theta_n,\ldots,\theta_N)
$$</p>
<p>$\mu_n, \theta_n,\overrightarrow{a},\overrightarrow{b_1},\ldots,\overrightarrow{b_D}$は長さ$K$のベクトルです。</p>
<h1 id="データの入手整形">データの入手・整形</h1>
<p><a href="https://rmorita-stat.github.io/2020/05/multinom/">以前の記事</a>でも扱ったデータを用います。今回もprog(200人の生徒がgeneral、vocation、academicの3つの授業から選んだ授業)を従属変数とし、ses(家庭の経済状況)、write(書く力)を従属変数とします。</p>
<p>以下の通りStanに指定するデータに整形していきます。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">library</span><span class="p">(</span><span class="n">makedummies</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">foreign</span><span class="p">)</span>

<span class="n">ml</span> <span class="o">&lt;-</span> <span class="nf">read.dta</span><span class="p">(</span><span class="s">&#34;https://stats.idre.ucla.edu/stat/data/hsbdemo.dta&#34;</span><span class="p">)</span>

<span class="c1">## progの3引数を数字に置き換えるための表を作成</span>
<span class="n">progid</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">)</span>
<span class="nf">names</span><span class="p">(</span><span class="n">progid</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;academic&#34;</span><span class="p">,</span><span class="s">&#34;general&#34;</span><span class="p">,</span><span class="s">&#34;vocation&#34;</span><span class="p">)</span>

<span class="c1">## makedummies()はsesに対してダミー変数を作成するために使用</span>
<span class="c1">## interceptは切片項</span>
<span class="n">d</span> <span class="o">&lt;-</span> <span class="n">ml</span> <span class="o">%&gt;%</span> <span class="nf">cbind</span><span class="p">(</span><span class="n">makedummies</span><span class="o">::</span><span class="nf">makedummies</span><span class="p">(</span><span class="n">ml</span><span class="p">,</span><span class="n">basal_level</span> <span class="o">=</span> <span class="bp">F</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s">&#34;ses&#34;</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">progid</span> <span class="o">=</span> <span class="n">progid</span><span class="nf">[paste</span><span class="p">(</span><span class="n">prog</span><span class="p">)</span><span class="n">]</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">select</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">ses_middle</span><span class="p">,</span> <span class="n">ses_high</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">progid</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="nf">cbind</span><span class="p">(</span><span class="n">intercept</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="nf">nrow</span><span class="p">(</span><span class="n">ml</span><span class="p">)))</span>

<span class="nf">head</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="m">10</span><span class="p">)</span>

<span class="c1">##    ses_middle ses_high write progid intercept</span>
<span class="c1">## 1           0        0    35      3         1</span>
<span class="c1">## 2           1        0    33      2         1</span>
<span class="c1">## 3           0        1    39      3         1</span>
<span class="c1">## 4           0        0    37      3         1</span>
<span class="c1">## 5           1        0    31      3         1</span>
<span class="c1">## 6           0        1    36      2         1</span>
<span class="c1">## 7           1        0    36      3         1</span>
<span class="c1">## 8           1        0    31      3         1</span>
<span class="c1">## 9           1        0    41      3         1</span>
<span class="c1">## 10          1        0    37      3         1</span>

</code></pre></div><p>ここで、本データ用に設定したモデル式における係数の呼称を以下の通り定義しておきます。</p>
<p>$$\cfrac{P(prog=general)}{P(prog=academic)} = \exp(b_{11} + b_{21}(ses=middle) + b_{31}(ses=high) + b_{41}write)$$</p>
<p>$$\cfrac{P(prog=vocation)}{P(prog=academic)} = \exp(b_{12} + b_{22}(ses=middle) + b_{32}(ses=high) + b_{42}write)$$</p>
<h1 id="stanによる多項ロジスティック回帰の実装">Stanによる多項ロジスティック回帰の実装</h1>
<p>多項ロジスティック回帰を実行するStanコードは以下のようになります。</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="c1">//(model1.stan)
</span><span class="c1">//dataブロック：データを指定
</span><span class="c1"></span><span class="n">data</span><span class="p">{</span>
  <span class="kt">int</span><span class="o">&lt;</span><span class="n">lower</span><span class="o">=</span><span class="mi">2</span><span class="o">&gt;</span> <span class="n">K</span><span class="p">;</span> <span class="c1">//カテゴリ数
</span><span class="c1"></span>  <span class="kt">int</span><span class="o">&lt;</span><span class="n">lower</span><span class="o">=</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">N</span><span class="p">;</span> <span class="c1">//サンプルサイズ
</span><span class="c1"></span>  <span class="kt">int</span><span class="o">&lt;</span><span class="n">lower</span><span class="o">=</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">D</span><span class="p">;</span> <span class="c1">//データ項目数+切片項の数（１）
</span><span class="c1"></span>  <span class="kt">int</span><span class="o">&lt;</span><span class="n">lower</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">K</span><span class="o">&gt;</span> <span class="n">y</span><span class="p">[</span><span class="n">N</span><span class="p">];</span> <span class="c1">//prog
</span><span class="c1"></span>  <span class="n">matrix</span><span class="p">[</span><span class="n">N</span><span class="p">,</span><span class="n">D</span><span class="p">]</span> <span class="n">x</span><span class="p">;</span> <span class="c1">//説明変数と切片項
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">N_new</span><span class="p">;</span> <span class="c1">//予測点の数
</span><span class="c1"></span>  <span class="n">matrix</span><span class="p">[</span><span class="n">N_new</span><span class="p">,</span><span class="n">D</span><span class="p">]</span> <span class="n">x_new</span><span class="p">;</span> <span class="c1">//予測点群
</span><span class="c1"></span><span class="p">}</span>

<span class="c1">//transformed dataブロック：新しくデータを生成 ここではmuの区別化の為の0ベクトルを生成
</span><span class="c1"></span><span class="n">transformed</span> <span class="n">data</span><span class="p">{</span>
  <span class="n">vector</span><span class="p">[</span><span class="n">D</span><span class="p">]</span> <span class="n">Zeros</span><span class="p">;</span>
  <span class="n">Zeros</span> <span class="o">=</span> <span class="n">rep_vector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">D</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//parameterブロック：パラメータを定義
</span><span class="c1"></span><span class="n">parameters</span><span class="p">{</span>
  <span class="n">matrix</span><span class="p">[</span><span class="n">D</span><span class="p">,</span> <span class="n">K</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//transformed parameterブロック：parameterブロックで指定したパラメータを変形 ここでは0ベクトルと結合
</span><span class="c1"></span><span class="n">transformed</span> <span class="n">parameters</span><span class="p">{</span>
  <span class="n">matrix</span><span class="p">[</span><span class="n">D</span><span class="p">,</span><span class="n">K</span><span class="p">]</span> <span class="n">beta</span><span class="p">;</span>
  <span class="n">beta</span> <span class="o">=</span> <span class="n">append_col</span><span class="p">(</span><span class="n">Zeros</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//modelブロック：モデルを定義
</span><span class="c1"></span><span class="n">model</span><span class="p">{</span>
  <span class="n">matrix</span><span class="p">[</span><span class="n">N</span><span class="p">,</span><span class="n">K</span><span class="p">]</span> <span class="n">mu</span><span class="p">;</span>
  <span class="n">mu</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">beta</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="n">n</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">N</span><span class="p">){</span>
    <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">~</span> <span class="n">categorical_logit</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//generated quantitiesブロック：生成量を定義 ここでは確率に関する予測値mu_newとオッズ比の変量exp(b)を生成
</span><span class="c1"></span><span class="n">generated</span> <span class="n">quantities</span><span class="p">{</span>
  <span class="n">matrix</span><span class="p">[</span><span class="n">D</span><span class="p">,</span> <span class="n">K</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="n">ratio</span><span class="p">;</span><span class="c1">//オッズ比の変量
</span><span class="c1"></span>  <span class="n">vector</span><span class="p">[</span><span class="n">K</span><span class="p">]</span> <span class="n">pred</span><span class="p">[</span><span class="n">N_new</span><span class="p">];</span><span class="c1">//予測点において各programが選ばれる確率
</span><span class="c1"></span>  <span class="n">matrix</span><span class="p">[</span><span class="n">N_new</span><span class="p">,</span> <span class="n">K</span><span class="p">]</span> <span class="n">mu_new</span><span class="p">;</span>
  <span class="n">mu_new</span> <span class="o">=</span> <span class="n">x_new</span> <span class="o">*</span> <span class="n">beta</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="n">n</span> <span class="n">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">N_new</span><span class="p">){</span>
    <span class="n">pred</span><span class="p">[</span><span class="n">n</span><span class="p">,]</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">mu_new</span><span class="p">[</span><span class="n">n</span><span class="p">,]);</span>
  <span class="p">}</span>
  <span class="n">ratio</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>parameterブロックで指定した係数$b$の行番号・列番号の組み合わせが、先ほど定義したモデル式における係数の修飾番号に一致します。例えば、$b[1,2]$はモデル式における$b_{12}$に対応します。</p>
<p><code>Categorical_logit()</code>はStanに実装された便利な関数で、Stan内部でsoftmaxを実行してくれます。
つまり、<code>y[n] ~ categorical_logit(mu[n]')</code>と<code>y[n] ~ Categorical(softmax(mu[n]'))</code>はともに以下に示す処理を実行してくれます。</p>
<p>$$y[n] \sim \rm{Categorical}(\rm{softmax}(mu[n]))$$</p>
<p>(注：上に示した実装ではコード表現の都合上<code>categorical_logit()</code>と<code>softmax()</code>の引数をそれぞれ<code>mu[n]</code>、<code>mu_new[n,]</code>としていますが、<code>softmax()</code>は列ベクトルにしか対応していないので、実装では必ずベクトルや行列を転置させる命令である<code>'</code>を引数の後ろにつけてください！)</p>
<p>この部分についてもう少し補足すると、
$$
P(y[n] = 1) = \rm{softmax}(mu[n,])[1]
$$
$$
P(y[n] = 2) = \rm{softmax}(mu[n,2])[2]
$$
$$
P(y[n] = 3) = \rm{softmax}(mu[n,3])[3]
$$
という関係になっています。
ここでは$beta[,1] = 0$とすることで$mu[,1] = 0$とし、
またデータの整形において$academic \rightarrow 1,~~~general \rightarrow 2,~~~vocation \rightarrow 3$としているので、以下の通り$P(y[n] = 1(academic))$について固定・基準化していることになります。</p>
<p>$$
P(y[n] = 1(academic)) = \cfrac{1}{\sum_{k=1}^K \exp(mu[n,k])}
$$</p>
<p>また、上記の実装ではパラメータのbに事前分布を指定していませんが、Stanでは事前分布を指定しない場合、十分に幅の広い一様分布が自動で設定されます。
<!-- raw HTML omitted -->そのため、パラメータに関する事前の設定要件が無い場合は、事前分布に何も指定しなくても無情報事前分布が設定されるため問題ありません。</p>
<p>model1に基づいてサンプリングを命令するコードは以下のようになります。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="c1">#(run_model1)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">rstan</span><span class="p">)</span>
<span class="n">x</span> <span class="o">&lt;-</span> <span class="n">d[</span><span class="p">,</span><span class="nf">c</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">)</span><span class="n">]</span>
<span class="n">y</span> <span class="o">&lt;-</span> <span class="n">d[</span><span class="p">,</span><span class="s">&#34;progid&#34;</span><span class="n">]</span>
<span class="n">K</span> <span class="o">&lt;-</span> <span class="m">3</span>
<span class="n">N</span> <span class="o">&lt;-</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">D</span> <span class="o">&lt;-</span> <span class="nf">ncol</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x_new</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">123</span><span class="p">),</span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">41</span><span class="p">),</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">41</span><span class="p">),</span><span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">41</span><span class="p">)),</span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">82</span><span class="p">),</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">41</span><span class="p">)),</span> <span class="n">write</span> <span class="o">=</span> <span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">30</span><span class="o">:</span><span class="m">70</span><span class="p">),</span><span class="m">3</span><span class="p">))</span>
<span class="n">N_new</span> <span class="o">&lt;-</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">x_new</span><span class="p">)</span>

<span class="n">fit0</span> <span class="o">&lt;-</span> <span class="nf">stan</span><span class="p">(</span><span class="n">file</span> <span class="o">=</span> <span class="s">&#34;model1.stan&#34;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="n">K</span><span class="o">=</span><span class="n">K</span><span class="p">,</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">D</span><span class="o">=</span><span class="n">D</span><span class="p">,</span><span class="n">x_new</span><span class="o">=</span><span class="n">x_new</span><span class="p">,</span><span class="n">N_new</span><span class="o">=</span><span class="n">N_new</span><span class="p">),</span> <span class="n">seed</span><span class="o">=</span><span class="m">123</span><span class="p">,</span> <span class="n">war</span><span class="o">=</span><span class="m">500</span><span class="p">,</span> <span class="n">iter</span><span class="o">=</span><span class="m">1500</span><span class="p">,</span> <span class="n">chains</span> <span class="o">=</span> <span class="m">4</span><span class="p">)</span>
</code></pre></div><p><code>rstan::stan()</code>の引数について説明しておきます。</p>
<ul>
<li>file：stanファイルを指定</li>
<li>data：必要なデータをリスト型で指定</li>
<li>war： warm up期間を指定</li>
<li>iter：waru up期間を含んだchainの長さ(iteration)を指定</li>
<li>chain：chain数を指定</li>
<li>seed：乱数の種類を指定</li>
</ul>
<p>$x_{new}$はパラメータのMCMCサンプルにもとづいて
$$
P(y[n_{new}]=1),~P(y[n_{new}]=2),~P(y[n_{new}]=3),~~~~n_{new}=1,\ldots,N_{new}
$$
の予測値を算出する際に、説明変数$x$がとる組み合わせを指定したものです。
<!-- raw HTML omitted -->
予測値は、MCMCでは生成量のサンプリングとして扱うため、generated quantitiesブロックで指定することになります。</p>
<h1 id="結果の確認">結果の確認</h1>
<h2 id="mcmcの収束の確認">MCMCの収束の確認</h2>
<p>MCMCの実行後、まずはちゃんと収束していることを確認する必要があります。
以下ではモデルの係数についてtracsplotを描画し、収束の確認を行います。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">library</span><span class="p">(</span><span class="n">ggmcmc</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">bayesplot</span><span class="p">)</span>
<span class="n">posterior_fit0_1</span> <span class="o">&lt;-</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">extract</span><span class="p">(</span><span class="n">fit0</span><span class="p">,</span> <span class="n">inc_warmup</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">permuted</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="nf">color_scheme_set</span><span class="p">(</span><span class="s">&#34;mix-blue-pink&#34;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="nf">mcmc_trace</span><span class="p">(</span><span class="n">posterior_fit0_1</span><span class="p">,</span> <span class="n">regex_pars</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;b&#34;</span><span class="p">),</span> <span class="n">n_warmup</span> <span class="o">=</span> <span class="m">500</span><span class="p">,</span>
                <span class="n">facet_args</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">ncol</span> <span class="o">=</span> <span class="m">2</span><span class="p">))</span><span class="o">+</span> <span class="nf">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="o">=</span><span class="m">12</span><span class="p">)</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s">&#34;bottom&#34;</span><span class="p">)</span>
<span class="n">p</span>
</code></pre></div><p><img src="/r/multinom-rstan/fit0_mcmc_trace.png" alt=""></p>
<p>どの係数も早い段階で一つの値に収束しているようです。ここではwarm upを500に設定していますが、十分すぎるwarm up であることが確認できます。</p>
<p>MCMCの収束を確認する方法はtracsplotを用いた視覚的な判断だけでなく、数値基準も用意されています。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">options</span><span class="p">(</span><span class="n">max.print</span> <span class="o">=</span> <span class="m">80</span><span class="p">)</span>
<span class="n">fit0</span>

<span class="c1">## Inference for Stan model: model1.</span>
<span class="c1">## 4 chains, each with iter=1500; warmup=500; thin=1;</span>
<span class="c1">## post-warmup draws per chain=1000, total post-warmup draws=4000.</span>
<span class="c1">##</span>
<span class="c1">##                  mean se_mean     sd    2.5%     25%     50%     75%   97.5%</span>
<span class="c1">## b[1,1]           2.89    0.03   1.16    0.62    2.11    2.90    3.66    5.12</span>
<span class="c1">## b[1,2]           5.36    0.03   1.13    3.17    4.61    5.32    6.14    7.57</span>
<span class="c1">## b[2,1]          -0.54    0.01   0.45   -1.41   -0.83   -0.53   -0.24    0.33</span>
<span class="c1">## b[2,2]           0.32    0.01   0.48   -0.64    0.00    0.31    0.64    1.28</span>
<span class="c1">## b[3,1]          -1.19    0.01   0.52   -2.27   -1.53   -1.19   -0.84   -0.19</span>
<span class="c1">## b[3,2]          -1.01    0.01   0.59   -2.21   -1.40   -1.00   -0.61    0.12</span>
<span class="c1">## b[4,1]          -0.06    0.00   0.02   -0.10   -0.07   -0.06   -0.04   -0.02</span>
<span class="c1">## b[4,2]          -0.12    0.00   0.02   -0.16   -0.13   -0.12   -0.10   -0.08</span>
<span class="c1">##               n_eff Rhat</span>
<span class="c1">## b[1,1]         2022    1</span>
<span class="c1">## b[1,2]         1934    1</span>
<span class="c1">## b[2,1]         2701    1</span>
<span class="c1">## b[2,2]         2579    1</span>
<span class="c1">## b[3,1]         2835    1</span>
<span class="c1">## b[3,2]         2514    1</span>
<span class="c1">## b[4,1]         2122    1</span>
<span class="c1">## b[4,2]         1978    1</span>
<span class="c1">##  [ reached getOption(&#34;max.print&#34;) -- 759 行を無視しました ]</span>
<span class="c1">##</span>
<span class="c1">## Samples were drawn using NUTS(diag_e) at Sun May 31 00:51:09 2020.</span>
<span class="c1">## For each parameter, n_eff is a crude measure of effective sample size,</span>
<span class="c1">## and Rhat is the potential scale reduction factor on split chains (at</span>
<span class="c1">## convergence, Rhat=1).</span>
</code></pre></div><p>R console上でfit0の中身を確認すると、各MCMCサンプルの要約統計量の他にn-eff、Rhatが出力されます。</p>
<p><strong>n-eff</strong>
<!-- raw HTML omitted --> <br>
Stanが自己相関等から判断した実行サンプルサイズです。ある書籍には分布の推定・統計量の算出のために100程度以上あることが望ましいと紹介されています。
<!-- raw HTML omitted -->  <br>
標本自己相関がラグを大きくしてもなかなか減衰しない場合、MCMCサンプルは過去の値に長く依存しており、不変分布である事後分布に関する推論には効率が悪い、ということのようです。Stan開発者は<a href="https://mc-stan.org/docs/2_21/reference-manual/effective-sample-size-section.html">こちらのページ</a>でn-effの定義をしています。私もまだちゃんと読んでいないのでいつか読みたいです。</p>
<p><strong>Rhat($\hat{R}$)</strong>
<!-- raw HTML omitted --> <br>
こちらはMCMCが収束したかを表す一つの指標です。
<!-- raw HTML omitted -->  <br>
Rhatについては少し詳しく紹介しておきます。
<!-- raw HTML omitted --><br>
いまchain数を$M$、iterationを$n$とし、chain毎に$n$個の標本$\theta^{(i,t)}$を発生させたとします$(i=1,2,\ldots,M,~~t=1,2,\ldots,n)$。
<!-- raw HTML omitted --> <br>
このとき、$g(\theta^{(i,t)})$の分散$\sigma_g^2$は、</p>
<p>$$
\tilde{\sigma}^2_{BW} = \cfrac{(n-1)\tilde{\sigma}^2_w + \tilde{\sigma}^2_B}{n}
$$
$$
\tilde{\sigma}^2_{W} = \cfrac{1}{M} \sum_{i=1}^M s^2_{g_i}, ~~~~
s^2_{g_i} = \cfrac{\sum_{t=1}^n ((g(\theta^{(i,t)}))-\bar{g}_i)^2}{n-1}
$$
$$
\tilde{\sigma}^2_B = n\cfrac{\sum_{i=1}^M (\bar{g}_i-\check{g})}{M-1},~~~~
\bar{g}_i = \cfrac{1}{n}\sum_{t=1}^n g(\theta^{(i,t)}),~~~~
\check{g} = \cfrac{1}{M} \sum^M_{i=1} \bar{g}_i
$$</p>
<p>の$\tilde{\sigma}^2_{BW},~ \tilde{\sigma}^2_{W}, ~ \tilde{\sigma}^2_B$のいずれでも推定できます。</p>
<p>MCMC標本の自己相関が高く、不変分布である事後分布への収束が遅い場合、$s^2_{g_i}$(=1chain内の不偏分散)は真の分散$\sigma^2_g$よりも小さくなり、したがって$\tilde{\sigma}^2_{W}$($s^2_{g_i}$の平均)も小さくなります。
<!-- raw HTML omitted -->  <br>
一方、各連鎖の動きが緩慢で事後分布の一部でしかサンプリングされていないときは、$\tilde{\sigma}^2_B/n$(=各chainの標本平均の不偏分散)が大きくなり、したがって$\tilde{\sigma}^2_B$も大きくなります。</p>
<p>そこで、下記式で$\hat{R}$を定義すると、$\hat{R}$が1に近いかどうかでMCMCの収束を判断することが出来ます。Galman(1996)は$\hat{R}$が1.1~1.2以下になれば収束したと実用上考えてよいとしているそうです。</p>
<p>$$
\hat{R} = \cfrac{\tilde{\sigma}^2_{BW}}{\tilde{\sigma}^2_{W}}
$$</p>
<p>今回は全係数でRhatが1ですので、MCMCは収束したと判断します。</p>
<h2 id="モデルの係数に着目">モデルの係数に着目</h2>
<p>R console上でfit0の中身を確認したとき、係数の要約統計量が以下のように算出されていました。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">options</span><span class="p">(</span><span class="n">max.print</span> <span class="o">=</span> <span class="m">80</span><span class="p">)</span>
<span class="n">fit0</span>

<span class="c1">## ～省略～</span>
<span class="c1">##</span>
<span class="c1">##                  mean se_mean     sd    2.5%     25%     50%     75%   97.5%</span>
<span class="c1">## b[1,1]           2.89    0.03   1.16    0.62    2.11    2.90    3.66    5.12</span>
<span class="c1">## b[1,2]           5.36    0.03   1.13    3.17    4.61    5.32    6.14    7.57</span>
<span class="c1">## b[2,1]          -0.54    0.01   0.45   -1.41   -0.83   -0.53   -0.24    0.33</span>
<span class="c1">## b[2,2]           0.32    0.01   0.48   -0.64    0.00    0.31    0.64    1.28</span>
<span class="c1">## b[3,1]          -1.19    0.01   0.52   -2.27   -1.53   -1.19   -0.84   -0.19</span>
<span class="c1">## b[3,2]          -1.01    0.01   0.59   -2.21   -1.40   -1.00   -0.61    0.12</span>
<span class="c1">## b[4,1]          -0.06    0.00   0.02   -0.10   -0.07   -0.06   -0.04   -0.02</span>
<span class="c1">## b[4,2]          -0.12    0.00   0.02   -0.16   -0.13   -0.12   -0.10   -0.08</span>
</code></pre></div><p>事後分布の代表値とし上の中央値(50%列の値)も用いられますが、ここでは最尤法による結果との整合性を確認するためMAP推定値も算出してみます。
事後分布のMAP推定値が最尤推定による結果と理論的に一致することについては<a href="https://rmorita-stat.github.io/2020/05/bayesintroduction/">以前の記事</a>を参照してください。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">b_MAP</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">posterior_fit0_2</span><span class="o">$</span><span class="n">b</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span>
<span class="n">mode_x</span> <span class="o">&lt;-</span> <span class="nf">density</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">$</span><span class="n">x</span><span class="nf">[which.max</span><span class="p">(</span><span class="nf">density</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">$</span><span class="n">y</span><span class="p">)</span><span class="n">]</span>
<span class="p">})</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">b_MAP</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;general&#34;</span><span class="p">,</span><span class="s">&#34;vocation&#34;</span><span class="p">)</span>
<span class="nf">t</span><span class="p">(</span><span class="n">b_MAP</span><span class="p">)</span>

<span class="c1">##           Intercept  sesmiddle   seshigh       write</span>
<span class="c1">##  general   2.898204 -0.5127911 -1.224067 -0.05841702</span>
<span class="c1">##  vocation  5.059521  0.2740113 -1.028054 -0.11497210</span>
</code></pre></div><p>一方、以前の記事でmultinom()を用いて同じ分析を行った結果が以下です。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="c1">## Call:</span>
<span class="c1">## multinom(formula = prog2 ~ ses + write, data = ml)</span>
<span class="c1">##</span>
<span class="c1">## Coefficients:</span>
<span class="c1">##          (Intercept)  sesmiddle    seshigh      write</span>
<span class="c1">## general     2.852198 -0.5332810 -1.1628226 -0.0579287</span>
<span class="c1">## vocation    5.218260  0.2913859 -0.9826649 -0.1136037</span>
<span class="c1">##</span>
<span class="c1">## Std. Errors:</span>
<span class="c1">##          (Intercept) sesmiddle   seshigh      write</span>
<span class="c1">## general     1.166441 0.4437323 0.5142196 0.02141097</span>
<span class="c1">## vocation    1.163552 0.4763739 0.5955665 0.02221996</span>
<span class="c1">##</span>
<span class="c1">## Residual Deviance: 359.9635</span>
<span class="c1">## AIC: 375.9635</span>

<span class="c1">## 両側Z検定の実行</span>
<span class="n">z</span> <span class="o">&lt;-</span> <span class="nf">summary</span><span class="p">(</span><span class="n">test</span><span class="p">)</span><span class="o">$</span><span class="n">coefficients</span><span class="o">/</span><span class="nf">summary</span><span class="p">(</span><span class="n">test</span><span class="p">)</span><span class="o">$</span><span class="n">standard.errors</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="m">1</span> <span class="o">-</span> <span class="nf">pnorm</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">z</span><span class="p">),</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>
<span class="n">p</span>

<span class="c1">##           (Intercept) sesmiddle    seshigh        write</span>
<span class="c1">## general  7.238305e-03 0.1147190 0.01186928 3.409451e-03</span>
<span class="c1">## vocation 3.649650e-06 0.2703765 0.04947488 1.588023e-07</span>
</code></pre></div><p>事後分布のMAP推定値とmultinom()による結果のcoefficients:を比較してみると、おおよそ一致していることがわかります。多少のずれはモンテカルロ誤差などの影響の範囲内と考えます。
このことから、最尤推定に基づく方法とベイズ統計からのアプローチの整合性が確認できました。</p>
<p>multinom()の際には有意差検定を実行していましたので、今回もパラメータが0より大きい(小さい)確率(<strong>Bayesian p-value</strong>)を算出しておきます。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">posterior_fit0_2</span> <span class="o">&lt;-</span> <span class="n">rstan</span><span class="o">::</span><span class="nf">extract</span><span class="p">(</span><span class="n">fit0</span><span class="p">)</span>

<span class="n">p_coef</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">posterior_fit0_2</span><span class="o">$</span><span class="n">b</span><span class="p">,</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span>
  <span class="nf">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">)</span><span class="o">/</span><span class="nf">length</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="p">})</span>
<span class="nf">rownames</span><span class="p">(</span><span class="n">p_coef</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;Intercept&#34;</span><span class="p">,</span><span class="s">&#34;sesmiddle&#34;</span><span class="p">,</span><span class="s">&#34;seshigh&#34;</span><span class="p">,</span><span class="s">&#34;write&#34;</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">p_coef</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;general&#34;</span><span class="p">,</span><span class="s">&#34;vocation&#34;</span><span class="p">)</span>
<span class="nf">t</span><span class="p">(</span><span class="n">p_coef</span><span class="p">)</span>

<span class="c1">##            </span>
<span class="c1">##           Intercept sesmiddle seshigh  write</span>
<span class="c1">##  general    0.99325   0.11125   0.009 0.0015</span>
<span class="c1">##  vocation   1.00000   0.74550   0.041 0.0000</span>
</code></pre></div><p>以上の結果の解釈はmultinom()の時より直感的で、例えば$b_{14}$に着目すると、</p>
<ul>
<li>$b_{14}$は95%の確率で-0.10から-0.02の値をとる。また中央値は-0.06である。</li>
<li>$b_{14}$が0よりも大きい確率は0.15%である</li>
</ul>
<p>というように解釈できます。</p>
<p>これを知ったかめきちの感想が以下になります。</p>
<p><strong>multinom()の時と比べてずっと分かりやすくないですか？？＞🐢</strong></p>
<p>全結果を数式で表現しておきます(Bayesian p-valueに基づいて$^{***}$：0.1%有意、$^{**}$：1%有意、$^{*}$：5%有意)。</p>
<p>$$
\cfrac{P(prog=general)}{P(prog=academic)} = \rm{exp}(2.90^{***}-0.53(ses=middle) -1.19^{**}(ses=high) - 0.06^{**}write)
$$</p>
<p>$$
\cfrac{P(prog=vocation)}{P(prog=academic)} = \rm{exp}(5.32^{***}-0.31(ses=middle); -1.00^{*}(ses=high) - 0.12^{***}write)
$$</p>
<h2 id="オッズ比の変量に着目">オッズ比の変量に着目</h2>
<p>オッズ比の変量(説明変数が変化すると、オッズ比は何倍になるか)についても確認しておきます。こちらは事後分布の要約統計量ではなく、事後分布自体を視覚的に見てみることにします。また通常切片項は解釈に用いないため、図の描画では割愛します。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">plot_title</span> <span class="o">&lt;-</span> <span class="nf">ggtitle</span><span class="p">(</span><span class="s">&#34;Posterior distribution&#34;</span><span class="p">,</span> <span class="s">&#34;with medians and 95% intervals&#34;</span><span class="p">)</span>

<span class="nf">mcmc_areas</span><span class="p">(</span><span class="nf">as.matrix</span><span class="p">(</span><span class="n">fit0</span><span class="p">),</span>
           <span class="n">pars</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;ratio[2,1]&#34;</span><span class="p">,</span><span class="s">&#34;ratio[3,1]&#34;</span><span class="p">,</span><span class="s">&#34;ratio[4,1]&#34;</span><span class="p">,</span><span class="s">&#34;ratio[2,2]&#34;</span><span class="p">,</span><span class="s">&#34;ratio[3,2]&#34;</span><span class="p">,</span><span class="s">&#34;ratio[4,2]&#34;</span><span class="p">),</span><span class="n">prob</span><span class="o">=</span><span class="m">0.95</span><span class="p">,</span> <span class="n">area_method</span> <span class="o">=</span> <span class="s">&#34;equal height&#34;</span><span class="p">)</span> <span class="o">+</span>
           <span class="n">plot_title</span><span class="o">+</span> <span class="nf">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="o">=</span><span class="m">12</span><span class="p">)</span>
</code></pre></div><p><img src="/r/multinom-rstan/fit0_mcmc_density.png" alt=""></p>
<p>上図の事後分布に表現された中央値、95%信頼区間を下で算出しておきます。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="n">ratio_median</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">posterior_fit0_2</span><span class="o">$</span><span class="n">ratio</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="n">median</span><span class="p">)</span>
<span class="n">ratio_quant</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">posterior_fit0_2</span><span class="o">$</span><span class="n">ratio</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="n">quantile</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.025</span><span class="p">,</span> <span class="m">0.975</span><span class="p">))</span>
<span class="n">ratio_general</span> <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="n">ratio_median[</span><span class="p">,</span><span class="m">1</span><span class="n">]</span><span class="p">,</span> <span class="n">ratio_quant[</span><span class="p">,,</span><span class="m">1</span><span class="n">]</span><span class="p">)</span>
<span class="n">ratio_vocation</span> <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="n">ratio_median[</span><span class="p">,</span><span class="m">2</span><span class="n">]</span><span class="p">,</span><span class="n">ratio_quant[</span><span class="p">,,</span><span class="m">2</span><span class="n">]</span><span class="p">)</span>
<span class="nf">rownames</span><span class="p">(</span><span class="n">ratio_general</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">rownames</span><span class="p">(</span><span class="n">ratio_vocation</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;median&#34;</span><span class="p">,</span><span class="s">&#34;2.5%&#34;</span><span class="p">,</span><span class="s">&#34;97.5%&#34;</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">ratio_general</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">colnames</span><span class="p">(</span><span class="n">ratio_vocation</span><span class="p">)</span> <span class="o">&lt;-</span>  <span class="nf">c</span><span class="p">(</span><span class="s">&#34;Intercept&#34;</span><span class="p">,</span><span class="s">&#34;sesmiddle&#34;</span><span class="p">,</span><span class="s">&#34;seshigh&#34;</span><span class="p">,</span><span class="s">&#34;write&#34;</span><span class="p">)</span>
<span class="n">ratio_odds</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span><span class="n">general</span> <span class="o">=</span> <span class="n">ratio_general</span><span class="p">,</span> <span class="n">vocation</span><span class="o">=</span><span class="n">ratio_vocation</span><span class="p">)</span>

<span class="nf">show</span><span class="p">(</span><span class="n">ratio_odds</span><span class="p">)</span>

<span class="c1">## $general</span>
<span class="c1">##        Intercept sesmiddle   seshigh     write</span>
<span class="c1">## median  18.08714 0.5897972 0.3041684 0.9428201</span>
<span class="c1">## 2.5%     1.85266 0.2434086 0.1037669 0.9051025</span>
<span class="c1">## 97.5%  166.69899 1.3964119 0.8242418 0.9836004</span>
<span class="c1">##</span>
<span class="c1">## $vocation</span>
<span class="c1">##         Intercept sesmiddle   seshigh     write</span>
<span class="c1">## median  204.48713  1.369324 0.3678701 0.8901682</span>
<span class="c1">## 2.5%     23.69682  0.527517 0.1092642 0.8515944</span>
<span class="c1">## 97.5%  1940.58136  3.594567 1.1219872 0.9260589</span>
</code></pre></div><p>上図で一番目立つ$ratio[2,2]$に着目すると、これは$\exp(b_{22})$ですので、
$$
\cfrac{\cfrac{P(prog=vocation(ses=middle))}{P(prog=academic(ses=middle))}}{\cfrac{P(prog=vocation(ses=low))}{P(prog=academic(ses=low))}}
$$
の事後分布を表現しています。
事後分布は95%ベイズ信頼区間内に1を含んでいますし、比較的幅が広い分布ですので、確信をもってこうだといえる結果が得られていないことがわかります。</p>
<p>一方で、$ratio[3,1]=\exp(b_{21})$は幅が比較的狭く、95%ベイズ信頼区間内に1が含まれていません。このことから、
$$
\cfrac{\cfrac{P(prog=general(ses=high))}{P(prog=academic(ses=high))}}{\cfrac{P(prog=general(ses=low))}{P(prog=academic(ses=low))}}
$$
はより確信をもって1以下の代表値(MAP推定値や中央値)付近をとる、ということができます。</p>
<p>このように、ベイズ統計ではパラメータや求めたい値のとりうる分布を推定することができ、大変便利です。</p>
<h1 id="結果の描画">結果の描画</h1>
<p>最後に結果(確率に関する予測値の分布)の描画を行います。以下では各programが選ばれる確率を、事後分布の中央値を予測値として、50%ベイズ信頼区間とともに示しています。</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">RColorBrewer</span><span class="p">)</span>

<span class="n">p25</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">posterior_fit0_2</span><span class="o">$</span><span class="n">pred</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="n">quantile</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.25</span><span class="p">))</span>
<span class="n">p50</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">posterior_fit0_2</span><span class="o">$</span><span class="n">pred</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="n">median</span><span class="p">)</span>
<span class="n">p75</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">posterior_fit0_2</span><span class="o">$</span><span class="n">pred</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="n">quantile</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0.75</span><span class="p">))</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">p25</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;academic&#34;</span><span class="p">,</span><span class="s">&#34;general&#34;</span><span class="p">,</span><span class="s">&#34;vocation&#34;</span><span class="p">),</span><span class="s">&#34;_p25&#34;</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">p50</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;academic&#34;</span><span class="p">,</span><span class="s">&#34;general&#34;</span><span class="p">,</span><span class="s">&#34;vocation&#34;</span><span class="p">),</span><span class="s">&#34;_p50&#34;</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">p75</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;academic&#34;</span><span class="p">,</span><span class="s">&#34;general&#34;</span><span class="p">,</span><span class="s">&#34;vocation&#34;</span><span class="p">),</span><span class="s">&#34;_p75&#34;</span><span class="p">)</span>
<span class="n">data1</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">ses</span> <span class="o">=</span> <span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;low&#34;</span><span class="p">,</span><span class="s">&#34;middle&#34;</span><span class="p">,</span><span class="s">&#34;high&#34;</span><span class="p">),</span><span class="n">each</span> <span class="o">=</span> <span class="m">41</span><span class="p">),</span> <span class="n">write</span> <span class="o">=</span> <span class="n">x_new[</span><span class="p">,</span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">)</span><span class="n">]</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">p50[</span><span class="p">,</span><span class="s">&#34;academic_p50&#34;</span><span class="n">]</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">p75[</span><span class="p">,</span><span class="s">&#34;academic_p75&#34;</span><span class="n">]</span><span class="p">,</span>
                    <span class="n">ymin</span><span class="o">=</span><span class="n">p25[</span><span class="p">,</span><span class="s">&#34;academic_p25&#34;</span><span class="n">]</span><span class="p">,</span> <span class="n">facet</span><span class="o">=</span><span class="s">&#34;academic&#34;</span><span class="p">)</span>
<span class="n">data2</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">ses</span> <span class="o">=</span> <span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;low&#34;</span><span class="p">,</span><span class="s">&#34;middle&#34;</span><span class="p">,</span><span class="s">&#34;high&#34;</span><span class="p">),</span><span class="n">each</span> <span class="o">=</span> <span class="m">41</span><span class="p">),</span> <span class="n">write</span> <span class="o">=</span> <span class="n">x_new[</span><span class="p">,</span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">)</span><span class="n">]</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">p50[</span><span class="p">,</span><span class="s">&#34;general_p50&#34;</span><span class="n">]</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">p75[</span><span class="p">,</span><span class="s">&#34;general_p75&#34;</span><span class="n">]</span><span class="p">,</span>
                    <span class="n">ymin</span><span class="o">=</span><span class="n">p25[</span><span class="p">,</span><span class="s">&#34;general_p25&#34;</span><span class="n">]</span><span class="p">,</span> <span class="n">facet</span><span class="o">=</span><span class="s">&#34;general&#34;</span><span class="p">)</span>
<span class="n">data3</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">ses</span> <span class="o">=</span> <span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;low&#34;</span><span class="p">,</span><span class="s">&#34;middle&#34;</span><span class="p">,</span><span class="s">&#34;high&#34;</span><span class="p">),</span><span class="n">each</span> <span class="o">=</span> <span class="m">41</span><span class="p">),</span> <span class="n">write</span> <span class="o">=</span> <span class="n">x_new[</span><span class="p">,</span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">)</span><span class="n">]</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">p50[</span><span class="p">,</span><span class="s">&#34;vocation_p50&#34;</span><span class="n">]</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">p75[</span><span class="p">,</span><span class="s">&#34;vocation_p75&#34;</span><span class="n">]</span><span class="p">,</span>
                    <span class="n">ymin</span><span class="o">=</span><span class="n">p25[</span><span class="p">,</span><span class="s">&#34;vocation_p25&#34;</span><span class="n">]</span><span class="p">,</span> <span class="n">facet</span><span class="o">=</span><span class="s">&#34;vocation&#34;</span><span class="p">)</span>


<span class="n">cols</span> <span class="o">=</span> <span class="n">RColorBrewer</span><span class="o">::</span><span class="nf">brewer.pal</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="s">&#34;Dark2&#34;</span><span class="p">)</span>

<span class="n">data_point</span> <span class="o">&lt;-</span> <span class="n">ml</span> <span class="o">%&gt;%</span> <span class="nf">cbind</span><span class="p">(</span><span class="n">makedummies</span><span class="o">::</span><span class="nf">makedummies</span><span class="p">(</span><span class="n">ml</span><span class="p">,</span><span class="n">basal_level</span> <span class="o">=</span> <span class="bp">T</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s">&#34;prog&#34;</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="nf">select</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">prog</span><span class="p">,</span> <span class="n">prog_academic</span><span class="p">,</span> <span class="n">prog_general</span><span class="p">,</span> <span class="n">prog_vocation</span><span class="p">))</span>

<span class="n">p0</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">()</span> <span class="o">+</span> <span class="nf">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="o">=</span><span class="m">11</span><span class="p">)</span> <span class="o">+</span> <span class="nf">mapply</span><span class="p">(</span>
  <span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">){</span>
    <span class="nf">geom_ribbon</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">write</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="n">ymin</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">ses</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span>
  <span class="p">},</span><span class="nf">list</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span><span class="n">data2</span><span class="p">,</span><span class="n">data3</span><span class="p">)</span>
<span class="p">)</span> <span class="o">+</span><span class="nf">mapply</span><span class="p">(</span>
  <span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">){</span>
    <span class="nf">geom_line</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">write</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="n">ses</span><span class="p">))</span>
  <span class="p">},</span><span class="nf">list</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span><span class="n">data2</span><span class="p">,</span><span class="n">data3</span><span class="p">)</span>
<span class="p">)</span> <span class="o">+</span> <span class="nf">mapply</span><span class="p">(</span>
  <span class="nf">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">n</span><span class="p">){</span>
  <span class="nf">geom_jitter</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">write</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">data[</span><span class="p">,</span><span class="n">n]</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="n">ses</span><span class="p">),</span><span class="n">height</span><span class="o">=</span><span class="m">0.1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="m">0.8</span><span class="p">)</span>
<span class="p">},</span><span class="nf">list</span><span class="p">(</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">data_point</span><span class="p">,</span> <span class="n">facet</span><span class="o">=</span><span class="s">&#34;academic&#34;</span><span class="p">),</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">data_point</span><span class="p">,</span> <span class="n">facet</span><span class="o">=</span><span class="s">&#34;general&#34;</span><span class="p">),</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">data_point</span><span class="p">,</span> <span class="n">facet</span><span class="o">=</span><span class="s">&#34;vocation&#34;</span><span class="p">)),</span>
  <span class="nf">list</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="m">5</span><span class="p">,</span><span class="m">6</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">facet_grid</span><span class="p">(</span><span class="n">facet</span><span class="o">~</span><span class="n">.)</span> <span class="o">+</span> <span class="nf">scale_colour_manual</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span> <span class="o">+</span> <span class="nf">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span> <span class="o">=</span> <span class="s">&#34;bottom&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">ylab</span><span class="p">(</span><span class="s">&#34;Probability&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">labs</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="s">&#34;With Rstan&#34;</span><span class="p">)</span>

<span class="n">p0</span>
</code></pre></div><p><img src="/r/multinom-rstan/fit0_mcmc_res.png" alt=""></p>
<p>multinom()による分析の際に描画した図を下に載せますが、この2つの結果はほぼ一致していることがわかります。</p>
<p><img src="/r/multinom-rstan/multinom.png" alt=""></p>
<h1 id="まとめ">まとめ</h1>
<p>本記事では多項ロジスティック回帰をRstanを用いて実行し、最尤法(multinom())による結果との比較を行い、ネイマン・ピアソン型統計とベイズ統計の違いを確認しました。</p>
<p>両者がやっていることは実質的には変わりありませんが、解釈の違いなどについては実感できたかと思います。</p>
<p>今後、今回の実装にさらに改良を加え、予測用のモデルを構築したいと思います。</p>

        </article>
    </div>
    <div class="main-content__tags u-font">
        
        
        <span><a href="https://rmorita-stat.github.io/tags/%E5%9B%9E%E5%B8%B0">回帰</a></span>
        
        <span><a href="https://rmorita-stat.github.io/tags/rstan">rstan</a></span>
        
        
    </div>
</div>
<div class="disqus-comments">
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-rmorita-stat-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
<div class="main-profile">
    <div class="main-profile__avatar">
        
    </div>
    <div class="main-profile__body">
        <div class="main-profile__author">
            
            <span> R.morita </span>
            
        </div>
        <div class="main-profile__description">
            
            <p> 得意なのは統一された洋服とダンスのステップです </p>
            
        </div>
    </div>
</div>
<div class="main-line"></div>
<div class="main-pn">
    
    <a class="previous" href="https://rmorita-stat.github.io/r/multinom/multinom/">
        <div class="pn-dec"></div>
        <div class="pn-els">
            <div class="pn-el__1"> 2020.05.27 21:13 </div>
            <div class="pn-el__2"> multinom()を使った多項ロジスティック回帰 </div>
        </div>
    </a>
    
    
    <a class="next" href="https://rmorita-stat.github.io/r/gaussianprocess/gaussianprocess/">
        <div class="pn-dec"></div>
        <div class="pn-els">
            <div class="pn-el__1"> 2020.06.14 00:00 </div>
            <div class="pn-el__2"> ガウス過程入門 </div>
        </div>
    </a>
    
</div>

<footer>
  <script type="text/javascript">
 MathJax = {
   tex: {
     inlineMath: [['$','$'], ['\\(','\\)']],
     processEscapes: true,
     tags: "ams",
     autoload: {
       color: [],
       colorV2: ['color']
     },
     packages: {'[+]': ['noerrors']}
   },
   chtml: {
     matchFontHeight: true,
     displayAlign: "left",
     displayIndent: "2em"
   },
   options: {
     skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
     renderActions: {
        
       find_script_mathtex: [10, function (doc) {
         for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
           const display = !!node.type.match(/; *mode=display/);
           const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
           const text = document.createTextNode('');
           node.parentNode.replaceChild(text, node);
           math.start = {node: text, delim: '', n: 0};
           math.end = {node: text, delim: '', n: 0};
           doc.math.push(math);
         }
       }, '']
     }
   },
   loader: {
     load: ['[tex]/noerrors']
   }
 };
</script>
<script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script"></script>
</footer>

</div>
<div class="footer">
    <div class="copyright-wrap">
        <p class="copyright u-font">
            
            &#169;
            2021
            
            <a href="https://github.com/Rmorita-stat/doc" target="_blank">R.morita&#46;</a>
            Theme <a href="https://github.com/iCyris/hugo-theme-yuki" target="_blank">yuki</a>&#46;
            Powered by Hugo&#46;
            
            
        </p>
    </div>
</div>
</body>
<script src="https://rmorita-stat.github.io/js/page.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

