<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>
        
        SUCRE HECACHA
        
    </title>
    <meta name="viewport" id="viewport" content="width=device-width, initial-scale=1">
    <link rel='icon' type='image/x-icon' href="https://rmorita-stat.github.io/my-page/images/logo2.png" />
    <link rel="apple-touch-icon" href="https://rmorita-stat.github.io/my-page/images/logo2.png"><link rel="stylesheet" href="https://rmorita-stat.github.io/my-page/scss/style.css">
    
    <link rel="stylesheet" href="https://rmorita-stat.github.io/my-page/scss/monokai-sublime.min.css">
    <script src="https://rmorita-stat.github.io/my-page/js/highlight.min.js"></script>
    <link rel="stylesheet" href="https://rmorita-stat.github.io/scss/highlight.css">
    
    <link rel="stylesheet" href="https://rmorita-stat.github.io/scss/custom.css">
    
    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'Your Google Analytics tracking id', 'auto');
        ga('send', 'pageview');
    </script>
    
    
    <meta name="generator" content="Hugo 0.71.0" /></head>


<body>
<div class="header">
    <div class="site-logo__wrap">
        <div id="site-button">
            <div></div>
        </div>
        
        <div class=' site-logo '>
            <a href="https://rmorita-stat.github.io/my-page/"><img src="https://rmorita-stat.github.io/my-page/images/logo.png" /></a>
        </div>
    </div>
    
<div class=' site-nav u-font ' id="nav-bar">
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="/my-page/" >HOME</a>
    </div>
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="/my-page/post" >BLOG</a>
    </div>
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="/my-page/about" >ABOUT</a>
    </div>
    
    <div class="site-nav__wrap">
        <a class="site-nav__el" href="/my-page/tags/" >TAGS</a>
    </div>
    
</div>

</div>
<div class="main">

<div class="main-content">
    <div class="main-content__date">
        <h4 id="date"> 2020.05.31 00:00 </h4>
    </div>
    <div class="main-content__title">
        <h1 id="title">rstanã‚’ä½¿ã£ãŸå¤šé …ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°</h1>
    </div>
    <div class="main-content__article">
        <article id="content">
            <h1 id="ã¯ã˜ã‚ã«">ã¯ã˜ã‚ã«</h1>
<p><strong>å›å¸°</strong>ã«é–¢ã™ã‚‹è¨˜äº‹ã§ã™ã€‚æœ¬è¨˜äº‹ã§ã¯<a href="https://rmorita-stat.github.io/my-page/post/multinom/multimon/">ä»¥å‰ã®è¨˜äº‹</a>ã§æ‰±ã£ãŸå¤šé …ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ã‚’<strong>rstan</strong>ã§å®Ÿè¡Œã—ã¾ã™ã€‚</p>
<h5 id="ãƒ¢ãƒ‡ãƒ«ã®ç¢ºèª">ãƒ¢ãƒ‡ãƒ«ã®ç¢ºèª</h5>
<p>ä»¥å‰ã®è¨˜äº‹ã§ã‚‚ç´¹ä»‹ã—ãŸå¤šé …ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ãƒ¢ãƒ‡ãƒ«ã®ä¸€èˆ¬å¼ã‚’å†æ²ã—ã¾ã™ã€‚
<!-- raw HTML omitted --><br>
å¾“å±å¤‰æ•°$Y$ã€èª¬æ˜å¤‰æ•°$X$ã«ã¤ã„ã¦ã€$Y = (y_1,\ldots,y_n,\ldots, y_N)^T$ã€$X = (x_1,\ldots, x_n,\ldots, x_N)^T$ã¨ã—ã€ã•ã‚‰ã«
$x_n = (x_{1n},\ldots,x_{dn},\ldots, x_{Dn})$ã¨ã—ãŸã¨ãã€å¤šé …ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ã®ãƒ¢ãƒ‡ãƒ«å¼ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚$N$ã¯ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºã€$D$ã¯èª¬æ˜å¤‰æ•°ã®æ¬¡å…ƒã§ã™ã€‚</p>
<p>$$
\mu_n = \overrightarrow{a} + \overrightarrow{b_1}x_{n1} + \cdots + \overrightarrow{b_d}x_{nd} + \cdots + \overrightarrow{b_D}x_{nD}
$$
$$
\theta_n = softmax(\mu_n)
$$
$$
y_n \sim Categorical(\theta_n)
$$
$$
(n=1,\ldots,N)
$$</p>
<p>ã“ã“ã§
$$
\mu=(\mu_1,\ldots,\mu_n,\ldots,\mu_N)
$$
$$
\theta=(\theta_1,\ldots,\theta_n,\ldots,\theta_N)
$$</p>
<p>$\mu_n, \theta_n,\overrightarrow{a},\overrightarrow{b_1},\ldots,\overrightarrow{b_D}$ã¯é•·ã•$K$ã®ãƒ™ã‚¯ãƒˆãƒ«ã§ã™ã€‚</p>
<h1 id="ãƒ‡ãƒ¼ã‚¿ã®å…¥æ‰‹æ•´å½¢">ãƒ‡ãƒ¼ã‚¿ã®å…¥æ‰‹ãƒ»æ•´å½¢</h1>
<p><a href="https://rmorita-stat.github.io/my-page/post/multinom/multimon/">ä»¥å‰ã®è¨˜äº‹</a>ã§ã‚‚æ‰±ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’ç”¨ã„ã¾ã™ã€‚ä»Šå›ã‚‚prog(200äººã®ç”Ÿå¾’ãŒgeneralã€vocationã€academicã®3ã¤ã®æˆæ¥­ã‹ã‚‰é¸ã‚“ã æˆæ¥­)ã‚’å¾“å±å¤‰æ•°ã¨ã—ã€ses(å®¶åº­ã®çµŒæ¸ˆçŠ¶æ³)ã€write(æ›¸ãåŠ›)ã‚’å¾“å±å¤‰æ•°ã¨ã—ã¾ã™ã€‚</p>
<p>ä»¥ä¸‹ã®é€šã‚ŠStanã«æŒ‡å®šã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã«æ•´å½¢ã—ã¦ã„ãã¾ã™ã€‚</p>
<pre><code>library(makedummies)
library(tidyr)
library(dplyr)
library(foreign)

ml &lt;- read.dta(&quot;https://stats.idre.ucla.edu/stat/data/hsbdemo.dta&quot;)

## progã®3å¼•æ•°ã‚’æ•°å­—ã«ç½®ãæ›ãˆã‚‹ãŸã‚ã®è¡¨ã‚’ä½œæˆ
progid &lt;- c(1,2,3)
names(progid) &lt;- c(&quot;academic&quot;,&quot;general&quot;,&quot;vocation&quot;)

## makedummies()ã¯sesã«å¯¾ã—ã¦ãƒ€ãƒŸãƒ¼å¤‰æ•°ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨
## interceptã¯åˆ‡ç‰‡é …
d &lt;- ml %&gt;% cbind(makedummies::makedummies(ml,basal_level = F, col = &quot;ses&quot;)) %&gt;% 
  mutate(progid = progid[paste(prog)]) %&gt;% select(c(ses_middle, ses_high, write, progid)) %&gt;% 
  cbind(intercept=rep(1,nrow(ml)))

head(d,10)

##    ses_middle ses_high write progid intercept
## 1           0        0    35      3         1
## 2           1        0    33      2         1
## 3           0        1    39      3         1
## 4           0        0    37      3         1
## 5           1        0    31      3         1
## 6           0        1    36      2         1
## 7           1        0    36      3         1
## 8           1        0    31      3         1
## 9           1        0    41      3         1
## 10          1        0    37      3         1
</code></pre>
<p>ã“ã“ã§ã€æœ¬ãƒ‡ãƒ¼ã‚¿ç”¨ã«è¨­å®šã—ãŸãƒ¢ãƒ‡ãƒ«å¼ã«ãŠã‘ã‚‹ä¿‚æ•°ã®å‘¼ç§°ã‚’ä»¥ä¸‹ã®é€šã‚Šå®šç¾©ã—ã¦ãŠãã¾ã™ã€‚</p>
<p>$$\cfrac{P(prog=general)}{P(prog=academic)} = exp(b_{11} + b_{21}(ses=middle) + b_{31}(ses=high) + b_{41}write)$$</p>
<p>$$\cfrac{P(prog=vocation)}{P(prog=academic)} = exp(b_{12} + b_{22}(ses=middle) + b_{32}(ses=high) + b_{42}write)$$</p>
<h1 id="stanã«ã‚ˆã‚‹å¤šé …ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ã®å®Ÿè£…">Stanã«ã‚ˆã‚‹å¤šé …ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ã®å®Ÿè£…</h1>
<p>å¤šé …ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ã‚’å®Ÿè¡Œã™ã‚‹Stanã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
<pre><code>//(model1.stan)
//dataãƒ–ãƒ­ãƒƒã‚¯ï¼šãƒ‡ãƒ¼ã‚¿ã‚’æŒ‡å®š
data{
  int&lt;lower=2&gt; K; //ã‚«ãƒ†ã‚´ãƒªæ•°
  int&lt;lower=1&gt; N; //ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚º
  int&lt;lower=1&gt; D; //ãƒ‡ãƒ¼ã‚¿é …ç›®æ•°+åˆ‡ç‰‡é …ã®æ•°ï¼ˆï¼‘ï¼‰
  int&lt;lower=1, upper=K&gt; y[N]; //prog
  matrix[N,D] x; //èª¬æ˜å¤‰æ•°ã¨åˆ‡ç‰‡é …
  int N_new; //äºˆæ¸¬ç‚¹ã®æ•°
  matrix[N_new,D] x_new; //äºˆæ¸¬ç‚¹ç¾¤
}

//transformed dataãƒ–ãƒ­ãƒƒã‚¯ï¼šæ–°ã—ããƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ ã“ã“ã§ã¯muã®åŒºåˆ¥åŒ–ã®ç‚ºã®0ãƒ™ã‚¯ãƒˆãƒ«ã‚’ç”Ÿæˆ
transformed data{
  vector[D] Zeros;
  Zeros = rep_vector(0, D);
}

//parameterãƒ–ãƒ­ãƒƒã‚¯ï¼šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å®šç¾©
parameters{
  matrix[D, K-1] b;
}

//transformed parameterãƒ–ãƒ­ãƒƒã‚¯ï¼šparameterãƒ–ãƒ­ãƒƒã‚¯ã§æŒ‡å®šã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰å½¢ ã“ã“ã§ã¯0ãƒ™ã‚¯ãƒˆãƒ«ã¨çµåˆ
transformed parameters{
  matrix[D,K] beta;
  beta = append_col(Zeros, b);
}

//modelãƒ–ãƒ­ãƒƒã‚¯ï¼šãƒ¢ãƒ‡ãƒ«ã‚’å®šç¾©
model{
  matrix[N,K] mu;
  mu = x * beta;
  for(n in 1:N){
    y[n] ~ categorical_logit(mu[n]);
  }
}

//generated quantitiesãƒ–ãƒ­ãƒƒã‚¯ï¼šç”Ÿæˆé‡ã‚’å®šç¾© ã“ã“ã§ã¯ç¢ºç‡ã«é–¢ã™ã‚‹äºˆæ¸¬å€¤mu_newã¨ã‚ªãƒƒã‚ºæ¯”ã®å¤‰é‡exp(b)ã‚’ç”Ÿæˆ
generated quantities{
  matrix[D, K-1] ratio;//ã‚ªãƒƒã‚ºæ¯”ã®å¤‰é‡
  vector[K] pred[N_new];//äºˆæ¸¬ç‚¹ã«ãŠã„ã¦å„programãŒé¸ã°ã‚Œã‚‹ç¢ºç‡
  matrix[N_new, K] mu_new;
  mu_new = x_new * beta;
  for(n in 1:N_new){
    pred[n,] = softmax(mu_new[n,]);
  }
  ratio = exp(b);
}
</code></pre>
<p>parameterãƒ–ãƒ­ãƒƒã‚¯ã§æŒ‡å®šã—ãŸä¿‚æ•°$b$ã®è¡Œç•ªå·ãƒ»åˆ—ç•ªå·ã®çµ„ã¿åˆã‚ã›ãŒã€å…ˆã»ã©å®šç¾©ã—ãŸãƒ¢ãƒ‡ãƒ«å¼ã«ãŠã‘ã‚‹ä¿‚æ•°ã®ä¿®é£¾ç•ªå·ã«ä¸€è‡´ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€$b[1,2]$ã¯ãƒ¢ãƒ‡ãƒ«å¼ã«ãŠã‘ã‚‹$b_{12}$ã«å¯¾å¿œã—ã¾ã™ã€‚</p>
<p><code>Categorical_logit()</code>ã¯Stanã«å®Ÿè£…ã•ã‚ŒãŸä¾¿åˆ©ãªé–¢æ•°ã§ã€Stanå†…éƒ¨ã§softmaxã‚’å®Ÿè¡Œã—ã¦ãã‚Œã¾ã™ã€‚
ã¤ã¾ã‚Šã€<code>y[n] ~ categorical_logit(mu[n]')</code>ã¨<code>y[n] ~ Categorical(softmax(mu[n]'))</code>ã¯ã¨ã‚‚ã«ä»¥ä¸‹ã«ç¤ºã™å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ãã‚Œã¾ã™ã€‚</p>
<p>$$y[n] \sim Categorical(softmax(mu[n]))$$</p>
<p>(æ³¨ï¼šä¸Šã«ç¤ºã—ãŸå®Ÿè£…ã§ã¯ã‚³ãƒ¼ãƒ‰è¡¨ç¾ã®éƒ½åˆä¸Š<code>categorical_logit()</code>ã¨<code>softmax()</code>ã®å¼•æ•°ã‚’ãã‚Œãã‚Œ<code>mu[n]</code>ã€<code>mu_new[n,]</code>ã¨ã—ã¦ã„ã¾ã™ãŒã€<code>softmax()</code>ã¯åˆ—ãƒ™ã‚¯ãƒˆãƒ«ã«ã—ã‹å¯¾å¿œã—ã¦ã„ãªã„ã®ã§ã€å®Ÿè£…ã§ã¯å¿…ãšãƒ™ã‚¯ãƒˆãƒ«ã‚„è¡Œåˆ—ã‚’è»¢ç½®ã•ã›ã‚‹å‘½ä»¤ã§ã‚ã‚‹<code>'</code>ã‚’å¼•æ•°ã®å¾Œã‚ã«ã¤ã‘ã¦ãã ã•ã„ï¼)</p>
<p>ã“ã®éƒ¨åˆ†ã«ã¤ã„ã¦ã‚‚ã†å°‘ã—è£œè¶³ã™ã‚‹ã¨ã€
$$
P(y[n] = 1) = softmax(mu[n,])[1]
$$
$$
P(y[n] = 2) = softmax(mu[n,2])[2]
$$
$$
P(y[n] = 3) = softmax(mu[n,3])[3]
$$
ã¨ã„ã†é–¢ä¿‚ã«ãªã£ã¦ã„ã¾ã™ã€‚
ã“ã“ã§ã¯$beta[,1] = 0$ã¨ã™ã‚‹ã“ã¨ã§$mu[,1] = 0$ã¨ã—ã€
ã¾ãŸãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢ã«ãŠã„ã¦$academic \rightarrow 1,~~~general \rightarrow 2,~~~vocation \rightarrow 3$ã¨ã—ã¦ã„ã‚‹ã®ã§ã€ä»¥ä¸‹ã®é€šã‚Š$P(y[n] = 1(academic))$ã«ã¤ã„ã¦å›ºå®šãƒ»åŸºæº–åŒ–ã—ã¦ã„ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚</p>
<p>$$
P(y[n] = 1(academic)) = \cfrac{1}{\sum_{k=1}^K \exp(mu[n,k])}
$$</p>
<p>ã¾ãŸã€ä¸Šè¨˜ã®å®Ÿè£…ã§ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®bã«äº‹å‰åˆ†å¸ƒã‚’æŒ‡å®šã—ã¦ã„ã¾ã›ã‚“ãŒã€Stanã§ã¯äº‹å‰åˆ†å¸ƒã‚’æŒ‡å®šã—ãªã„å ´åˆã€ååˆ†ã«å¹…ã®åºƒã„ä¸€æ§˜åˆ†å¸ƒãŒè‡ªå‹•ã§è¨­å®šã•ã‚Œã¾ã™ã€‚
<!-- raw HTML omitted -->ãã®ãŸã‚ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«é–¢ã™ã‚‹äº‹å‰ã®è¨­å®šè¦ä»¶ãŒç„¡ã„å ´åˆã¯ã€äº‹å‰åˆ†å¸ƒã«ä½•ã‚‚æŒ‡å®šã—ãªãã¦ã‚‚ç„¡æƒ…å ±äº‹å‰åˆ†å¸ƒãŒè¨­å®šã•ã‚Œã‚‹ãŸã‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚</p>
<p>model1ã«åŸºã¥ã„ã¦ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚’å‘½ä»¤ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
<pre><code>#(run_model1)
library(rstan)
x &lt;- d[,c(5,1,2,3)] 
y &lt;- d[,&quot;progid&quot;]
K &lt;- 3
N &lt;- nrow(x)
D &lt;- ncol(x)
x_new &lt;- data.frame(rep(1,123),c(rep(0,41),rep(1,41),rep(0,41)),c(rep(0,82),rep(1,41)), write = rep(c(30:70),3))
N_new &lt;- nrow(x_new)

fit0 &lt;- stan(file = &quot;model1.stan&quot;, data = list(x=x,y=y,K=K,N=N,D=D,x_new=x_new,N_new=N_new), seed=123, war=500, iter=1500, chains = 4)
</code></pre>
<p><code>rstan::stan()</code>ã®å¼•æ•°ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãŠãã¾ã™ã€‚</p>
<ul>
<li>fileï¼šstanãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š</li>
<li>dataï¼šå¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¹ãƒˆå‹ã§æŒ‡å®š</li>
<li>warï¼š warm upæœŸé–“ã‚’æŒ‡å®š</li>
<li>iterï¼šwaru upæœŸé–“ã‚’å«ã‚“ã chainã®é•·ã•(iteration)ã‚’æŒ‡å®š</li>
<li>chainï¼šchainæ•°ã‚’æŒ‡å®š</li>
<li>seedï¼šä¹±æ•°ã®ç¨®é¡ã‚’æŒ‡å®š</li>
</ul>
<p>$x_{new}$ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®MCMCã‚µãƒ³ãƒ—ãƒ«ã«ã‚‚ã¨ã¥ã„ã¦
$$
P(y[n_{new}]=1),~P(y[n_{new}]=2),~P(y[n_{new}]=3),~~~~n_{new}=1,\ldots,N_{new}
$$
ã®äºˆæ¸¬å€¤ã‚’ç®—å‡ºã™ã‚‹éš›ã«ã€èª¬æ˜å¤‰æ•°$x$ãŒã¨ã‚‹çµ„ã¿åˆã‚ã›ã‚’æŒ‡å®šã—ãŸã‚‚ã®ã§ã™ã€‚
<!-- raw HTML omitted -->
äºˆæ¸¬å€¤ã¯ã€MCMCã§ã¯ç”Ÿæˆé‡ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã¨ã—ã¦æ‰±ã†ãŸã‚ã€generated quantitiesãƒ–ãƒ­ãƒƒã‚¯ã§æŒ‡å®šã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚</p>
<h1 id="mcmcã®åæŸã®ç¢ºèª">MCMCã®åæŸã®ç¢ºèª</h1>
<p>MCMCã®å®Ÿè¡Œå¾Œã€ã¾ãšã¯ã¡ã‚ƒã‚“ã¨åæŸã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä»¥ä¸‹ã§ã¯ãƒ¢ãƒ‡ãƒ«ã®ä¿‚æ•°ã«ã¤ã„ã¦tracsplotã‚’æç”»ã—ã€åæŸã®ç¢ºèªã‚’è¡Œã„ã¾ã™ã€‚</p>
<pre><code>library(ggmcmc)
library(bayesplot)
posterior_fit0_1 &lt;- rstan::extract(fit0, inc_warmup=TRUE, permuted=FALSE)
color_scheme_set(&quot;mix-blue-pink&quot;)
p &lt;- mcmc_trace(posterior_fit0_1, regex_pars = c(&quot;b&quot;), n_warmup = 500,
                facet_args = list(ncol = 2))+ theme_bw(base_size=12) + theme(legend.position = &quot;bottom&quot;)
p
</code></pre>
<p><img src="/my-page/post/multinom-rstan/fit0_mcmc_trace.png" alt=""></p>
<p>ã©ã®ä¿‚æ•°ã‚‚æ—©ã„æ®µéšã§ä¸€ã¤ã®å€¤ã«åæŸã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚ã“ã“ã§ã¯warm upã‚’500ã«è¨­å®šã—ã¦ã„ã¾ã™ãŒã€ååˆ†ã™ãã‚‹warm up ã§ã‚ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚</p>
<p>MCMCã®åæŸã‚’ç¢ºèªã™ã‚‹æ–¹æ³•ã¯tracsplotã‚’ç”¨ã„ãŸè¦–è¦šçš„ãªåˆ¤æ–­ã ã‘ã§ãªãã€æ•°å€¤åŸºæº–ã‚‚ç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
<pre><code>options(max.print = 80)
fit0

## Inference for Stan model: model1.
## 4 chains, each with iter=1500; warmup=500; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##                  mean se_mean     sd    2.5%     25%     50%     75%   97.5%
## b[1,1]           2.89    0.03   1.16    0.62    2.11    2.90    3.66    5.12
## b[1,2]           5.36    0.03   1.13    3.17    4.61    5.32    6.14    7.57
## b[2,1]          -0.54    0.01   0.45   -1.41   -0.83   -0.53   -0.24    0.33
## b[2,2]           0.32    0.01   0.48   -0.64    0.00    0.31    0.64    1.28
## b[3,1]          -1.19    0.01   0.52   -2.27   -1.53   -1.19   -0.84   -0.19
## b[3,2]          -1.01    0.01   0.59   -2.21   -1.40   -1.00   -0.61    0.12
## b[4,1]          -0.06    0.00   0.02   -0.10   -0.07   -0.06   -0.04   -0.02
## b[4,2]          -0.12    0.00   0.02   -0.16   -0.13   -0.12   -0.10   -0.08
##               n_eff Rhat
## b[1,1]         2022    1
## b[1,2]         1934    1
## b[2,1]         2701    1
## b[2,2]         2579    1
## b[3,1]         2835    1
## b[3,2]         2514    1
## b[4,1]         2122    1
## b[4,2]         1978    1
##  [ reached getOption(&quot;max.print&quot;) -- 759 è¡Œã‚’ç„¡è¦–ã—ã¾ã—ãŸ ] 
## 
## Samples were drawn using NUTS(diag_e) at Sun May 31 00:51:09 2020.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).
</code></pre>
<p>R consoleä¸Šã§fit0ã®ä¸­èº«ã‚’ç¢ºèªã™ã‚‹ã¨ã€å„MCMCã‚µãƒ³ãƒ—ãƒ«ã®è¦ç´„çµ±è¨ˆé‡ã®ä»–ã«n-effã€RhatãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚</p>
<p><strong>n-eff</strong>
<!-- raw HTML omitted --> <br>
StanãŒè‡ªå·±ç›¸é–¢ç­‰ã‹ã‚‰åˆ¤æ–­ã—ãŸå®Ÿè¡Œã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºã§ã™ã€‚ã‚ã‚‹æ›¸ç±ã«ã¯åˆ†å¸ƒã®æ¨å®šãƒ»çµ±è¨ˆé‡ã®ç®—å‡ºã®ãŸã‚ã«100ç¨‹åº¦ä»¥ä¸Šã‚ã‚‹ã“ã¨ãŒæœ›ã¾ã—ã„ã¨ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚
<!-- raw HTML omitted -->  <br>
æ¨™æœ¬è‡ªå·±ç›¸é–¢ãŒãƒ©ã‚°ã‚’å¤§ããã—ã¦ã‚‚ãªã‹ãªã‹æ¸›è¡°ã—ãªã„å ´åˆã€MCMCã‚µãƒ³ãƒ—ãƒ«ã¯éå»ã®å€¤ã«é•·ãä¾å­˜ã—ã¦ãŠã‚Šã€ä¸å¤‰åˆ†å¸ƒã§ã‚ã‚‹äº‹å¾Œåˆ†å¸ƒã«é–¢ã™ã‚‹æ¨è«–ã«ã¯åŠ¹ç‡ãŒæ‚ªã„ã€ã¨ã„ã†ã“ã¨ã®ã‚ˆã†ã§ã™ã€‚Stané–‹ç™ºè€…ã¯<a href="https://mc-stan.org/docs/2_21/reference-manual/effective-sample-size-section.html">ã“ã¡ã‚‰ã®ãƒšãƒ¼ã‚¸</a>ã§n-effã®å®šç¾©ã‚’ã—ã¦ã„ã¾ã™ã€‚ç§ã‚‚ã¾ã ã¡ã‚ƒã‚“ã¨èª­ã‚“ã§ã„ãªã„ã®ã§ã„ã¤ã‹èª­ã¿ãŸã„ã§ã™ã€‚</p>
<p><strong>Rhat($\hat{R}$)</strong>
<!-- raw HTML omitted --> <br>
ã“ã¡ã‚‰ã¯MCMCãŒåæŸã—ãŸã‹ã‚’è¡¨ã™ä¸€ã¤ã®æŒ‡æ¨™ã§ã™ã€‚
<!-- raw HTML omitted -->  <br>
Rhatã«ã¤ã„ã¦ã¯å°‘ã—è©³ã—ãç´¹ä»‹ã—ã¦ãŠãã¾ã™ã€‚
<!-- raw HTML omitted --><br>
ã„ã¾chainæ•°ã‚’$M$ã€iterationã‚’$n$ã¨ã—ã€chainæ¯ã«$n$å€‹ã®æ¨™æœ¬$\theta^{(i,t)}$ã‚’ç™ºç”Ÿã•ã›ãŸã¨ã—ã¾ã™$(i=1,2,\ldots,M,~~t=1,2,\ldots,n)$ã€‚
<!-- raw HTML omitted --> <br>
ã“ã®ã¨ãã€$g(\theta^{(i,t)})$ã®åˆ†æ•£$\sigma_g^2$ã¯ã€</p>
<p>$$
\tilde{\sigma}^2_{BW} = \cfrac{(n-1)\tilde{\sigma}^2_w + \tilde{\sigma}^2_B}{n}
$$
$$
\tilde{\sigma}^2_{W} = \cfrac{1}{M} \sum_{i=1}^M s^2_{g_i}, ~~~~ 
s^2_{g_i} = \cfrac{\sum_{t=1}^n ((g(\theta^{(i,t)}))-\bar{g}_i)^2}{n-1}
$$
$$
\tilde{\sigma}^2_B = n\cfrac{\sum_{i=1}^M (\bar{g}_i-\check{g})}{M-1},~~~~
\bar{g}_i = \cfrac{1}{n}\sum_{t=1}^n g(\theta^{(i,t)}),~~~~
\check{g} = \cfrac{1}{M} \sum^M_{i=1} \bar{g}_i
$$</p>
<p>ã®$\tilde{\sigma}^2_{BW},~ \tilde{\sigma}^2_{W}, ~ \tilde{\sigma}^2_B$ã®ã„ãšã‚Œã§ã‚‚æ¨å®šã§ãã¾ã™ã€‚</p>
<p>MCMCæ¨™æœ¬ã®è‡ªå·±ç›¸é–¢ãŒé«˜ãã€ä¸å¤‰åˆ†å¸ƒã§ã‚ã‚‹äº‹å¾Œåˆ†å¸ƒã¸ã®åæŸãŒé…ã„å ´åˆã€$s^2_{g_i}$(=1chainå†…ã®ä¸ååˆ†æ•£)ã¯çœŸã®åˆ†æ•£$\sigma^2_g$ã‚ˆã‚Šã‚‚å°ã•ããªã‚Šã€ã—ãŸãŒã£ã¦$\tilde{\sigma}^2_{W}$($s^2_{g_i}$ã®å¹³å‡)ã‚‚å°ã•ããªã‚Šã¾ã™ã€‚
<!-- raw HTML omitted -->  <br>
ä¸€æ–¹ã€å„é€£é–ã®å‹•ããŒç·©æ…¢ã§äº‹å¾Œåˆ†å¸ƒã®ä¸€éƒ¨ã§ã—ã‹ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ãªã„ã¨ãã¯ã€$\tilde{\sigma}^2_B/n$(=å„chainã®æ¨™æœ¬å¹³å‡ã®ä¸ååˆ†æ•£)ãŒå¤§ãããªã‚Šã€ã—ãŸãŒã£ã¦$\tilde{\sigma}^2_B$ã‚‚å¤§ãããªã‚Šã¾ã™ã€‚</p>
<p>ãã“ã§ã€ä¸‹è¨˜å¼ã§$\hat{R}$ã‚’å®šç¾©ã™ã‚‹ã¨ã€$\hat{R}$ãŒ1ã«è¿‘ã„ã‹ã©ã†ã‹ã§MCMCã®åæŸã‚’åˆ¤æ–­ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚Galman(1996)ã¯$\hat{R}$ãŒ1.1~1.2ä»¥ä¸‹ã«ãªã‚Œã°åæŸã—ãŸã¨å®Ÿç”¨ä¸Šè€ƒãˆã¦ã‚ˆã„ã¨ã—ã¦ã„ã‚‹ãã†ã§ã™ã€‚</p>
<p>$$
\hat{R} = \cfrac{\tilde{\sigma}^2_{BW}}{\tilde{\sigma}^2_{W}}
$$</p>
<p>ä»Šå›ã¯å…¨ä¿‚æ•°ã§RhatãŒ1ã§ã™ã®ã§ã€MCMCã¯åæŸã—ãŸã¨åˆ¤æ–­ã—ã¾ã™ã€‚</p>
<h1 id="çµæœã®ç¢ºèªãƒ¢ãƒ‡ãƒ«ã®ä¿‚æ•°ã«ç€ç›®">çµæœã®ç¢ºèª(ãƒ¢ãƒ‡ãƒ«ã®ä¿‚æ•°ã«ç€ç›®)</h1>
<p>R consoleä¸Šã§fit0ã®ä¸­èº«ã‚’ç¢ºèªã—ãŸã¨ãã€ä¿‚æ•°ã®è¦ç´„çµ±è¨ˆé‡ãŒä»¥ä¸‹ã®ã‚ˆã†ã«ç®—å‡ºã•ã‚Œã¦ã„ã¾ã—ãŸã€‚</p>
<pre><code>options(max.print = 80)
fit0

## ï½çœç•¥ï½
## 
##                  mean se_mean     sd    2.5%     25%     50%     75%   97.5%
## b[1,1]           2.89    0.03   1.16    0.62    2.11    2.90    3.66    5.12
## b[1,2]           5.36    0.03   1.13    3.17    4.61    5.32    6.14    7.57
## b[2,1]          -0.54    0.01   0.45   -1.41   -0.83   -0.53   -0.24    0.33
## b[2,2]           0.32    0.01   0.48   -0.64    0.00    0.31    0.64    1.28
## b[3,1]          -1.19    0.01   0.52   -2.27   -1.53   -1.19   -0.84   -0.19
## b[3,2]          -1.01    0.01   0.59   -2.21   -1.40   -1.00   -0.61    0.12
## b[4,1]          -0.06    0.00   0.02   -0.10   -0.07   -0.06   -0.04   -0.02
## b[4,2]          -0.12    0.00   0.02   -0.16   -0.13   -0.12   -0.10   -0.08
</code></pre>
<p>äº‹å¾Œåˆ†å¸ƒã®ä»£è¡¨å€¤ã¨ã—ä¸Šã®ä¸­å¤®å€¤(50%åˆ—ã®å€¤)ã‚‚ç”¨ã„ã‚‰ã‚Œã¾ã™ãŒã€ã“ã“ã§ã¯æœ€å°¤æ³•ã«ã‚ˆã‚‹çµæœã¨ã®æ•´åˆæ€§ã‚’ç¢ºèªã™ã‚‹ãŸã‚MAPæ¨å®šå€¤ã‚‚ç®—å‡ºã—ã¦ã¿ã¾ã™ã€‚
äº‹å¾Œåˆ†å¸ƒã®MAPæ¨å®šå€¤ãŒæœ€å°¤æ¨å®šã«ã‚ˆã‚‹çµæœã¨ç†è«–çš„ã«ä¸€è‡´ã™ã‚‹ã“ã¨ã«ã¤ã„ã¦ã¯<a href="https://rmorita-stat.github.io/my-page/post/multinom/multimon/">ä»¥å‰ã®è¨˜äº‹</a>ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
<pre><code>b_MAP &lt;- apply(posterior_fit0_2$b, c(2,3), function(x){
mode_x &lt;- density(x)$x[which.max(density(x)$y)]
})
colnames(b_MAP) &lt;- c(&quot;general&quot;,&quot;vocation&quot;)
t(b_MAP)

##           Intercept  sesmiddle   seshigh       write
##  general   2.898204 -0.5127911 -1.224067 -0.05841702
##  vocation  5.059521  0.2740113 -1.028054 -0.11497210
</code></pre>
<p>ä¸€æ–¹ã€ä»¥å‰ã®è¨˜äº‹ã§multinom()ã‚’ç”¨ã„ã¦åŒã˜åˆ†æã‚’è¡Œã£ãŸçµæœãŒä»¥ä¸‹ã§ã™ã€‚</p>
<pre><code>## Call:
## multinom(formula = prog2 ~ ses + write, data = ml)
## 
## Coefficients:
##          (Intercept)  sesmiddle    seshigh      write
## general     2.852198 -0.5332810 -1.1628226 -0.0579287
## vocation    5.218260  0.2913859 -0.9826649 -0.1136037
## 
## Std. Errors:
##          (Intercept) sesmiddle   seshigh      write
## general     1.166441 0.4437323 0.5142196 0.02141097
## vocation    1.163552 0.4763739 0.5955665 0.02221996
## 
## Residual Deviance: 359.9635 
## AIC: 375.9635

## ä¸¡å´Zæ¤œå®šã®å®Ÿè¡Œ
z &lt;- summary(test)$coefficients/summary(test)$standard.errors
p &lt;- (1 - pnorm(abs(z),0,1))
p

##           (Intercept) sesmiddle    seshigh        write
## general  7.238305e-03 0.1147190 0.01186928 3.409451e-03
## vocation 3.649650e-06 0.2703765 0.04947488 1.588023e-07
</code></pre>
<p>äº‹å¾Œåˆ†å¸ƒã®MAPæ¨å®šå€¤ã¨multinom()ã«ã‚ˆã‚‹çµæœã®coefficients:ã‚’æ¯”è¼ƒã—ã¦ã¿ã‚‹ã¨ã€ãŠãŠã‚ˆãä¸€è‡´ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚å¤šå°‘ã®ãšã‚Œã¯ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­èª¤å·®ãªã©ã®å½±éŸ¿ã®ç¯„å›²å†…ã¨è€ƒãˆã¾ã™ã€‚
ã“ã®ã“ã¨ã‹ã‚‰ã€æœ€å°¤æ¨å®šã«åŸºã¥ãæ–¹æ³•ã¨ãƒ™ã‚¤ã‚ºçµ±è¨ˆã‹ã‚‰ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®æ•´åˆæ€§ãŒç¢ºèªã§ãã¾ã—ãŸã€‚</p>
<p>multinom()ã®éš›ã«ã¯æœ‰æ„å·®æ¤œå®šã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã—ãŸã®ã§ã€ä»Šå›ã‚‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒ0ã‚ˆã‚Šå¤§ãã„(å°ã•ã„)ç¢ºç‡(<strong>Bayesian p-value</strong>)ã‚’ç®—å‡ºã—ã¦ãŠãã¾ã™ã€‚</p>
<pre><code>posterior_fit0_2 &lt;- rstan::extract(fit0)

p_coef &lt;- apply(posterior_fit0_2$b,c(2,3), function(x){
  sum(x &gt; 0)/length(x)
})
rownames(p_coef) &lt;- c(&quot;Intercept&quot;,&quot;sesmiddle&quot;,&quot;seshigh&quot;,&quot;write&quot;)
colnames(p_coef) &lt;- c(&quot;general&quot;,&quot;vocation&quot;)
t(p_coef)

##            
##           Intercept sesmiddle seshigh  write
##  general    0.99325   0.11125   0.009 0.0015
##  vocation   1.00000   0.74550   0.041 0.0000
</code></pre>
<p>ä»¥ä¸Šã®çµæœã®è§£é‡ˆã¯multinom()ã®æ™‚ã‚ˆã‚Šç›´æ„Ÿçš„ã§ã€ä¾‹ãˆã°$b_{14}$ã«ç€ç›®ã™ã‚‹ã¨ã€</p>
<ul>
<li>$b_{14}$ã¯95%ã®ç¢ºç‡ã§-0.10ã‹ã‚‰-0.02ã®å€¤ã‚’ã¨ã‚‹ã€‚ã¾ãŸä¸­å¤®å€¤ã¯-0.06ã§ã‚ã‚‹ã€‚</li>
<li>$b_{14}$ãŒ0ã‚ˆã‚Šã‚‚å¤§ãã„ç¢ºç‡ã¯0.15%ã§ã‚ã‚‹</li>
</ul>
<p>ã¨ã„ã†ã‚ˆã†ã«è§£é‡ˆã§ãã¾ã™ã€‚</p>
<p><strong>multinom()ã®æ™‚ã¨æ¯”ã¹ã¦ãšã£ã¨åˆ†ã‹ã‚Šã‚„ã™ããªã„ã§ã™ã‹ï¼Ÿï¼Ÿï¼ğŸ¢</strong></p>
<p>å…¨çµæœã‚’æ•°å¼ã§è¡¨ç¾ã—ã¦ãŠãã¾ã™(Bayesian p-valueã«åŸºã¥ã„ã¦$^{***}$ï¼š0.1%æœ‰æ„ã€$^{**}$ï¼š1%æœ‰æ„ã€$^{*}$ï¼š5%æœ‰æ„)ã€‚</p>
<p>$$
\cfrac{P(prog=general)}{P(prog=academic)} = exp(2.90^{***}-0.53(ses=middle) -1.19^{**}(ses=high) - 0.06^{**}write)
$$</p>
<p>$$
\cfrac{P(prog=vocation)}{P(prog=academic)} = exp(5.32^{***}-0.31(ses=middle); -1.00^{*}(ses=high) - 0.12^{***}write)
$$</p>
<h1 id="çµæœã®ç¢ºèªã‚ªãƒƒã‚ºæ¯”ã®å¤‰é‡ã«ç€ç›®">çµæœã®ç¢ºèª(ã‚ªãƒƒã‚ºæ¯”ã®å¤‰é‡ã«ç€ç›®)</h1>
<p>ã‚ªãƒƒã‚ºæ¯”ã®å¤‰é‡(ä¾‹ãˆã°ã€$\cfrac{P(prog=general)}{P(prog=academic)}$)ã«ã¤ã„ã¦ã‚‚ç¢ºèªã—ã¦ãŠãã¾ã™ã€‚ã“ã¡ã‚‰ã¯äº‹å¾Œåˆ†å¸ƒã®è¦ç´„çµ±è¨ˆé‡ã§ã¯ãªãã€äº‹å¾Œåˆ†å¸ƒè‡ªä½“ã‚’è¦–è¦šçš„ã«è¦‹ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚ã¾ãŸé€šå¸¸åˆ‡ç‰‡é …ã¯è§£é‡ˆã«ç”¨ã„ãªã„ãŸã‚ã€å›³ã®æç”»ã§ã¯å‰²æ„›ã—ã¾ã™ã€‚</p>
<pre><code>plot_title &lt;- ggtitle(&quot;Posterior distribution&quot;, &quot;with medians and 95% intervals&quot;)

mcmc_areas(as.matrix(fit0),
           pars = c(&quot;ratio[2,1]&quot;,&quot;ratio[3,1]&quot;,&quot;ratio[4,1]&quot;,&quot;ratio[2,2]&quot;,&quot;ratio[3,2]&quot;,&quot;ratio[4,2]&quot;),prob=0.95, area_method = &quot;equal height&quot;) +
           plot_title+ theme_bw(base_size=12)
</code></pre>
<p><img src="/my-page/post/multinom-rstan/fit0_mcmc_density.png" alt=""></p>
<p>ä¸Šå›³ã®äº‹å¾Œåˆ†å¸ƒã«è¡¨ç¾ã•ã‚ŒãŸä¸­å¤®å€¤ã€95%ä¿¡é ¼åŒºé–“ã‚’ä¸‹ã§ç®—å‡ºã—ã¦ãŠãã¾ã™ã€‚</p>
<pre><code>ratio_median &lt;- apply(posterior_fit0_2$ratio, c(2,3), median)
ratio_quant &lt;- apply(posterior_fit0_2$ratio, c(2,3), quantile, prob=c(0.025, 0.975))
ratio_general &lt;- rbind(ratio_median[,1], ratio_quant[,,1])
ratio_vocation &lt;- rbind(ratio_median[,2],ratio_quant[,,2])
rownames(ratio_general) &lt;- rownames(ratio_vocation) &lt;- c(&quot;median&quot;,&quot;2.5%&quot;,&quot;97.5%&quot;)
colnames(ratio_general) &lt;- colnames(ratio_vocation) &lt;-  c(&quot;Intercept&quot;,&quot;sesmiddle&quot;,&quot;seshigh&quot;,&quot;write&quot;)
ratio_odds &lt;- list(general = ratio_general, vocation=ratio_vocation)

show(ratio_odds)

## $general
##        Intercept sesmiddle   seshigh     write
## median  18.08714 0.5897972 0.3041684 0.9428201
## 2.5%     1.85266 0.2434086 0.1037669 0.9051025
## 97.5%  166.69899 1.3964119 0.8242418 0.9836004
## 
## $vocation
##         Intercept sesmiddle   seshigh     write
## median  204.48713  1.369324 0.3678701 0.8901682
## 2.5%     23.69682  0.527517 0.1092642 0.8515944
## 97.5%  1940.58136  3.594567 1.1219872 0.9260589
</code></pre>
<p>ä¸Šå›³ã§ä¸€ç•ªç›®ç«‹ã¤$ratio[2,2]$ã«ç€ç›®ã™ã‚‹ã¨ã€ã“ã‚Œã¯$exp(b_{22})$ã§ã™ã®ã§ã€
$$
\cfrac{\cfrac{P(prog=vocation(ses=middle))}{P(prog=academic(ses=middle))}}{\cfrac{P(prog=vocation(ses=low))}{P(prog=academic(ses=low))}} 
$$
ã®äº‹å¾Œåˆ†å¸ƒã‚’è¡¨ç¾ã—ã¦ã„ã¾ã™ã€‚
äº‹å¾Œåˆ†å¸ƒã¯95%ãƒ™ã‚¤ã‚ºä¿¡é ¼åŒºé–“å†…ã«1ã‚’å«ã‚“ã§ã„ã¾ã™ã—ã€æ¯”è¼ƒçš„å¹…ãŒåºƒã„åˆ†å¸ƒã§ã™ã®ã§ã€ç¢ºä¿¡ã‚’ã‚‚ã£ã¦ã“ã†ã ã¨ã„ãˆã‚‹çµæœãŒå¾—ã‚‰ã‚Œã¦ã„ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚</p>
<p>ä¸€æ–¹ã§ã€$ratio[3,1]=exp(b_{21})$ã¯å¹…ãŒæ¯”è¼ƒçš„ç‹­ãã€95%ãƒ™ã‚¤ã‚ºä¿¡é ¼åŒºé–“å†…ã«1ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã“ã®ã“ã¨ã‹ã‚‰ã€
$$
\cfrac{\cfrac{P(prog=general(ses=high))}{P(prog=academic(ses=high))}}{\cfrac{P(prog=general(ses=low))}{P(prog=academic(ses=low))}} 
$$
ã¯ã‚ˆã‚Šç¢ºä¿¡ã‚’ã‚‚ã£ã¦1ä»¥ä¸‹ã®ä»£è¡¨å€¤(MAPæ¨å®šå€¤ã‚„ä¸­å¤®å€¤)ä»˜è¿‘ã‚’ã¨ã‚‹ã€ã¨ã„ã†ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
<p>ã“ã®ã‚ˆã†ã«ã€ãƒ™ã‚¤ã‚ºçµ±è¨ˆã§ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚„æ±‚ã‚ãŸã„å€¤ã®ã¨ã‚Šã†ã‚‹åˆ†å¸ƒã‚’æ¨å®šã™ã‚‹ã“ã¨ãŒã§ãã€å¤§å¤‰ä¾¿åˆ©ã§ã™ã€‚</p>
<h1 id="çµæœã®æç”»">çµæœã®æç”»</h1>
<p>æœ€å¾Œã«çµæœ(ç¢ºç‡ã«é–¢ã™ã‚‹äºˆæ¸¬å€¤ã®åˆ†å¸ƒ)ã®æç”»ã‚’è¡Œã„ã¾ã™ã€‚ä»¥ä¸‹ã§ã¯å„programãŒé¸ã°ã‚Œã‚‹ç¢ºç‡ã‚’ã€äº‹å¾Œåˆ†å¸ƒã®ä¸­å¤®å€¤ã‚’äºˆæ¸¬å€¤ã¨ã—ã¦ã€50%ãƒ™ã‚¤ã‚ºä¿¡é ¼åŒºé–“ã¨ã¨ã‚‚ã«ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>
<pre><code>library(ggplot2)
library(RColorBrewer)

p25 &lt;- apply(posterior_fit0_2$pred, c(2,3), quantile, prob=c(0.25))
p50 &lt;- apply(posterior_fit0_2$pred, c(2,3), median)
p75 &lt;- apply(posterior_fit0_2$pred, c(2,3), quantile, prob=c(0.75))
colnames(p25) &lt;- paste0(c(&quot;academic&quot;,&quot;general&quot;,&quot;vocation&quot;),&quot;_p25&quot;)
colnames(p50) &lt;- paste0(c(&quot;academic&quot;,&quot;general&quot;,&quot;vocation&quot;),&quot;_p50&quot;)
colnames(p75) &lt;- paste0(c(&quot;academic&quot;,&quot;general&quot;,&quot;vocation&quot;),&quot;_p75&quot;)
data1 &lt;- data.frame(ses = rep(c(&quot;low&quot;,&quot;middle&quot;,&quot;high&quot;),each = 41), write = x_new[,-c(1:3)],y=p50[,&quot;academic_p50&quot;], ymax=p75[,&quot;academic_p75&quot;],
                    ymin=p25[,&quot;academic_p25&quot;], facet=&quot;academic&quot;)
data2 &lt;- data.frame(ses = rep(c(&quot;low&quot;,&quot;middle&quot;,&quot;high&quot;),each = 41), write = x_new[,-c(1:3)],y=p50[,&quot;general_p50&quot;], ymax=p75[,&quot;general_p75&quot;],
                    ymin=p25[,&quot;general_p25&quot;], facet=&quot;general&quot;)
data3 &lt;- data.frame(ses = rep(c(&quot;low&quot;,&quot;middle&quot;,&quot;high&quot;),each = 41), write = x_new[,-c(1:3)],y=p50[,&quot;vocation_p50&quot;], ymax=p75[,&quot;vocation_p75&quot;],
                    ymin=p25[,&quot;vocation_p25&quot;], facet=&quot;vocation&quot;)


cols = RColorBrewer::brewer.pal(3,&quot;Dark2&quot;)

data_point &lt;- ml %&gt;% cbind(makedummies::makedummies(ml,basal_level = T, col = &quot;prog&quot;)) %&gt;% 
  select(c(ses, write, prog, prog_academic, prog_general, prog_vocation))

p0 &lt;- ggplot() + theme_bw(base_size=11) + mapply(
  function(data){
    geom_ribbon(data=data, aes(x=write, ymax=ymax, ymin=ymin, fill=ses), alpha=0.5) 
  },list(data1,data2,data3)
) +mapply(
  function(data){
    geom_line(data=data,aes(x=write, y=y, colour=ses)) 
  },list(data1,data2,data3)
) + mapply(
  function(data,n){
  geom_jitter(data=data,aes(x=write, y=data[,n], colour=ses),height=0.1, width=0, size=0.8)
},list(data.frame(data_point, facet=&quot;academic&quot;),data.frame(data_point, facet=&quot;general&quot;),data.frame(data_point, facet=&quot;vocation&quot;)),
  list(4,5,6)) +
  facet_grid(facet~.) + scale_colour_manual(values=cols) + scale_fill_manual(values=cols) +
  theme(legend.position = &quot;bottom&quot;) + ylab(&quot;Probability&quot;) + labs(title = &quot;With Rstan&quot;)

p0
</code></pre>
<p><img src="/my-page/post/multinom-rstan/fit0_mcmc_res.png" alt=""></p>
<p>multinom()ã«ã‚ˆã‚‹åˆ†æã®éš›ã«æç”»ã—ãŸå›³ã‚’ä¸‹ã«è¼‰ã›ã¾ã™ãŒã€ã“ã®2ã¤ã®çµæœã¯ã»ã¼ä¸€è‡´ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚</p>
<p><img src="/my-page/post/multinom-rstan/multinom.png" alt=""></p>
<h1 id="ã¾ã¨ã‚">ã¾ã¨ã‚</h1>
<p>æœ¬è¨˜äº‹ã§ã¯å¤šé …ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ã‚’Rstanã‚’ç”¨ã„ã¦å®Ÿè¡Œã—ã€æœ€å°¤æ³•(multinom())ã«ã‚ˆã‚‹çµæœã¨ã®æ¯”è¼ƒã‚’è¡Œã„ã€ãƒã‚¤ãƒãƒ³ãƒ»ãƒ”ã‚¢ã‚½ãƒ³å‹çµ±è¨ˆã¨ãƒ™ã‚¤ã‚ºä¿¡é ¼åŒºé–“çµ±è¨ˆã®é•ã„ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚</p>
<p>ä¸¡è€…ãŒã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯å®Ÿè³ªçš„ã«ã¯å¤‰ã‚ã‚Šã‚ã‚Šã¾ã›ã‚“ãŒã€è§£é‡ˆã®é•ã„ãªã©ã«ã¤ã„ã¦ã¯å®Ÿæ„Ÿã§ããŸã‹ã¨æ€ã„ã¾ã™ã€‚</p>
<p>æ¬¡å›ã®è¨˜äº‹ã§ã¯ã€ä»Šå›ã®å®Ÿè£…ã«ã•ã‚‰ã«æ”¹è‰¯ã‚’åŠ ãˆã€äºˆæ¸¬ç”¨ã®ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚</p>

        </article>
    </div>
    <div class="main-content__tags u-font">
        
        
        <span><a href="https://rmorita-stat.github.io/my-page/tags/%E5%9B%9E%E5%B8%B0">å›å¸°</a></span>
        
        <span><a href="https://rmorita-stat.github.io/my-page/tags/rstan">rstan</a></span>
        
        
    </div>
</div>
<div class="main-profile">
    <div class="main-profile__avatar">
        
    </div>
    <div class="main-profile__body">
        <div class="main-profile__author">
            
            <span> R.morita </span>
            
        </div>
        <div class="main-profile__description">
            
            <p> æ´›ä¸­ã§6å¹´é–“å¤§å­¦ç”Ÿæ´»ã‚’éã”ã—ã€ä»Šã¯é›£æ³¢ã®åœ°ã§åƒã„ã¦ã„ã¾ã™ã€‚çµ±è¨ˆã€ãƒ­ãƒ¼ãƒ‰ãƒã‚¤ã‚¯ã€å¤å¢³ãŒå¥½ãã§ã™ã€‚ </p>
            
        </div>
    </div>
</div>
<div class="main-line"></div>
<div class="main-pn">
    
    <a class="previous" href="https://rmorita-stat.github.io/my-page/post/bayesintroduction/bayesintroduction/">
        <div class="pn-dec"></div>
        <div class="pn-els">
            <div class="pn-el__1"> 2020.05.29 23:50 </div>
            <div class="pn-el__2"> ãƒ™ã‚¤ã‚ºçµ±è¨ˆãƒ¢ãƒ‡ãƒªãƒ³ã‚°å…¥é–€ </div>
        </div>
    </a>
    
    
</div>

<footer>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
    });
</script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  "HTML-CSS": {
    availableFonts: ["TeX"]
  }
  });
</script>
</footer>

</div>
<div class="footer">
    <div class="copyright-wrap">
        <p class="copyright u-font">
            
            &#169;
            2020
            
            <a href="https://github.com/Rmorita-stat/doc" target="_blank">R.morita&#46;</a>
            Theme <a href="https://github.com/iCyris/hugo-theme-yuki" target="_blank">yuki</a>&#46;
            Powered by Hugo&#46;
            
            
        </p>
    </div>
</div>
</body>
<script src="https://rmorita-stat.github.io/my-page/js/page.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

